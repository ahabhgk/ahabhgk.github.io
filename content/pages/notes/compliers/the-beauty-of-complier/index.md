---
title: ç¼–è¯‘åŸç†ä¹‹ç¾
slug: /note/compliers/the-beauty-of-complier
date: 2020-12-11
description: the-beauty-of-complier
tags:
  - Note
---

## å®ç°è„šæœ¬è¯­è¨€

- è¯æ³•åˆ†æï¼šæŠŠç¨‹åºåˆ†å‰²æˆä¸€ä¸ªä¸ª Token çš„è¿‡ç¨‹ï¼Œå¯ä»¥é€šè¿‡æ„é€ æœ‰é™è‡ªåŠ¨æœºæ¥å®ç°
- è¯­æ³•åˆ†æï¼šæŠŠç¨‹åºçš„ç»“æ„è¯†åˆ«å‡ºæ¥ï¼Œå¹¶å½¢æˆä¸€æ£µä¾¿äºç”±è®¡ç®—æœºå¤„ç†çš„æŠ½è±¡è¯­æ³•æ ‘ã€‚å¯ä»¥ç”¨é€’å½’ä¸‹é™çš„ç®—æ³•æ¥å®ç°
- è¯­ä¹‰åˆ†æï¼šæ¶ˆé™¤è¯­ä¹‰æ¨¡ç³Šï¼Œç”Ÿæˆä¸€äº›å±æ€§ä¿¡æ¯ï¼Œè®©è®¡ç®—æœºèƒ½å¤Ÿä¾æ®è¿™äº›ä¿¡æ¯ç”Ÿæˆç›®æ ‡ä»£ç 

### è¯æ³•åˆ†æå™¨

å®ç°ä¸€ä¸ªè¯æ³•åˆ†æå™¨ï¼Œé¦–å…ˆéœ€è¦å†™å‡ºæ¯ä¸ªè¯æ³•çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¹¶ç”»å‡ºæœ‰é™è‡ªåŠ¨æœºï¼Œä¹‹åï¼Œåªè¦ç”¨ä»£ç è¡¨ç¤ºè¿™ç§çŠ¶æ€è¿ç§»è¿‡ç¨‹å°±å¯ä»¥äº†

æœ‰é™çŠ¶æ€è‡ªåŠ¨æœº $M = (Î£, S, q_0, F, Î´)$ï¼Œåˆ†åˆ«æ˜¯å­—ç¬¦é›†ã€çŠ¶æ€é›†ã€åˆå§‹çŠ¶æ€ã€ç»ˆç»“çŠ¶æ€ï¼ˆé›†ï¼‰ã€è½¬ç§»å‡½æ•°

- ç¡®å®šçŠ¶æ€æœ‰é™è‡ªåŠ¨æœº DFAï¼šå¯¹ä»»æ„å­—ç¬¦ï¼Œæœ€å¤šæœ‰ä¸€ä¸ªçŠ¶æ€å¯ä»¥è½¬ç§»ï¼Œ$F$ æ˜¯ç»ˆç»“çŠ¶æ€
- éç¡®å®šçŠ¶æ€æœ‰é™è‡ªåŠ¨æœº NFAï¼šå¯¹ä»»æ„å­—ç¬¦ï¼Œæœ‰å¤šäºä¸€ä¸ªçŠ¶æ€å¯ä»¥è½¬ç§»ï¼Œ$F$ æ˜¯ç»ˆç»“çŠ¶æ€é›†

```text
   Thompson ç®—æ³•      å­é›†æ„é€ ç®—æ³•      Hopcraft æœ€å°åŒ–ç®—æ³•
RE ------------> NFA ----------> DFA -----------------> æœ€å°åŒ– DFA ------> è¯æ³•åˆ†æå™¨ä»£ç 
```

#### RE -> NFA

- `e -> ğ›†`
![e -> ğ›†](./images/e2null.png)
- `e -> c`
![e -> c](./images/e2c.png)
- `e -> e1 e2`
![e -> e1 e2](./images/e2e1e2.png)
- `e -> e1 | e2`
![e -> e1 | e2](./images/e2e1ore2.jpg)
- `e -> e1*`
![e -> e1*](./images/e2e1*.jpg)

ç”±ä¸Šé¢æ„é€  `a(b|c)*` å¾—

![a(b|c)*](./images/aborc*.jpg)

#### NFA -> DFA

```fakecode
// eps_closure å¯ç”¨ BFS æˆ– DFS å®ç°
q0 <- eps_closure(n0)   // q0 = {n0}
Q <- {q0}       // Q = {q0}
workList <- q0     // workList = [q0, ...]
while(workList != [])   
  remove q from workList   // workList = [...]
  foreach(character c)     // c = a
    t <- e-closure(delta(q,c))   // delta(q0, a) = {n1}, t = {n1, n2, n3, n4, n6, n9}
    D[q,c] <- t    //   q1 = t
    if(t not in Q)    // Q = {q0, q1} , workList = [q1]
      add t to Q and workList
```

`a(b|c)*` è¿›è¡Œè½¬æ¢å¯å¾—

`q1 = {n1, n2, n3, n4, n6, n9}`
`q2 = {n5, n8, n9, n3, n4, n6}`
`q3 = {n7, n8, n9, n3, n4, n6}`

å›¾åƒï¼š![dfa-aborc*](./images/dfa-aborc*.jpg)

Hopcraft æœ€å°åŒ–ç®—æ³•å°† DFA è½¬åŒ–ä¸ºæœ€å°åŒ– DFA

```fakecode
//åŸºäºç­‰ä»·ç±»çš„æ€æƒ³
split(S)
  foreach(character c)
    if(c can split s)
      split s into T1, ..., Tk

hopcroft()
  split all nodes into N, A
  while(set is still changes)
    split(s)
```

![fiee](./images/fiee.png)

å…ˆåˆ†ä¸ºéç»ˆç»“çŠ¶æ€ `N: {q0, q1, q2, q4}` å’Œç»ˆç»“çŠ¶æ€ `A: {q3, q5}`ï¼Œåœ¨ N ä¸­ q0 å’Œ q1 åœ¨æ¥å— e çš„æ¡ä»¶ä¸‹æœ€ç»ˆå¾—åˆ°çš„çŠ¶æ€è¿˜æ˜¯åœ¨ N çš„å†…éƒ¨ã€‚æ‰€ä»¥å¯ä»¥å°†å…¶æ ¹æ® e æ‹†åˆ†æˆ `{q0, q1}`ï¼Œ`{q2, q4}`ï¼Œ`{q3, q5}`ã€‚q0 å’Œ q1 ï¼Œåœ¨æ¥å— e çš„æ—¶å€™ï¼Œq0 æœ€ç»ˆå¾—åˆ°è¿˜æ˜¯åœ¨ `{q0, q1}` è¿™ä¸ªçŠ¶æ€çš„ç»“åˆä¸­ï¼Œq1 å´ä¼šè½åœ¨ `{q2, q4}` çš„çŠ¶æ€ä¸­ï¼Œæ‰€ä»¥å¯ä»¥å°† q0 å’Œ q1 åˆ†ä¸º `{q0}`ï¼Œ`{q1}`

![dfa-fiee](./images/dfa-fiee.png)

### è¯­æ³•åˆ†æå™¨

#### ä¸Šä¸‹æ–‡æ— å…³æ–‡æ³•

ä¸Šä¸‹æ–‡æ— å…³æ–‡æ³• G æ˜¯ä¸€ä¸ªå››å…ƒç»„ï¼š$G = (T, N, P, S)$

- T æ˜¯ç»ˆç»“ç¬¦é›†åˆ
- N æ˜¯éç»ˆç»“ç¬¦é›†åˆ
- P æ˜¯ä¸€ç»„äº§ç”Ÿå¼è§„åˆ™é›†åˆ
- S æ˜¯å”¯ä¸€çš„å¼€å§‹ç¬¦å·ï¼ˆéç»ˆç»“ç¬¦ï¼ŒS âˆˆ Nï¼‰

```text
E -> num
   | id
   | E + E
   | E * E

T = {num, id, +, *}
N = {E}
P = {E -> num, E -> id, E -> E + E, E -> E * E}
S = E
```

#### æ¨å¯¼

- æœ€å·¦æ¨å¯¼ï¼šæ¯æ¬¡æ€»æ˜¯é€‰æ‹©æœ€å·¦ä¾§çš„ç¬¦å·è¿›è¡Œæ›¿æ¢
- æœ€å³æ¨å¯¼ï¼šæ¯æ¬¡æ€»æ˜¯é€‰æ‹©æœ€å³ä¾§çš„ç¬¦å·è¿›è¡Œæ›¿æ¢

> è¯­æ³•åˆ†æå™¨çš„ä»»åŠ¡ï¼šè¯­æ³•åˆ†æå™¨ä»è®°å·æµä¸­è·å–å¥å­ Sï¼Œå†æ¥å—ä½¿ç”¨ä¸Šä¸‹æ–‡æ— å…³æ–‡æ³• G æè¿°çš„è¯­è¨€çš„è¯­è¨€è§„åˆ™ï¼Œå›ç­”åœ¨ G ä¸­æ˜¯å¦å­˜åœ¨å¯¹ S çš„æ¨å¯¼ã€‚æ˜¯æˆ–è€…å¦ã€‚å¹¶ç»™ç¨‹åºå‘˜åé¦ˆç²¾ç¡®çš„å‡ºé”™ä¿¡æ¯

#### åˆ†ææ ‘

- æ¨å¯¼å¯ä»¥è¡¨è¾¾æˆæ ‘çŠ¶ç»“æ„
  - å’Œæ¨å¯¼æ‰€ç”¨çš„é¡ºåºæ— å…³ï¼ˆæœ€å·¦ã€æœ€å³ã€å…¶å®ƒï¼‰
- ç‰¹ç‚¹ï¼š
  - æ ‘ä¸­çš„æ¯ä¸ªå†…éƒ¨èŠ‚ç‚¹ä»£è¡¨éç»ˆç»“ç¬¦
  - æ¯ä¸ªå¶å­èŠ‚ç‚¹ä»£è¡¨ç»ˆç»“ç¬¦
  - æ¯ä¸€æ­¥æ¨å¯¼ä»£è¡¨å¦‚ä½•ä»åŒäº²èŠ‚ç‚¹ç”Ÿæˆå®ƒçš„ç›´æ¥å­©å­èŠ‚ç‚¹

```text
E -> num
   | id
   | E + E
   | E * E

æ¨å¯¼ 3 + 4 * 5

E -> E + E                  E
  -> 3 + E           E      +      E
  -> 3 + E * E       3          E  *  E
  -> 3 + 4 * e                  4     5
  -> 3 + 4 * 5

E -> E * E                     E
  -> E + E * E          E      *      E
  -> 3 + E * E       E  +  E          5
  -> 3 + 4 * E       3     4
  -> 3 + 4 * 5

å¾—åˆ°ä¸¤ç§æ ‘çš„ç»“æ„ï¼Œåˆ†ææ ‘çš„å«ä¹‰å–å†³äºæ ‘çš„**ååºéå†**çš„é¡ºåºï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªæ˜¯å…ˆä¹˜ååŠ ï¼Œç¬¬äºŒä¸ªæ˜¯å…ˆåŠ åä¹˜ï¼Œå¯¼è‡´äºŒä¹‰æ€§
```

#### äºŒä¹‰æ€§æ–‡æ³•

é‡å†™è§£å†³

```text
E -> E + T
   | T
T -> T * F
   | F
F -> num
   | id

æ¨å¯¼ 3 + 4 * 5 å¦‚ä¸‹

E -> E + T                    E
  -> T + T             E      +      T
  -> F + T             T          T  *  F
  -> 3 + T             F          F     5
  -> 3 + T * F         3          4
  -> 3 + F * F
  -> 3 + 4 * F
  -> 3 + 4 * 5

æ¨å¯¼ 3 + 4 + 5 å¦‚ä¸‹

E -> E + T                       E
  -> E + T + T            E      +      T
  -> T + T + T         E  +  T          F
  -> F + T + T         T     F          5
  -> 3 + T + T         F     4
  -> 3 + F + T         3
  -> 3 + 4 + T
  -> 3 + 4 + F
  -> 3 + 4 + 5

ä½¿ç”¨äº†å·¦é€’å½’çš„æ–¹å¼ï¼ˆE -> E + Tï¼ŒT -> T * F ï¼‰ï¼Œä»è€Œä½¿å¾—è¯¥å¥å­çš„è®¡ç®—é¡ºåºæ˜¯ (3+4)+5ï¼Œä¿è¯äº†åŠ æ³•çš„å·¦ç»“åˆæ€§
```

#### ç®—æ³•

- å›æº¯ç®—æ³•ï¼ˆè‡ªé¡¶å‘ä¸‹ï¼‰
- é€’å½’ä¸‹é™åˆ†æç®—æ³•ï¼šO(n)ï¼Œå®¹æ˜“å®ç°ï¼ˆæ–¹ä¾¿æ‰‹å·¥ç¼–ç ï¼‰ï¼Œé”™è¯¯å®šä½å’Œè¯Šæ–­ä¿¡æ¯å‡†ç¡®ï¼ŒGCC4ã€LLVM ä½¿ç”¨

```text
S -> N V N
N -> s
   | t
   | g
   | w
V -> e
   | d

parse_S()
  parse_N()
  parse_V()
  parse_N()

parse_N()
  token = tokens[i++]
  if(token == s || token == t || token == g || token == w)
    return;
  error("...")

parse_V()
  token = tokens[i++]
  ... //
```

ä¸€èˆ¬æ¡†æ¶ï¼š

```text
X -> Î²11 ... Î²1i
   | Î²21 ... Î²2j
   | Î²31 ... Î²3k
   | ...

parse_X()
  token = nextToken()
  switch(token)
    case ...:  // Î²11 ... Î²1i
    case ...:  // Î²21 ... Î²2j
    case ...:  // Î²31 ... Î²3k
    ...
    default: error("...");
```

#### LL(1) åˆ†æç®—æ³•

ä»å·¦ï¼ˆLï¼‰å‘å³è¯»å…¥ç¨‹åºï¼Œæœ€å·¦ï¼ˆLï¼‰æ¨å¯¼ï¼Œé‡‡ç”¨ä¸€ä¸ªï¼ˆ1ï¼‰å‰çœ‹ç¬¦å·

ä¸å›æº¯ç®—æ³•ä¸åŒçš„åœ¨äºï¼Œåˆä¸€ä¸ªåˆ†æè¡¨è¿›è¡Œä¼˜åŒ–ï¼Œæ—¶é—´å¤æ‚åº¦ O(n)

å¦‚ä½•æ„é€ åˆ†æè¡¨å°±æ˜¯å…³é”®ï¼Œåˆ†åˆ«æ±‚å‡º NULLABLE é›†åˆã€FIRST é›†åˆã€FOLLOW é›†åˆï¼Œç„¶åæ¨å‡º SELECT é›†åˆï¼Œå³é¢„æµ‹åˆ†æè¡¨

- NULLABLE é›†åˆ

  ```fakecode
  NULLABLE = {}
  while (NULLABLE is still changing)
    for (production p: X -> Î²)
      if (Î² == ğ›†)
        NULLABLE â‹ƒ= {X}
      if (Î² == Y1Y2...Yn)
        if (Y1 âˆˆ NULLABLE && ... && Yn âˆˆ NULLABLE)
          NULLABLE â‹ƒ= {X}
  ```

- FIRST é›†åˆ

  ```fakecode
  for (noterminal N)
    FIRST(N) = {}

  while (some set is still changing)
    for (production p: N -> Î²1Î²2...Î²n)
      for (Î²i from Î²1 upto Î²n)
        if (Î²i == a)
          FIRST(N) â‹ƒ= {a}
          break
        if (Î²i == M)
          FIRST(N) â‹ƒ= FIRST(M)
          if (M is not in NULLABLE)
            break
  ```

- FOLLOW é›†åˆ

  ```fakecode
  for (noterminal N)
    FOLLOW(N) = {}

  while (some set is still changing)
    for (production p: N -> Î²1Î²2...Î²n)
      tmp = FOLLOW(N)
      for (Î²i from Î²n downto Î²1)
        if (Î²i == a)
          tmp = {a}
        if (Î²i == M)
          FOLLOW(M) â‹ƒ= tmp
          if (M is not in NULLABLE)
            tmp = FIRST(M)
          else
            tmp â‹ƒ= FIRST(M)
  ```

- SELECT é›†åˆ

  ```fakecode
  for (production p)
    SELECT(p) = {}

  for (production p: N -> Î²1Î²2...Î²n)
    for (Î²i from Î²1 upto Î²n)
      if (Î²i == a)
        SELECT(p) â‹ƒ= {a}
        return
      if (Î²i == M)
        SELECT(p) â‹ƒ= FIRST(M)
          if (M is not in NULLABLE)
            return
    SELECT(p) â‹ƒ= FOLLOW(N)
  ```

ä¾‹å­ï¼š

```text
p0: Z -> d
p1:    | X Y Z
p2: Y -> c
p3:    | ğ›†
p4: X -> Y
p5:    | a

NULLABLE = {Y, X}

N\FIRST  0  1      2
Z        {} {d}    {d, c, a}
Y        {} {c}    {c}
X        {} {c, a} {c, a}

N\FOLLOW 0  1
Z        {} {}
Y        {} {d, c, a}
X        {} {d, c, a}

        p0   p1         p2   p3         p4         p5
SELECT  {d}  {d, c, a}  {c}  {d, c, a}  {d, c, a}  {a}

é¢„æµ‹åˆ†æè¡¨
    a      c      d
Z   p1     p1     p0,p1
Y   p3     p2,p3  p3
X   p4,p5  p4     p4
```

å¾—åˆ°çš„é¢„æµ‹åˆ†æè¡¨æœ‰çš„ä¼šæœ‰å¤šä¸ªï¼Œå¼•èµ·å†²çªï¼Œå¯¼è‡´ç®—æ³•çš„ä¸ç¡®å®šæ€§

```text
p0: E  -> T E'
p1: E' -> + T E'
p2:     | ğ›†
p3: T  -> F T'
p4: T' -> * F T'
p5:     | ğ›†
p6: F  -> ( E )
p7:     | a

NULLABLE = {E', T'}

FIRST(E) = FIRST(T) = FIRST(F) = {(, a}
FIRST(E') = {+, ğ›†}
FIRST(T') = {*, ğ›†}

FOLLOW(E) = FOLLOW(E') = {), #}
FOLLOW(T) = FOLLOW(T') = {+, ), #}
FOLLOW(F) = {*, +, ), #}

é¢„æµ‹åˆ†æè¡¨
   a    +    *    (    )    #
E  p0             p0
E'      p1             p2   p2
T  p3             p3
T'      p5   p4        p5   p5
F  p7             p6
```

#### è§£å†³å†²çª

- æ¶ˆé™¤å·¦é€’å½’

  ```text
  E -> E + T // å·¦é€’å½’æƒ…å†µä¸‹ï¼ŒE èƒ½æ¨å¯¼å‡º E å¼€å¤´çš„ï¼Œå¯¼è‡´å†²çª
     | T

  // T + T + T ... + Tï¼ŒæŠŠ `+ T` çœ‹ä½œä¸€ä½“ï¼Œé‡æ–°æ„å»ºæˆå³é€’å½’çš„å½¢å¼

  E -> T E'
  E' -> + T E'
  ```

- æå–å·¦å…¬å› å­

  ```text
  X -> a Y
     | a Z // éƒ½æ˜¯ a å¼€å¤´ï¼Œå¯¼è‡´å†²çª

  X -> a X'
  X' -> Y
      | Z
  ```
