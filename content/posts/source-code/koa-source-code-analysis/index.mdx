---
title: Koa2 æºç åˆ†æ
slug: /blogs/koa2-source-code
date: 2020-03-12
author: ahabhgk
description: æ·±å…¥ Koa2 æºç ï¼Œæ¢å¯» Koa2 å¼‚æ­¥ä¸­é—´ä»¶æœºåˆ¶
tags:
  - SourceCode
---

Koa ç”± express åŒä¸€ä¸ªå›¢é˜Ÿæ‰“é€ ï¼Œç›®çš„æ˜¯ä»£æ›¿ express æˆä¸ºä¸‹ä¸€ä»£ Node.js åç«¯æ¡†æ¶ï¼ŒKoa ç”±äºååˆ†ç®€æ´ï¼Œå…¶å®æ›´é€‚åˆåšä¸€äº›æ¡†æ¶çš„åŸºç¡€ï¼ˆegg.jsã€think.jsï¼‰ï¼Œå¦‚ä»Šçœ‹æ¥å¹¶ä¸èƒ½ä»£æ›¿ expressï¼Œexpress æœ¬èº«è‡ªå¸¦ä¸€äº›ä¸­é—´ä»¶æ”¯æŒï¼ŒåŸºäº express ç¼–å†™çš„ nest æ›´æ˜¯å¤§è€Œå…¨ï¼Œç»“åˆ TypeScript å†™èµ·æ¥çœŸçš„çˆ½ï¼Œè™½ç„¶ Koa ç”¨çš„äººä¸å¦‚ express å¤šï¼Œä½† Koa ç¡®å®æœ‰å…¶è¿›æ­¥çš„åœ°æ–¹ï¼šæ”¯æŒ `async/await` çš„å¼‚æ­¥ä¸­é—´ä»¶æœºåˆ¶

æœ¬æ–‡ç”±åˆ›å»ºæœåŠ¡å¼€å§‹ï¼Œè®²è¿°äº† `new Koa()` åˆ° `app.listen` Koa æ‰€åšçš„äº‹ï¼Œå†ç”±ä¸€æ¡ http è¯·æ±‚è¯¦ç»†ä»‹ç»äº† Koa å¼‚æ­¥ä¸­é—´ä»¶æœºåˆ¶ï¼Œä¹‹åè®²è¿°å¯¹ ctx çš„ä¿®æ”¹å¦‚ä½•æ”¹åŠ¨åŸç”Ÿ req resï¼Œå¹¶å¸¦å‡ºä¸€äº› http ç›¸å…³çš„çŸ¥è¯†ï¼Œæœ€åè®²äº† Koa å¦‚ä½•è¿›è¡Œé”™è¯¯å¤„ç†

## ğŸ£ åˆ›å»ºæœåŠ¡

### 1.1 new Koa() å®ä¾‹åŒ–

ç»§æ‰¿ EventEmitterï¼Œconstructor åˆå§‹åŒ–å‚æ•°

```js:title=lib/application.js
this.middleware = [];
this.context = Object.create(context);
this.request = Object.create(request);
this.response = Object.create(response);
```

### 1.2 app.use(fn) æ·»åŠ ä¸­é—´ä»¶

> å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå‡½æ•°æ˜¯ generator å‡½æ•°ï¼š[is-generator-function](https://github.com/ljharb/is-generator-function/)

```js:title=lib/application.js
use(fn) {
  // å…¼å®¹ v1 Generatorï¼Œåˆ¤æ–­ fn æ˜¯ä¸æ˜¯ generatorï¼Œæ˜¯åˆ™é€šè¿‡ koa-convert ç”¨ co è¿›è¡Œå¤„ç†
  this.middleware.push(fn)
  return this
}
```

### 1.3 app.listen(8080) ç›‘å¬ç«¯å£

```js:title=lib/application.js
listen(...args) {
  const server = http.createServer(this.callback());
  return server.listen(...args);
}
```

å°±æ˜¯è°ƒç”¨ http åˆ›å»ºæœåŠ¡çš„ listenï¼Œå…³é”®åœ¨äº createServer çš„å‚æ•°

#### 1.3.1 this.callback() è¿”å›ä»€ä¹ˆ

1. ç»„åˆä¸­é—´ä»¶

2. é€šè¿‡ EventEmitter ç›‘å¬ error äº‹ä»¶ï¼Œè§¦å‘ error æ—¶ç”¨ this.onerror å¤„ç†

3. è¿”å› handleRequestï¼Œä½œä¸º createServer çš„å›è°ƒå‡½æ•°ï¼Œå…¶ä¸­åˆ›å»º ctx ç„¶åè°ƒç”¨è‡ªå·±çš„ handleRequest ä¼ å…¥ ctx å’Œç»„åˆå¥½çš„ä¸­é—´ä»¶æ¥å¤„ç†è¯·æ±‚

```js:title=lib/application.js
callback() {
  const fn = compose(this.middleware);

  if (!this.listenerCount('error')) this.on('error', this.onerror);

  const handleRequest = (req, res) => {
    const ctx = this.createContext(req, res);
    return this.handleRequest(ctx, fn);
  };

  return handleRequest;
}
```

##### 1.3.1.1 this.createContext(req, res)

åˆ›å»º ctxï¼ŒæŒ‚è½½ Koa çš„ request å’Œ responseï¼ŒæŒ‚è½½åŸç”Ÿçš„ req å’Œ res

```js:title=lib/application.js
createContext(req, res) {
  const context = Object.create(this.context);
  const request = context.request = Object.create(this.request);
  const response = context.response = Object.create(this.response);
  context.app = request.app = response.app = this;
  context.req = request.req = response.req = req;
  context.res = request.res = response.res = res;
  request.ctx = response.ctx = context;
  request.response = response;
  response.request = request;
  context.originalUrl = request.originalUrl = req.url;
  context.state = {};
  return context;
}
```

##### 1.3.1.2 this.handleRequest(ctx, fn)

è¿™ä¸ªå¯ä»¥è¯´æ˜¯ç¬¬ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¤„ç†é»˜è®¤çš„ onerror å’Œæœ€åç”¨æˆ·å“åº”çš„ respond

æœ€å `fnMiddleware(ctx).then(handleResponse).catch(onerror)` å¯ä»¥çœ‹å‡ºç»„åˆçš„ä¸­é—´ä»¶è¿”å›ä¸€ä¸ª promiseï¼Œä¹‹åè°ƒç”¨ respond(ctx) å‘é€å“åº”ï¼Œè¿™é‡Œ catch æ˜¯é»˜è®¤çš„é”™è¯¯å¤„ç†

```js:title=lib/application.js
handleRequest(ctx, fnMiddleware) {
  const res = ctx.res;
  res.statusCode = 404;
  const onerror = err => ctx.onerror(err);
  const handleResponse = () => respond(ctx);
  onFinished(res, onerror);
  return fnMiddleware(ctx).then(handleResponse).catch(onerror);
}
```

ä¸­é—´ä»¶ä¸­é€šè¿‡ç»™ ctx.body èµ‹å€¼ï¼Œä¼ åˆ° respond ä¸­ï¼Œå¯¹äºä¸å­˜åœ¨çš„çŠ¶æ€ç çš„è¯·æ±‚å“åº” res.end()ï¼Œrespond å¯¹äº HEAD è¯·æ±‚è¿”å› res.end()ï¼Œå¯¹äºå­—ç¬¦ä¸²å’Œ Buffer çš„ body å“åº” res.end(body)ï¼Œå¯¹äºæµçš„ body å“åº” body.pipe(res)ï¼Œæœ€åé€šè¿‡ JSON.stringify(body) å¤„ç†å…¶ä»–çš„å½¢å¼ï¼Œå¦‚æœæ˜¯ JSON åˆ™ res.end(body) è¿”å› stringify å¾— JSONï¼Œå¦‚æœæŠ¥é”™é€šè¿‡åé¢ catch å¤„ç†ï¼ŒåŒæ—¶ fnMiddleware ä¸­å…¶ä»–æŠ¥é”™ä¹Ÿé€šè¿‡ catch å¤„ç†

```js:title=lib/application.js
function respond(ctx) {
  // åˆ¤æ–­æ˜¯å¦åŒæ„ ctx.respond
  // 204 205 304 å¿½ç•¥ body çš„çŠ¶æ€ç 
  // å¤„ç† HEAD è¯·æ±‚
  // å¤„ç† ctx.body == null

  // responses
  if (Buffer.isBuffer(body)) return res.end(body);
  if ('string' == typeof body) return res.end(body);
  if (body instanceof Stream) return body.pipe(res);

  // body: json
  body = JSON.stringify(body);
  if (!res.headersSent) {
    ctx.length = Buffer.byteLength(body);
  }
  res.end(body)
}
```

## ğŸ¥ ä¸€æ¡ http è¯·æ±‚ï¼šKoa æ ¸å¿ƒ - å¼‚æ­¥ä¸­é—´ä»¶æœºåˆ¶

ç›´æ¥å…ˆçœ‹æ€æ ·ç»„åˆä¸­é—´ä»¶

```js:title=koa-compose
function compose (middleware) {
  // æ£€æŸ¥å‚æ•°
  if (!Array.isArray(middleware)) throw new TypeError('Middleware stack must be an array!')
  for (const fn of middleware) {
    if (typeof fn !== 'function') throw new TypeError('Middleware must be composed of functions!')
  }

  return function (context, next) {
    // last called middleware #
    let index = -1
    return dispatch(0)
    function dispatch (i) {
      if (i <= index) return Promise.reject(new Error('next() called multiple times'))
      index = i
      let fn = middleware[i]
      if (i === middleware.length) fn = next
      if (!fn) return Promise.resolve()
      try {
        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));
      } catch (err) {
        return Promise.reject(err)
      }
    }
  }
}
```

è¿”å›ä¸€ä¸ªç»„åˆåçš„ä¸­é—´ä»¶ï¼Œå‚æ•°ä¹Ÿå’Œæ™®é€šçš„ä¸­é—´ä»¶ä¸€æ ·ï¼Œdispatch è¿”å›ä¸€ä¸ª Promise.resolveï¼Œä» dispatch(0) å¼€å§‹å±•å¼€å†™å¾—åˆ°çš„ fnMiddleware å°±æ˜¯è¿™æ ·çš„ï¼š

```js
// fnMiddleware
function fnMiddleware(context, next) {
  return Promise.resolve(middleware[0](context, function next() {
    return Promise.resolve(middleware[1](context, function next() {
      return Promise.resolve(middleware[2](context, function next() {
        return Promise.resolve() // è¿™é‡Œ i === middleware.length åŒæ—¶ fn å°±æ˜¯ fnMiddleware(ctx) ä¸­ä¼ å…¥çš„ undefinedï¼Œæ‰€ä»¥ç›´æ¥ resolve
      }))
    }))
  }))
}
```

é€šè¿‡ fnMiddleware(ctx) ä¼ å…¥ contextï¼Œå„ä¸ª middleware å¯¹ ctx ä¸Šçš„å±æ€§è¿›è¡Œæ›´æ”¹æ·»åŠ ï¼ˆctx.bodyã€ctx.typeâ€¦â€¦ï¼‰ç”±äº ctx å¯¹è±¡ä¼ å…¥ middlware context å‚æ•°çš„å€¼æ˜¯ ctx çš„åœ°å€ï¼Œæ‰€ä»¥ä¹‹åçš„ middleware ä¸­å¯ä»¥å¾—åˆ°ä¹‹å‰ middleware ä¸­ä¿®æ”¹åçš„ ctxï¼Œå†…éƒ¨è°ƒç”¨ `await next()` å°±æ˜¯ resolve ä¸‹ä¸€ä¸ª middlewareï¼Œè¿™æ ·å°±å®ç°äº† Koa çš„æ´‹è‘±æ¨¡å‹æœºåˆ¶

æˆ‘ä»¬å‘ç°è¿™å…¶å®å’Œ JS çš„ FP ä¸­ compose å¾ˆåƒï¼Œæˆ‘ä»¬ç”¨ reduce å®ç°è¯•è¯•ï¼š

```js
// compose
const compose = (fns) =>
  (context, next) => fns.reduceRight(
    (acc, cur) => Promise.resolve(cur(context, () => acc)),
    Promise.resolve('resolve'),
  )

const sleep = (time) => new Promise(resolve => setTimeout(() => resolve(time), time))

const ctx = { body: 0 }

const middlewares = [
  async (ctx, next) => {
    ctx.body = 1
    console.log(ctx.body) // 1
    await next().then(() => {
      ctx.body = 6
      console.log(ctx.body) // 6
    })
  },
  async (ctx, next) => {
    await sleep(1000)
    ctx.body = 2
    console.log(ctx.body) // 2
    await next().then(() => {
      ctx.body = 5
      console.log(ctx.body) // 5
    })
  },
  async (ctx, next) => {
    await sleep(1000)
    ctx.body = 3
    console.log(ctx.body) // 3
    await next().then((r) => {
      console.log(r)
      ctx.body = 4
      console.log(ctx.body) // 4
    })
  },
]

compose(middlewares)(ctx)
```

è¿™æ—¶å‘ç°åªä¼šåœé¡¿ 1 ç§’ï¼Œç„¶åé¡ºåºä¹Ÿä¸å¯¹ï¼Œè€Œæ¢æˆå®˜æ–¹çš„ compose å°±ä¸€åˆ‡æ­£å¸¸ï¼Œåœé¡¿ä¸¤ç§’åŒæ—¶é¡ºåºæ­£ç¡®ï¼Œè¿™æ˜¯å› ä¸º reduce å’Œ reduceRight æ˜¯åŒæ­¥çš„ï¼Œåªåœé¡¿ä¸€ç§’æ˜¯å› ä¸ºä¸¤ä¸ª sleep å¹¶è¡Œäº†ï¼ˆç±»ä¼¼ `Promise.all([asyncFn1, asyncFn2])`ï¼‰ï¼ŒKoa ä¸­é—´ä»¶çš„ç‰¹æ®Šä¸å¯¹å¤„ç†è¯·æ±‚çš„è¿›æ­¥ç‚¹å°±åœ¨äºæ­¤ï¼Œä¸åŒäº express å’Œ redux çš„ä¸­é—´ä»¶æœºåˆ¶ï¼ŒKoa å®ç°çš„æ˜¯**å¼‚æ­¥ä¸­é—´ä»¶**

åŒæ—¶è¿™æ ·ä¹Ÿå¯ä»¥é€šè¿‡ i æ¥æ£€æŸ¥ä¸€ä¸ª middleware ä¸­æ˜¯å¦å¤šæ¬¡è°ƒç”¨ next çš„ä½œç”¨ï¼ŒKoa æ²¡æœ‰ä½¿ç”¨è¿™ç§æ–¹å¼ä¹Ÿæ˜¯ä¸ºäº†ä¿è¯ i å¯ä»¥æ£€æŸ¥å¤šæ¬¡è°ƒç”¨ next

```js:title=koa-compose
function dispatch (i) {
  if (i <= index) return Promise.reject(new Error('next() called multiple times'))
  index = i // è¿™é‡Œä¿®æ”¹ index
  let fn = middleware[0]
  if (i === middleware.length) fn = next
  if (!fn) return Promise.resolve()
  try {
    return Promise.resolve((async (ctx, next) => {
      // å‡è®¾ç°åœ¨æ˜¯ dispatch(0)ï¼Œæ­¤æ—¶ index = 0ï¼Œi = 0
      await dispatch.bind(null, 0 + 1)() // å†…éƒ¨ä¿®æ”¹ index = 1
      await dispatch.bind(null, 0 + 1)() // å†…éƒ¨ i <= indexï¼š1 <= 1 æˆç«‹ reject æ‰
    })(context, dispatch.bind(null, 0 + 1)));
  } catch (err) {
    return Promise.reject(err)
  }
}
```

çœ‹å®Œä¸­é—´ä»¶æœºåˆ¶å†æ¥çœ‹ http è¯·æ±‚ä»æ¥å—åˆ°å“åº”å°±ç®€å•äº†ï¼Œthis.callback è¿”å›çš„å°±æ˜¯ http.createServer çš„å›è°ƒå‡½æ•°ï¼Œæ‰€ä»¥ req res ä»è¿™é‡Œæ¥æ”¶ï¼Œä¹‹å req res è¿›å…¥ createContext æŒ‚è½½åˆ° ctx å¯¹è±¡ä¸Šï¼Œä¹‹åæŠŠç»„åˆå¥½çš„ fnMiddleware å’Œ ctx ä¼ å…¥ this.handleRequestï¼Œè¿™é‡Œå¤„ç†å¥½ onerror å’Œ respond ä¹‹åå¼€å§‹æŠŠ ctx ä¼ å…¥ fnMiddlewareï¼Œé€šè¿‡å¼€å‘è€…ç¼–å†™çš„ä¸­é—´ä»¶å¯¹ req res è¿›è¡ŒçœŸæ­£çš„å¤„ç†ï¼Œæœ€åå¤„ç†å¥½åé€šè¿‡ `.then(() => respond(ctx))` ä½œå‡ºå“åº”

## â›…ï¸ request response ä»£ç†åŸç”Ÿ req res

æˆ‘ä»¬å¯¹ ctx ä¸Šå¤„ç†ä¸€èˆ¬æ˜¯å¯¹ ctx.request å’Œ ctx.response å¤„ç†ï¼Œä½† request response åªæ˜¯å¯¹åŸç”Ÿ req res é€šè¿‡ \_\_defineGetter\_\_ å’Œ \_\_defineSetter\_\_ åšçš„ä»£ç†ï¼Œæœ€ç»ˆçš„ä¿®æ”¹è¿˜æ˜¯å¯¹ req res çš„ä¿®æ”¹ï¼Œæˆ‘ä»¬é€šè¿‡å‡ å¤„çœ‹çœ‹è¿™å±‚ä»£ç†æœ‰ä»€ä¹ˆä½œç”¨

> \_\_defineGetter\_\_ã€\_\_defineSetter\_\_ å¹¶ä¸æ˜¯æ ‡å‡†ï¼Œä¸æ¨èä½¿ç”¨

1. request çš„ get æ–¹æ³•ï¼Œè¿™é‡Œä¸ºäº†é‚£è¯·æ±‚å¤´çš„å­—æ®µï¼Œå¯¹ referer å’Œ referrer åšäº†å…¼å®¹

> Referer çš„æ­£ç¡®æ‹¼å†™æ˜¯ Referrerï¼Œä½†æ˜¯å†™å…¥æ ‡å‡†çš„æ—¶å€™ï¼Œä¸çŸ¥ä¸ºä½•ï¼Œæ²¡äººå‘ç°å°‘äº†ä¸€ä¸ªå­—æ¯ rã€‚æ ‡å‡†å®šæ¡ˆä»¥åï¼Œåªèƒ½å°†é”™å°±é”™ï¼Œæ‰€æœ‰å¤´ä¿¡æ¯çš„è¯¥å­—æ®µéƒ½ä¸€å¾‹é”™è¯¯æ‹¼å†™æˆ Referer

```js:title=lib/request.js
get(field) {
  const req = this.req;
  switch (field = field.toLowerCase()) {
    case 'referer':
    case 'referrer':
      return req.headers.referrer || req. headers.referer || '';
    default:
      return req.headers[field] || '';
  }
},
```

2. get set ä¸­å¤„ç† req resï¼Œæ˜¯å¼€å‘è€…æ›´æ–¹ä¾¿çš„æ‹¿åˆ°ä¸€äº›æ•°æ®

```js:title=lib/request.js
get query() {
  const str = this.querystring;
  const c = this._querycache = this.  _querycache || {};
  return c[str] || (c[str] = qs.parse(str)) ;
},

set query(obj) {
  this.querystring = qs.stringify(obj);
},
```

```js:title=lib/response.js
set etag(val) {
  if (!/^(W\/)?"/.test(val)) val = `"${val} "`;
  this.set('ETag', val);
},

get etag() {
  return this.get('ETag');
},
```

3. response ä¸­ body çš„å¤„ç†ï¼Œå¯¹äºä¸åŒæ ¼å¼ body çš„èµ‹å€¼ï¼Œåœ¨ set ä¸­å¯¹ typeã€length ç­‰è¿åŒä¸€èµ·å¤„ç†ï¼Œæ–¹ä¾¿å¼€å‘è€…

```js:title=lib/response.js
get body() {
  return this._body;
},

set body(val) {
  const original = this._body;
  this._body = val;

  // no content
  if (null == val) {
    if (!statuses.empty[this.status]) this. status = 204;
    this.remove('Content-Type');
    this.remove('Content-Length');
    this.remove('Transfer-Encoding');
    return;
  }

  // set the status
  if (!this._explicijstatus) this.status =  200;

  // set the content-type only if not yet   set
  const setType = !this.has('Content-Type') ;

  // string
  if ('string' == typeof val) {
    if (setType) this.type = /^\s*</.test (val) ? 'html' : 'text';
    this.length = Buffer.byteLength(val);
    return;
  }

  // buffer
  if (Buffer.isBuffer(val)) {
    if (setType) this.type = 'bin';
    this.length = val.length;
    return;
  }

  // stream
  if ('function' == typeof val.pipe) {
    onFinish(this.res, destroy.bind(null,   val));
    ensureErrorHandler(val, err => this.  ctx.onerror(err));

    // overwriting
    if (null != original && original !=   val) this.remove('Content-Length');

    if (setType) this.type = 'bin';
    return;
  }

  // json
  this.remove('Content-Length');
  this.type = 'json';
},
```

4. response ä¸­ redirect çš„å°è£…ï¼Œcontext ä¸­ cookie çš„å°è£…ï¼Œæä¾›ä¸€äº›å°è£…å¥½çš„æ–¹æ³•

```js:title=lib/response.js
redirect(url, alt) {
  // location
  if ('back' == url) url = this.ctx.get ('Referrer') || alt || '/';
  this.set('Location', encodeUrl(url));

  // status
  if (!statuses.redirect[this.status])  this.status = 302;

  // html
  if (this.ctx.accepjs('html')) {
    url = escape(url);
    this.type = 'text/html; charset=utf-8';
    this.body = `Redirecting to <a href="$  {url}">${url}</a>.`;
    return;
  }

  // text
  this.type = 'text/plain; charset=utf-8';
  this.body = `Redirecting to ${url}.`;
},
```

```js:title=lib/context.js
get cookies() {
  if (!this[COOKIES]) {
    this[COOKIES] = new Cookies(this.req,   this.res, {
      keys: this.app.keys,
      secure: this.request.secure
    });
  }
  return this[COOKIES];
},

set cookies(_cookies) {
  this[COOKIES] = _cookies;
}
```

5. æä¾› toJSON æ–¹ä¾¿è°ƒè¯•

```js:title=lib/context.js
toJSON() {
  return {
    request: this.request.toJSON(),
    response: this.response.toJSON(),
    app: this.app.toJSON(),
    originalUrl: this.originalUrl,
    req: '<original node req>',
    res: '<original node res>',
    socket: '<original node socket>'
  };
},
```

å…¶ä»–è¿˜æœ‰åœ¨ ctx ç”¨ [delegate åº“](https://github.com/tj/node-delegates)å¯¹ä¸€äº›å¸¸ç”¨æ•°æ®ç›´æ¥ä»£ç†åˆ° ctx å¯¹è±¡ä¸Šï¼ˆctx.body === ctx.response.bodyï¼‰

### 3.1 å¼•å‡ºçš„ä¸€äº› http åè®®çŸ¥è¯†ç‚¹

// TODO: å¼•å‡ºçš„ä¸€äº› http åè®®çŸ¥è¯†ç‚¹

## ğŸ‘¾ é”™è¯¯å¤„ç†

å®˜æ–¹æœ‰ä¸‰ç§æ–¹å¼ï¼š

1. ä¸­é—´ä»¶ä¸­ `try/catch`

2. æ·»åŠ é”™è¯¯å¤„ç†ä¸­é—´ä»¶ï¼ˆæˆ–ä½¿ç”¨é»˜è®¤çš„ï¼‰

3. å¤„ç† error äº‹ä»¶ï¼ˆé»˜è®¤æ˜¯æ‰“ logï¼‰

ç¬¬ä¸€ç§æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œç¬¬äºŒç§ä¸­é»˜è®¤çš„å°±æ˜¯ `this.handleRequest` ä¸­çš„ onerrorï¼Œç›´æ¥ä½¿ç”¨ `const onerror = err => ctx.onerror(err)` å¤„ç†ï¼Œctx.onerrer ä¼šç”¨ [statuses åº“](https://github.com/jshttp/statuses)å¯¹ error.code ä½œå‡ºå¯¹åº”çš„å“åº”ä¿¡æ¯ï¼ŒåŒæ—¶ ctx.onerror è¿˜ä¼šè§¦å‘ï¼ˆemitï¼‰error äº‹ä»¶ï¼ˆApplication ç»§æ‰¿ EventEmitterï¼‰ï¼Œapp é»˜è®¤çš„ `on('error', this.onerror)` æ˜¯å¯¹é”™è¯¯ä¿¡æ¯æ‰“ log

ä¸€èˆ¬é»˜è®¤çš„å°±å¤Ÿç”¨äº†ï¼Œå¦‚æœæœ‰å…¶ä»–éœ€æ±‚å¯ä»¥ä¿®æ”¹ app.onerror æˆ–æ·»åŠ é”™è¯¯ä¸­é—´ä»¶å¤„ç†

```js
app.use(async (ctx, next) => {
  try {
    await next();
  } catch (err) {
    // will only respond with JSON
    ctx.status = err.statusCode || err.status || 500;
    ctx.body = {
      message: err.message
    };
  }
})
```

è¿™é‡Œç›¸å½“äºåœ¨ç¬¬ä¸€ä¸ªä¸­é—´ä»¶ catch ä¹‹åä¸­é—´ä»¶çš„é”™è¯¯ï¼Œåœ¨ respond ä¹‹å‰å¤„ç†å¥½é”™è¯¯ç„¶åé€šè¿‡ respond å“åº”ï¼Œé”™è¯¯å°±ä¸ä¼šè¢«ä¹‹å `.catch` æŠ“ä½ï¼Œä»¥æ­¤è¦†ç›–é»˜è®¤çš„ onerror

## ğŸŒŠ One more thing --- æµ

http è¯·æ±‚éå¸¸é€‚åˆçœ‹ä½œä¸€ä¸ªæµï¼ŒKoa ä¸­ use çš„ä¸­é—´ä»¶ç›¸å½“äºä¸€ä¸ªç®¡é“ï¼Œå¯¹ ctx æµçš„æ•°æ®è¿›è¡Œå¤„ç†ï¼Œå¤„ç†å®Œå respond

ç»“åˆ RxJS çš„ä¼ªä»£ç ï¼š

```ts
const server = http
  .createServer()
  .listen(8080, () => console.log('Server is running on port 8080...'))

const server$ = fromEvent<[IncomingMessage, ServerResponse]>(server, 'request')
const ctx$ = server$.pipe(map(([req, res]) => ({ req, res })))

ctx$.pipe(
  map(routerMiddleware),
  map(controllerMiddleware),
  map(serverMiddleware),
  map(errorHandlerMiddleware),
).subscribe({
  next: respond,
  error: defaultErrorHandler,
  complete: defaultCompleteHandler,
})
```

å½“ç„¶éå¸¸ä¸å®Œæ•´ï¼Œåªæ˜¯ä¸€ä¸ªæƒ³æ³•çš„ä½“ç°ï¼Œå…¶å®å·²ç»æœ‰äººå®ç°äº†ç”¨ RxJS çš„åç«¯æ¡†æ¶ï¼š[marblejs](https://github.com/marblejs/marble)ï¼Œå½“ç„¶æˆ‘ä»¬è¿˜æ˜¯è¦ç»“åˆå®é™…è¿›è¡Œé€‰æ‹©

## ğŸ¥³ ç»“è¯­

ä½¿ç”¨ TypeScript å®ç°äº†ä¸€ä¸ªç®€æ˜“ç‰ˆçš„ Koaï¼Œåˆ å‡äº†å¾ˆå¤š ctx å¯¹ request response çš„å¤„ç†ï¼Œåªä½“ç°äº†æ ¸å¿ƒæ€è·¯ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹ï¼š[ts-koa-core](https://github.com/ahabhgk/ts-koa-core)

é€šè¿‡çœ‹ Koa æºç åŒæ—¶ç®€å•çœ‹äº†çœ‹ç›¸å…³ä¾èµ–çš„åº“çš„æºç ï¼Œä¹Ÿç®—å¯¹ä»¥å‰ä¸ç†è§£çš„åœ°æ–¹æœ‰äº†æ›´æ¸…æ™°çš„ç†è§£

ä»¥å‰å¯¹ cookieã€etag ä»€ä¹ˆçš„ä¸çŸ¥é“åˆ°åº•æ€ä¹ˆå†™çš„ï¼Œç°åœ¨å‘ç°å…¶å®å°±æ˜¯å¯¹ node çš„ req res çš„ä¿®æ”¹ï¼Œå½“ç„¶ node åº•å±‚ä¹Ÿåšäº†å¾ˆå¤šï¼Œä½†ä¹Ÿç®—åœ¨ä¸€å®šæŠ½è±¡å±‚æ¬¡ä¸Šæ˜ç™½äº†åç«¯å…¶å®æ˜¯å¯¹ req res çš„å¤„ç†ï¼ŒåŒæ—¶ä½œå‡º side effectï¼Œå¤æ‚æ—¶å°±éœ€è¦å¤„ç†å¤æ‚æƒ…å†µ

è¿˜ç”¨ä¸­é—´ä»¶æœºåˆ¶ä¸ºä»€ä¹ˆ compose ä¸ FP å¸¸å†™çš„ compose å¾ˆä¸ä¸€æ ·ï¼Œè¿˜æœ‰ i å¯¹å¤šæ¬¡è°ƒç”¨ next çš„æ£€æŸ¥çœŸçš„éå¸¸å·§å¦™ï¼ŒçœŸçš„éå¸¸ä½©æœ TJ å¤§ç¥
