---
title: Redux æºç åˆ†æ
slug: /blog/redux-source-code
date: 2019-12-07
author: ahabhgk
description: æ·±å…¥ Redux æºç 
tags:
  - SourceCode
---

éšç€å‰ç«¯åº”ç”¨é€æ¸å˜å¤§ï¼ŒçŠ¶æ€ä¹Ÿè¶Šæ¥è¶Šå¤æ‚ï¼Œéœ€è¦ä¸€ç§çŠ¶æ€ç®¡ç†çš„æ–¹æ¡ˆï¼ŒRedux å°±æ˜¯å…¶ä¸­ä¸€ç§

æ€»ç»“èµ·æ¥ React çŠ¶æ€ç®¡ç†æ–¹æ¡ˆå°±åˆ†ä¸ºä¸¤ç±»ï¼š

* å¤–éƒ¨ Modelï¼Œé€šè¿‡äº‹ä»¶ä¿®æ”¹çŠ¶æ€ï¼Œç»„ä»¶é€šè¿‡ç›‘å¬è®¢é˜…çŠ¶æ€ï¼ˆé€šè¿‡ Context è¿æ¥ Reactï¼‰

  * Redux

  * Mobx

  * EventBus

  * hox

* é€šè¿‡ React Context æå‡çŠ¶æ€ï¼ˆåŒ…æ‹¬ä¿®æ”¹çŠ¶æ€çš„æ–¹æ³•ï¼‰ï¼Œåœ¨ç»„ä»¶ä¸­æ‹¿åˆ°å¹¶ä½¿ç”¨ Context

  * unstated

  * unstated-next

  * reunx

ä½¿ç”¨å¤–éƒ¨ Model çš„æ¨¡å¼ç”±äºä¸ä¾èµ–äº Reactï¼Œæ‰€ä»¥ä¸ä»…é€‚ç”¨äº Reactï¼Œåœ¨å„ä¸ªæ¡†æ¶ç”šè‡³åŸç”Ÿåº”ç”¨ä¸­éƒ½å¯ä»¥ä½¿ç”¨ï¼›è€Œç¬¬äºŒç§ä¾èµ–äº React Context ä»…é€‚ç”¨äº React åº”ç”¨ï¼Œä½†æ˜¯ååˆ†è½»é‡

MVCï¼ˆbackbone.js...ï¼‰ç”±äºå½“åº”ç”¨å˜å¾—å¾ˆå¤§æ—¶ï¼Œä¼šæœ‰å¤šä¸ª View å’Œå¤šä¸ª Modelï¼Œï¼ˆåŒå‘çš„ï¼‰æ•°æ®æµå°±ä¼šå˜çš„éå¸¸æ··ä¹±

![MVC-bad](./images/MVC-bad.png)

æ‰€ä»¥å‡ºç°äº† Fluxï¼Œä»¥å•å‘æ•°æ®æµç®¡ç†çŠ¶æ€ï¼ŒReact æ¨å´‡çš„æ ¸å¿ƒä¹Ÿæ˜¯å•å‘æ•°æ®æµï¼ŒFlux ä¸­å•å‘æ•°æ®æµå¯ä»¥çœ‹ä½œæ˜¯åœ¨å…¶æ•´ä½“æ¶æ„ä¸Šçš„å»¶ä¼¸ï¼ŒRedux æ˜¯ä¹Ÿä¸æ˜¯ Fluxï¼Œå®ƒéµå¾ªäº† Flux çš„å•å‘æ•°æ®æµçš„ç†å¿µï¼ŒåŒæ—¶ç®€åŒ–äº† Flux

![different](./images/different.jpeg)

Flux/Redux è¿™ç§ä»¥å•å‘æ•°æ®æµç®¡ç†çŠ¶æ€æ›´åƒæ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼

## ğŸ‘€ Redux å¯¹æ¯” Mobx

Mobx å’Œ Redux çš„ç›®æ ‡éƒ½æ˜¯ç®¡ç†å¥½åº”ç”¨çŠ¶æ€ï¼Œä½†æ˜¯æœ€æ ¹æœ¬çš„åŒºåˆ«åœ¨äºå¯¹æ•°æ®çš„å¤„ç†æ–¹å¼ä¸åŒã€‚

Redux è®¤ä¸ºï¼Œæ•°æ®çš„ä¸€è‡´æ€§å¾ˆé‡è¦ï¼Œä¸ºäº†ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ï¼Œè¦æ±‚Store ä¸­çš„æ•°æ®å°½é‡èŒƒå¼åŒ–ï¼Œä¹Ÿå°±æ˜¯å‡å°‘ä¸€åˆ‡ä¸å¿…è¦çš„å†—ä½™ï¼Œä¸ºäº†é™åˆ¶å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œè¦æ±‚ Store ä¸­æ•°æ®æ˜¯ä¸å¯æ”¹çš„ï¼ˆImmutableï¼‰ï¼Œåªèƒ½é€šè¿‡ action è§¦å‘ reducer æ¥æ›´æ–° Storeã€‚

Mobx ä¹Ÿè®¤ä¸ºæ•°æ®çš„ä¸€è‡´æ€§å¾ˆé‡è¦ï¼Œä½†æ˜¯å®ƒè®¤ä¸ºè§£å†³é—®é¢˜çš„æ ¹æœ¬æ–¹æ³•ä¸æ˜¯è®©æ•°æ®èŒƒå¼åŒ–ï¼Œè€Œæ˜¯ä¸è¦ç»™æœºä¼šè®©æ•°æ®å˜å¾—ä¸ä¸€è‡´ã€‚æ‰€ä»¥ï¼ŒMobx é¼“åŠ±æ•°æ®å¹²è„†å°±â€œåèŒƒå¼åŒ–â€ï¼Œæœ‰å†—ä½™æ²¡é—®é¢˜ï¼Œåªè¦æ‰€æœ‰æ•°æ®ä¹‹é—´ä¿æŒè”åŠ¨ï¼Œæ”¹äº†ä¸€å¤„ï¼Œå¯¹åº”ä¾èµ–è¿™å¤„çš„æ•°æ®è‡ªåŠ¨æ›´æ–°ï¼Œé‚£å°±ä¸ä¼šå‘ç”Ÿæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚

> Redux å’Œ Mobx éƒ½æ˜¯ä¸€ä¸ªç‰¹å®šæ—¶æœŸçš„äº§ç‰©ï¼Œä¸è¦å› ä¸ºæŸä¸ªå·¥å…·æˆ–è€…æŠ€æœ¯ç‚«é…·æˆ–è€…çƒ­é—¨è€Œå»ç”¨å®ƒï¼Œè¦æ ¹æ®è‡ªå·±çš„å·¥ä½œéœ€è¦å»é€‰æ‹©å·¥å…·å’ŒæŠ€æœ¯

## ğŸ“œ Redux ä¸‰å¤§åŸåˆ™

1. å•ä¸€æ•°æ®æº

2. çŠ¶æ€æ˜¯åªè¯»çš„

3. çŠ¶æ€ä¿®æ”¹å‡æœ‰çº¯å‡½æ•°å®Œæˆ

![redux-flow](./images/redux-flow.png)

ç›¸æ¯” Flux å¯ä»¥çœ‹å‡ºï¼ŒRedux æ²¡æœ‰ Dispatcherï¼ŒStore æ˜¯å•ä¸€çš„ï¼ŒStore é€šè¿‡ Reducers çº¯å‡½æ•°è·å–æ–°çš„ Stateï¼Œä½¿å¾—çŠ¶æ€çš„ä¿®æ”¹å˜å¾—ç®€å•ã€çº¯ç²¹ã€å¯æµ‹è¯•ï¼Œå¹¶ä¸”å¯ä»¥è¿½è¸ªæ¯æ¬¡å˜åŒ–ï¼Œå®ç°äº†æ—¶é—´æ—…è¡Œ

## ğŸ—œ middleware

> It provides a third-party extension point between dispatching an action, and the moment it reaches the reducer.

å®ƒæä¾›äº†ä¸€ä¸ªåˆ†ç±»å¤„ç† action çš„æœºä¼šã€‚åœ¨ middleware ä¸­ï¼Œä½ å¯ä»¥æ£€é˜…æ¯ä¸€ä¸ªæµè¿‡çš„ actionï¼ŒæŒ‘é€‰å‡ºç‰¹å®šç±»å‹çš„ action è¿›è¡Œç›¸åº”æ“ä½œï¼Œç»™ä½ ä¸€æ¬¡æ”¹å˜ action çš„æœºä¼š

### 3.1 Redux ä¸ºä»€ä¹ˆéœ€è¦ middleware

middleware å¤§éƒ¨åˆ†éƒ½æ˜¯ç”¨æ¥å¤„ç†å¼‚æ­¥ï¼Œå› ä¸º Redux å†…éƒ¨æ˜¯ `state = reducer(state, action)` è°ƒç”¨ï¼Œæ‰€ä»¥ Redux çš„ reducer å¿…é¡»è¦æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œä¸èƒ½æœ‰ä»»ä½•çš„å‰¯ä½œç”¨ï¼Œä»¥è‡³ Redux å¿…é¡»å¼•å…¥äº† middlewareï¼Œåœ¨ action æ²¡æœ‰åˆ° reducer çš„æ—¶å€™å°±æ‹¦æˆª action å¹¶è¿›è¡Œå‰¯ä½œç”¨çš„æ“ä½œ

ä¹Ÿæ­£å› ä¸º reducer æ˜¯çº¯å‡½æ•°ï¼Œæˆ‘ä»¬é€šè¿‡ middleware è¿›è¡Œçš„å¼‚æ­¥æ“ä½œå’Œåœ¨ä¸€äº›å¤§é¡¹ç›®ä¸­å¯¹ action çš„ç‰¹æ®Šéœ€æ±‚çš„ä¸€äº›å¤„ç†ï¼Œæ‰å¯ä»¥å¾ˆå¥½çš„è¿›è¡Œç»„ç»‡ç®¡ç†

### 3.2 æµç¨‹æ§åˆ¶

ç”±äº middleware ä¸­çš„æ“ä½œæœ€ç»ˆéƒ½éœ€è¦ dispatch ä¸€ä¸ª plain objectï¼Œä¸åŒ middleware ä¸­ä¹Ÿéœ€è¦ dispatch è¿›è¡Œè·³è½¬ï¼Œæ‰€ä»¥å¯¼è‡´ dispatch å¤„çš„é€»è¾‘éš¾ä»¥æŠ½è±¡è¿‡ç¨‹ï¼Œé™¤éä¼ å…¥ dispatch å‚æ•°ï¼Œä»¥è‡³äº middleware å†…éƒ¨é€»è¾‘æ˜¯ä¸€ç§é€šè¿‡ dispatch çš„æµç¨‹æ§åˆ¶

## ğŸ¦ é«˜é˜¶ reducer

`higher-order-reducer:: reducer => reducer`

é«˜é˜¶ reducer å°±æ˜¯æŒ‡å°† reducer ä½œä¸ºå‚æ•°æˆ–è€…è¿”å›å€¼çš„å‡½æ•°

combineReducers å…¶å®å°±æ˜¯ä¸€ä¸ªé«˜é˜¶ reducerï¼Œå› ä¸º combineReducers å°±æ˜¯å°†ä¸€ä¸ª reducer å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œæœ€åè¿”å›é¡¶å±‚çš„ reducer

* reducer çš„å¤ç”¨ï¼š

    æˆ‘ä»¬ä¸¤ä¸ªç»„ä»¶ï¼Œå®ƒä»¬çš„åŠŸèƒ½æ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯ LOAD_DATAï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½è®©å®ƒä»¬å…±ç”¨ä¸€ä¸ª reducerï¼Ÿ

    ä¸èƒ½ï¼Œå› ä¸ºå½“ä¸€ä¸ªç»„ä»¶å‡ºå‘ action æ—¶ï¼Œå¦ä¸€ä¸ªç»„ä»¶çš„çŠ¶æ€ä¹Ÿä¼šæ”¹å˜

    æ‰€ä»¥åœ¨ä¸€ä¸ªåº”ç”¨ä¸­ï¼Œä¸åŒæ¨¡å—é—´çš„ actionType å¿…é¡»æ˜¯å…¨å±€å”¯ä¸€çš„

    æˆ‘ä»¬å¯ä»¥ç”¨å¢åŠ å‰ç¼€çš„æ–¹æ³•è§£å†³ï¼š

    ```js
    const generateReducer = (prefix, state) => {
      const LOAD_DATA = prefix + 'LOAD_DATA'
      const defaultStaet = {}

      return (state = defaultStaet, action) => {
        switch (action.type) {
          case LOAD_DATA:
            return {
              ...state,
              data: action.payload,
            }
          default:
            return state
        }
      }
    }
    ```

* reducer å¢å¼º

    redux-undoï¼š

    ```js
    const undoable = reducer => {
      const defaultState = {
        past: [],
        current: reducer(undefined, {}),
        future: [],
      }

      return (state = defaultState, action) => {
        const { past, current, future } = state

        switch (action.type) {
          case '@@redux-undo/UNDO':
            const previous = past[past.length - 1]
            const newPast = past.slice(0, past.length - 1)

            return {
              past: newPast,
              current: previous,
              future: [current, ...future],
            }
          case '@@redux-undo/REDO':
            const next = future[0]
            const newFuture = future.slice(1)

            return {
              past: [...past, current],
              current: next,
              future: newFuture,
            }
          default:
            const newCurrent = reducer(current, action)

            return {
              past: [...past, current],
              current: newCurrent,
              future: [],
            }
        }
      }
    }
    ```

## ğŸ“ æºç åˆ†æ

### 5.1 createStore

createStore å…¶å®å°±æŠŠ reducer åŒ…äº†ä¸€å±‚ï¼Œæ ¹æœ¬æ²¡æœ‰ storeï¼Œåªæ˜¯æš´éœ²å‡ºå‡ ä¸ªæ¥å£ï¼Œæ–¹ä¾¿æ“ä½œï¼Œå¹¶ç”¨å‘å¸ƒè®¢é˜…æ¨¡å¼å®ç°äº† state æ”¹å˜æ—¶æ‰§è¡Œè®¢é˜…çš„å‡½æ•°çš„åŠŸèƒ½ï¼Œç„¶ååœ¨ä¸€å¼€å§‹å®ç° enhancerï¼Œä¾› applyMiddleware ä½¿ç”¨

reducerã€preloadedState/initialState éƒ½å¾—è‡ªå·±å†™ï¼ŒRedux ä¸ºæˆ‘ä»¬å¹²çš„å¾ˆå°‘

```js
const createStore = (reducer, preloadedState, enhancer) => {
  if (typeof enhancer !== undefined) {
    return enhancer(createStore)(reducer, preloadedState)
  }

  let currentReducer = reducer
  let state = preloadedState
  let listeners = []

  function getState() {
    return state
  }

  function subscribe(listener) {
    // åˆ©ç”¨é—­åŒ…é˜²æ­¢å¤šæ¬¡ unsubscribe
    let isSubscribed = true
    listeners.push(listener)

    return function unsubscribe() {
      if (!isSubscribe) return

      const index = listeners.indexOf(lintener)
      listeners.splice(index, 1)
      isSubscribe = false
    }
  }

  function dispatch(action) {
    state = currentReducer(state, action) // ç¡®å®šäº† reducer ä¸­ä¸èƒ½åšå¼‚æ­¥æ“ä½œ
    // ä¾æ¬¡æ‰§è¡Œè®¢é˜…
    listenters.forEach(listener => listener())

    return action
  }

  function replaceReducer(nextReducer) {
    currentReducer = nextReducer

    dispatch({ type: Symbol('REPLACE') })
  }

  // dispacth ä¸€ä¸ªæ²¡æœ‰çš„ actionï¼Œä»…ç”¨æ¥ç¬¬ä¸€æ¬¡åˆå§‹åŒ– state
  dispatch({ type: Symbol('INIT') })

  return {
    dispatch,
    subscribe,
    getState,
    replaceState,
  }
}
```

### 5.2 combineReducers

combineReducers ä½¿æˆ‘ä»¬æ›´æ–¹ä¾¿çš„ç»„ç»‡ stateï¼Œå®ƒå¹²çš„å°±æ˜¯å°†æ‰€æœ‰çš„ reducers æ‰§è¡Œï¼Œä½¿ç›¸åº”çš„ reducer æ›´æ–°ç›¸åº”çš„ stateï¼Œæœ€ç»ˆå¾—åˆ°æ€»å…±çš„æ–°çš„ state

```js
const combineReducers = reducers => (state, action) => (
  Object.entries(reducers).reducer((nextState, [key, reducer]) => {
    const previousStateForKey = state[key]
    const nextStateForKey = reducer(previousStateForKey, action)

    return nextState[key] = nextStateForKey
  }, {})
)
```

### 5.3 compose

compose å°±æ˜¯å…¸å‹çš„å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„ç»„åˆå‡½æ•°ï¼Œç”¨äºç»„åˆå¤šä¸ª enhancers æˆä¸€ä¸ª enhancer

```js
const compose = (...fns) => fns.reduce((f, g) => (...args) => f(g(...args)))
```

### 5.4 applyMiddleware

applyMiddleware å¯ä»¥å¯¹ç‰¹å®šç±»å‹çš„ action è¿›è¡Œæ“ä½œ

createStore ä¸­çš„ dispatch ç”±äºæœ‰å¯¹ action æ˜¯å¦ä¸º plainObject çš„æ£€æµ‹ï¼Œæ‰€ä»¥åªèƒ½ dispatch plainObjectï¼Œè€Œä¸­é—´ä»¶å¯ä»¥ç©¿å…¥å…¶ä»–ç±»å‹çš„ actionï¼ˆredux-thunk...ï¼‰

å®ç°å°±æ˜¯é€šè¿‡ä¼ å…¥æ—§çš„ createStore è¿”å›å¢å¼ºè¿‡çš„ storeï¼Œä»æ—§çš„ createStore ä¸­æå–å‡ºåŸæ¥ dispatchï¼Œç„¶åå¯¹åŸæ¥çš„ dispatch è¿›è¡ŒåŒ…è£¹ï¼ˆå¢å¼ºï¼‰ï¼Œæ£€æµ‹ç‰¹å®šç±»å‹çš„ action å¹¶è¿›è¡Œçš„ä¸€äº›æ“ä½œï¼Œç„¶åä»ç„¶åˆ›å»ºä¸€ä¸ª plainObject çš„ actionï¼Œä½¿ç”¨åŸæ¥çš„ dispatch æ´¾å‘æ‰

```js
// å¯¹åº” enhancer(createStore)(reducer, preloadedState)
export default function applyMiddleware(...middlewares) {
  return createStore => (...args) => {
    const store = createStore(...args)
    let dispatch = () => {
      throw new Error(
        'Dispatching while constructing your middleware is not allowed. ' +
          'Other middleware would not be applied to this dispatch.'
      )
    }

    // è¿™é‡Œä¸€å¼€å§‹ä¼ å…¥æŠ¥é”™çš„ dispatchï¼Œé˜²æ­¢åœ¨ç»„åˆ middlewares æ—¶ dispatch
    // ä¹‹å dispacth æ”¹å˜ï¼Œæ ¹æ®ä½œç”¨åŸŸå¾—åˆ°å¢å¼ºåçš„ dispatch
    const middlewareAPI = {
      getState: store.getState,
      dispatch: (...args) => dispatch(...args)
    }
    const chain = middlewares.map(middleware => middleware(middlewareAPI))
    // ç»„åˆæ‰€æœ‰ middlewareï¼ˆenhancerï¼‰ï¼ŒæŠŠåŸæ¥çš„ dispatch ä¼ å…¥ï¼Œå¾—åˆ°åŒ…è£¹ï¼ˆå¢å¼ºï¼‰çš„ dispatch
    // æŠŠè¿™è¡Œ compose åˆ†å¼€å†™å°±æ˜¯ dispatch = thunk(logger(timer(store.dispatch)))
    dispatch = compose(...chain)(store.dispatch)

    // è¿”å›æ–°çš„ store
    return {
      ...store,
      dispatch
    }
  }
}
```

ç®€å•çš„ middlewareï¼Œåœ¨æ‰“å°æ—¥å¿—ä¹‹å‰è¾“å‡ºå½“å‰çš„æ—¶é—´æˆ³ï¼š

```js
// è·å– dispatch å’Œ getState æ–¹æ³•ï¼Œæ–¹ä¾¿å†…éƒ¨ä½¿ç”¨ï¼Œè¿”å›æ¥æ”¶ dispatch çš„å‡½æ•°
// è¿™é‡Œ next å°±å¯¹åº”äº†ä¸Šä¸€ä¸ªä¸­é—´ä»¶è¿”å›å‡ºæ¥çš„ dispatch
// action å°±æ˜¯ä¹‹åå¼€å‘è€…å†™çš„è¦æ´¾å‘çš„ action
const timerMiddleware = ({ dispatch, getState }) => next => action => {
  console.log(`timer: ${new Date().getTime()}`)
  next(action)
}
```

å¯¹åº” redux-thunk æºç ï¼š

```js
// å…¶å® thunk å°±æ˜¯ ({ dispatch, getState }) => next => action => ... è¿™ä¸ªå‡½æ•°
// å†åŒ…ä¸€å±‚æ˜¯ä¸ºäº†è·å–é¢å¤–çš„å‚æ•°ï¼Œä»¥ä¾›ä¸€äº›éœ€æ±‚ä½¿ç”¨
function createThunkMiddleware(extraArgument) {
  return ({ dispatch, getState }) => next => action => {
    if (typeof action === 'function') {
      return action(dispatch, getState, extraArgument);
    }

    // action ä¸æ˜¯ function å°±ç”¨åŸæ¥çš„ dispatch æ´¾å‘æ‰
    return next(action);
  };
}

const thunk = createThunkMiddleware();
thunk.withExtraArgument = createThunkMiddleware;

export default thunk;
```

## ref

* æ·±å…¥ react æŠ€æœ¯æ ˆ

* [å®Œå…¨ç†è§£ redux](https://mp.weixin.qq.com/s?__biz=MzIxNjgwMDIzMA==&mid=2247484209&idx=1&sn=1a33a2c8cb58ae98e4f8080ab59da06f&chksm=9782cdb8a0f544ae4101a1a7453e8f5a320d9f338c92bf4a6ce6ae31c6228fd5887a091d7987&mpshare=1&scene=23&srcid=1024nQu5koC1MkPZfll5npNZ&sharer_sharetime=1571885623450&sharer_shareid=ff850364fdc08ae532955239c841ceda%23rd)
