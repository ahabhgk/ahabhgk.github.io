---
title: co ä¸å¼‚æ­¥çš„ä¸€äº›æ€è€ƒ
date: 2020-03-19
author: ahabhgk
description: é€šè¿‡å¯¹ co æºç çš„æ¢ç´¢ï¼Œè¿›ä¸€æ­¥æ€è€ƒï¼Œå¾—åˆ°å¼‚æ­¥è§£å†³æ–¹æ¡ˆçš„æœ¬è´¨æ€è·¯ï¼Œä¸€åˆ‡ç«Ÿç„¶å¦‚æ­¤ç®€å•
tags:
  - SourceCode
  - Thinking
  - Async
---

import { CodeWave } from "gatsby-theme-waves"

JavaScript çš„å¼‚æ­¥ç¼–ç¨‹å‘å±•ç»è¿‡äº†å››ä¸ªé˜¶æ®µï¼š

1. å›è°ƒå‡½æ•°ã€å‘å¸ƒè®¢é˜…

2. Promise

3. co è‡ªæ‰§è¡Œçš„ Generator å‡½æ•°

4. async / await

ç¬¬ä¸‰é˜¶æ®µç°åœ¨åŸºæœ¬ä¸ç”¨äº†ï¼Œä½†ä¹Ÿèµ·åˆ°äº†æ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨

## ğŸ“ co æºç 

co æ¥æ”¶ä¸€ä¸ª generator å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ª promiseï¼Œgenerator å‡½æ•°ä¸­ yieldable å¯¹è±¡æœ‰ï¼š

* promises

* thunks (functions)

* array (parallel execution)

* objects (parallel execution)

* generators (delegation)

* generator functions (delegation)

å…¶ä¸­ array å’Œ objects æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œé‡Œé¢çš„å€¼ä»ç„¶æ˜¯ promise å’Œ thunk å‡½æ•°ï¼Œè€Œ generators å’Œ generator functions æ˜¯é€šè¿‡ä»£ç†æ‰§è¡Œï¼Œå†…éƒ¨å†æ¬¡è°ƒç”¨ coï¼Œæ‰€ä»¥ç®€å•æ¥è¯´éƒ½æ˜¯åŸºäº promise å’Œ thunk å‡½æ•°çš„ï¼Œè€Œ co å†…éƒ¨å¯¹äº thunk çš„å¤„ç†æ˜¯æŠŠ thunk ä¹Ÿè½¬åŒ–æˆ promiseï¼Œæ‰€ä»¥ç›´æ¥çœ‹å¯¹äº yield ä¸€ä¸ª promise çš„ generator æ€ä¹ˆè‡ªåŠ¨æ‰§è¡Œ

<CodeWave>

```js
function* gen() {
  const foo = yield Promise.resolve(1)
  const bar = yield Promise.resolve(2)
  console.log(foo)
  console.log(bar)
}
```

è¿™é‡Œæˆ‘ä»¬å†™ä¸€ä¸ª GeneratorFunctionï¼Œæ¯æ¬¡éƒ½ yield å‡ºä¸€ä¸ª promiseï¼Œæˆ‘ä»¬å¦‚ä½•è®©è¿™æ®µä»£ç ä»¥ç±»ä¼¼åŒæ­¥çš„æ‰§è¡Œæ–¹å¼ä»ä¸Šåˆ°ä¸‹æ‰§è¡Œ

```js
const gen = gen()
g.next()
```

å…ˆå¾—åˆ°ä¸€ä¸ª generatorï¼Œç„¶å nextï¼Œæ­¤æ—¶ generatorFunction æ‰§è¡Œåˆ° yield å¤„

```js
const gen = gen()
g.next().value.then((data) => {
  // next
})
```

è¿”å›çš„ç»“æœçš„ value æ˜¯ yield å‡ºæ¥çš„ promise å®¹å™¨åŒ…è£¹çš„æ•°å€¼ 1ï¼Œé‚£ä¹ˆ then æ–¹æ³•çš„ callback çš„å‚æ•°å°±æ˜¯ 1

```js
const gen = gen()
g.next().value.then((data) => {
  g.next(data)
})
```

ä¸ºäº†è®© yield å·¦è¾¹çš„å˜é‡ foo å¾—åˆ°å¼‚æ­¥ä»£ç çš„ç»“æœï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠ data é€šè¿‡ generator çš„ next æ–¹æ³•ä¼ å…¥å°±å¯ä»¥äº†ï¼ŒåŒæ—¶ generatorFunction çš„æ§åˆ¶æƒä¹Ÿå›åˆ° generatorFunction æ‰‹ä¸­ï¼ŒgeneratorFunction ç»§ç»­æ‰§è¡Œ

```js
const gen = gen()
g.next().value.then((data) => {
  g.next(data).value.then((data) => {
    g.next(data)
  })
})
```

ä¹‹åå†æ¬¡ yield å‡º promise çš„å¼‚æ­¥æ“ä½œï¼Œäº¤å‡ºæ§åˆ¶æƒï¼ŒåŒæ ·çš„é€šè¿‡ next è¿”å›ç»“æœå’Œæ§åˆ¶æƒè®© generatorFunction ç»§ç»­æ‰§è¡Œï¼Œè¿™æ ·å°±å®ç°äº†åŒ…å«å¼‚æ­¥æ“ä½œçš„ generatorFunction çš„åŒæ­¥æ‰§è¡Œ

</CodeWave>

åœ¨ç›´æ¥å¥—ç”¨ co æºç ï¼š

```js
function co(gen) {
  // ...
  return new Promise((resolve, reject) => {
    const g = gen()

    const gResult = g.next() // ç¬¬ä¸€æ¬¡ next
    if (gResult.done) resolve(gResult.value)
    if (gResult.value && isPromise(gResult.value)) {
      value.then((res) => {

        const gResult = g.next(res) // ç¬¬äºŒæ¬¡ next
        if (gResult.done) resolve(gResult.value)
        if (gResult.value && isPromise(gResult.value)) {
          value.then((res) => {

            const gResult = g.next(res) // ç¬¬ä¸‰æ¬¡ nextï¼Œdone ä¸º true
            if (gResult.done) resolve(gResult.value) // resolve æ‰ generator ä¸­ return çš„ç»“æœ
          })
        }
      })
    }
  })
}
```

åœ¨çœ‹ co æ•´ä½“ä»£ç ï¼š

```js
function co(gen) {
  var ctx = this; // é‚£ thisï¼Œä¸€èˆ¬æ˜¯ co.call è¿™æ ·è°ƒç”¨
  var args = slice.call(arguments, 1) // generator çš„å‚æ•°å¯ä»¥åœ¨ gen åé¢ä¼ å…¥

  return new Promise(function(resolve, reject) {
    // æ£€æŸ¥ gen
    if (typeof gen === 'function') gen = gen.apply(ctx, args); // æ™®é€šå‡½æ•°å°±ä¼šè°ƒç”¨å¾—åˆ°è¿”å›å€¼ï¼Œä¸‹ä¸€è¡Œ resolve è¿”å›å€¼
    if (!gen || typeof gen.next !== 'function') return resolve(gen);

    onFulfilled();

    function onFulfilled(res) {
      var ret;
      try {
        ret = gen.next(res);
      } catch (e) { // try / catch åšé”™è¯¯æ•è·
        return reject(e);
      }
      next(ret);
    }

    function onRejected(err) {
      var ret;
      try {
        ret = gen.throw(err);
      } catch (e) {
        return reject(e);
      }
      next(ret);
    }

    function next(ret) {
      if (ret.done) return resolve(ret.value);
      var value = toPromise.call(ctx, ret.value); // æŠŠå…¶ä»–çš„ yieldable è½¬åŒ–æˆ promise
      if (value && isPromise(value)) return value.then(onFulfilled, onRejected);
      return onRejected(new TypeError('You may only yield a function, promise, generator, array, or object, '
        + 'but the following object was passed: "' + String(ret.value) + '"'));
    }
  });
}
```

å…¶ä¸­ toPromise é’ˆå¯¹ä¸åŒçš„ yieldable è¿›è¡Œ xxxToPromiseï¼ŒarrayToPromise æ˜¯é€šè¿‡ Promise.all(value.map(toPromise)) è¿›è¡Œè½¬æ¢ï¼ŒobjectToPromise ç­‰å¾…å¯¹è±¡çš„æ‰€æœ‰çš„å€¼éƒ½ resolve åï¼Œå¹¶æ·»åŠ åˆ°æ–°çš„å¯¹è±¡ä¸­ï¼Œç„¶åå† resolveï¼Œç±»ä¼¼äº Promise.all

thunkToPromise ç±»ä¼¼äºä¸€èˆ¬ Node.js çš„ API çš„ promisifyï¼Œåªä¸è¿‡æ˜¯ thunk å‡½æ•°å·²ç»ä¼ å…¥äº†ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œpromisify æ—¶åªéœ€è¦ä¼ å…¥å¦ä¸€ä¸ªå‚æ•°å°±å¯ä»¥äº†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºè¿™é‡Œ thunk æ˜¯é’ˆå¯¹ Node.js çš„ API çš„ï¼Œä¸ curry çš„ä¸åŒåœ¨äº thunk æ˜¯åˆ†ä¸ºä¸¤æ¬¡å‚æ•°ä¼ å…¥çš„

```js
function thunkToPromise(fn) {
  var ctx = this;
  return new Promise(function (resolve, reject) {
    fn.call(ctx, function (err, res) {
      if (err) return reject(err);
      if (arguments.length > 2) res = slice.call(arguments, 1);
      resolve(res);
    });
  });
}
```

isPromise çš„åˆ¤æ–­ä¹Ÿæ˜¯é€šè¿‡æŸ¥çœ‹å‚æ•°çš„ then æ˜¯ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½“ç°äº†é¸­å­ç±»å‹çš„ç‰¹ç‚¹

```js
function isPromise(obj) {
  return 'function' == typeof obj.then;
}
```

## âš™ï¸ åŸç†

co çš„åŸç†å…¶å®æ˜¯é€šè¿‡ generator.next() å¾—åˆ° generatorResultï¼Œç”±äº yield å‡ºæ˜¯ä¸€ä¸ª promiseï¼Œé€šè¿‡ generatorResult.value.then å†æŠŠ promise çš„ç»“æœé€šè¿‡ generator.next çš„å‚æ•°ä¼ ç»™ yield çš„å·¦è¾¹ï¼Œè®© generator è‡ªåŠ¨æ‰§è¡Œï¼Œé€šè¿‡ generatorResult.done åˆ¤æ–­æ˜¯å¦æ‰§è¡Œç»“æŸ

## ğŸ¤” å¯¹äº JavaScript å¼‚æ­¥çš„æ€è€ƒ

### 3.1 raw callback

æˆ‘ä»¬çœ‹æœ€å¼€å§‹æœ€æœ´ç´ çš„ raw callbackï¼Œæ˜¯å°† callback äº¤ç»™å¦ä¸€ä¸ªå‡½æ•°æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æŠŠ callback çš„æ§åˆ¶æƒäº¤ç»™è¿™ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨è¿›è¡Œå®Œå¼‚æ­¥æ“ä½œä¹‹åè°ƒç”¨ callbackï¼Œä»¥æ­¤å®ç°å¼‚æ­¥

### 3.2 Promise callback

è€Œä¹‹å promise ä¹Ÿæ˜¯é€šè¿‡ä¼ å…¥ callback çš„æ–¹å¼ï¼Œåªä¸è¿‡æŠŠä¹‹å‰åµŒå¥—å¼çš„å½¢å¼å±•å¼€æˆé“¾å¼ï¼Œå…¶å®é€šè¿‡é“¾è¡¨ä¸ºå‡½æ•°å¢åŠ  next å±æ€§ï¼Œä¹Ÿå¯ä»¥ä½¿åµŒå¥—å¼å±•å¼€æˆé“¾å¼

promise é€šè¿‡å®Œæˆå¼‚æ­¥æ“ä½œåè¿›è¡Œ resolve æˆ– rejectï¼Œæ¥æ§åˆ¶ callback çš„æ‰§è¡Œï¼Œè€Œä¸”æä¾›äº† then è¿”å›ä¸€ä¸ª promise çš„è‡ªåŠ¨è¿›è¡Œ flatï¼ˆflatMapï¼‰ï¼Œå®ç°äº† then ä¸­ç»§ç»­æ‰§è¡Œå¼‚æ­¥çš„æ“ä½œï¼Œæ‰€ä»¥æä¾› callback å‚æ•°å¯¹äº promise æ¥è¯´ä¹Ÿæ˜¯ä¸€ç§æ§åˆ¶æƒçš„è½¬ç§»ï¼Œåªä¸è¿‡æ˜¯ä»ä»¥å‰ç›´æ¥çš„å‡½æ•°è°ƒç”¨æ”¹æˆäº† resolveã€reject æ§åˆ¶ callback çš„è°ƒç”¨æ—¶æœº

åŒæ—¶æ˜¯ä¸€ç§æ ‡å‡†çš„å®ç°ä¹Ÿç›¸è¾ƒäºåŸæ¥çš„ raw callback ä¿è¯äº†å†…éƒ¨çš„å¯æ§æ€§ä¸å®‰å…¨æ€§

### 3.3 co + Generator

GeneratorFunction å¾—åˆ°çš„ Generator å¯ä»¥é€šè¿‡ next æ‰“æ–­ GeneratorFunction çš„æ‰§è¡Œï¼Œç”±äºåªèƒ½é€šè¿‡ Generator è°ƒç”¨ next æŠŠ GeneratorFunction çš„æ‰§è¡Œæƒè¿˜ç»™ GeneratorFunctionï¼Œæ‰€ä»¥ç§°ä½œâ€œåŠåç¨‹â€

é€šè¿‡ä¿å­˜ GeneratorFunction çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä½¿ GeneratorFunction å¯ä¸­æ–­æ‰§è¡Œï¼Œä»è€ŒæŠŠ GeneratorFunction æ§åˆ¶æƒäº¤ç»™ Generatorï¼ŒGenerator æ‹¿åˆ°æ§åˆ¶æƒåé€šè¿‡ yield å‡ºæ¥çš„ promise å®Œæˆå¼‚æ­¥æ“ä½œï¼Œç­‰ resolve ä¹‹åå†é€šè¿‡ then ä¸­è°ƒç”¨ next æŠŠå¼‚æ­¥çš„ç»“æœå’Œ GeneratorFunction çš„æ§åˆ¶æƒäº¤ç»™ GeneratorFunctionï¼Œä»¥ç»§ç»­æ‰§è¡Œ yield åçš„æ“ä½œ

### 3.4 async / await

async å‡½æ•°æ˜¯å¯¹ GeneratorFunction + co çš„è¯­ä¹‰åŒ–å’Œæ ‡å‡†åŒ–çš„è¯­æ³•ç³–

ä¾¿æ·æ€§æå‡çš„åŒæ—¶ä¹Ÿæ„å‘³ç€çµæ´»æ€§çš„å‡å°‘ï¼Œç”±äº async / await æ˜¯è¯­æ³•ï¼Œè€Œ promiseã€callback æ˜¯å¯¹è±¡ï¼Œå¯¹è±¡å¯ä»¥åˆ°å¤„ä¼ é€’ï¼ŒReact ä¹Ÿé€šè¿‡ throw ä¸€ä¸ª promise å¦‚æ­¤ creative and hacking çš„æ¨¡æ‹Ÿäº† [Algebraic Effects](https://overreacted.io/algebraic-effects-for-the-rest-of-us/) å®ç° Suspense

åŒæ—¶ Promise å’Œ GeneratorFunction ä¹Ÿç›¸å¯¹äº raw callback çº¦æŸï¼ŒPromise æ˜¯ onFulfilledã€onRejected çš„çº¦æŸï¼ŒGeneratorFunction æ˜¯ nextã€done çš„çº¦æŸï¼ŒNode.js APIs ä¸­ä¹Ÿé™åˆ¶äº† cb çš„å‚æ•°ï¼Œæ‰€ä»¥ä¹Ÿèƒ½è¢«ç»Ÿä¸€çš„ thunk åŒ–ï¼Œè¿™ç§çº¦æŸç±»ä¼¼äºè¯­æ³•ç³–ï¼Œè§„èŒƒçš„åŒæ—¶ä¹Ÿä¸§å¤±äº†äº›è®¸çµæ´»æ€§

### 3.5 RxJS

// TODO: RxJS ä¸ async åŒºåˆ«ï¼ŒRxJS ç†å¿µç­‰

### 3.6 ğŸ”‘ the keys

å¼‚æ­¥çš„å…³é”®å°±åœ¨äºè°ƒç”¨ callback çš„æ—¶æœºï¼Œå› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“å¼‚æ­¥æ“ä½œéœ€è¦å¤šå°‘æ—¶é—´ï¼Œæˆ‘ä»¬è‡ªç„¶ä¹Ÿå°±ä¸çŸ¥é“ä½•æ—¶è°ƒç”¨å¼‚æ­¥ä¹‹åçš„æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡ callback å°†ä¹‹åæ“ä½œçš„æ§åˆ¶æƒäº¤ç»™å¼‚æ­¥æ“ä½œï¼Œå®ç°æ§åˆ¶åè½¬ï¼Œåœ¨å¼‚æ­¥æ“ä½œå®Œæˆä¹‹åè‡ªåŠ¨è°ƒç”¨ callbackï¼Œå°±å®Œæˆäº†åœ¨åˆé€‚çš„æ—¶æœºè¿›è¡Œåˆé€‚çš„æ“ä½œ

## ref

[Generator å‡½æ•°çš„å¼‚æ­¥åº”ç”¨](https://es6.ruanyifeng.com/#docs/generator-async)

[100 è¡Œä»£ç å®ç° Promises/A+ è§„èŒƒ](https://zhuanlan.zhihu.com/p/83965949)

[JAVASCRIPT GETTER-SETTER PYRAMID](https://staltz.com/javascript-getter-setter-pyramid.html)
