{"componentChunkName":"component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx","path":"/blog/koa2-source-code","result":{"data":{"post":{"__typename":"MdxPost","slug":"/blog/koa2-source-code","title":"Koa2 源码分析","date":"12.03.2020","tags":[{"name":"SourceCode","slug":"source-code"}],"description":"深入 Koa2 源码，探寻 Koa2 异步中间件机制","body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Koa2 源码分析\",\n  \"slug\": \"/blog/koa2-source-code\",\n  \"date\": \"2020-03-12T00:00:00.000Z\",\n  \"author\": \"ahabhgk\",\n  \"description\": \"深入 Koa2 源码，探寻 Koa2 异步中间件机制\",\n  \"tags\": [\"SourceCode\"]\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h2\", {\n    \"id\": \"table-of-contents\"\n  }, \"Table of Contents\"), mdx(\"div\", {\n    className: \"table-of-contents\"\n  }, mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#%E5%BA%8F\"\n  }), \"\\u5E8F\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#-%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1\"\n  }), \"\\uD83D\\uDC23 \\u521B\\u5EFA\\u670D\\u52A1\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#11-new-koa-%E5%AE%9E%E4%BE%8B%E5%8C%96\"\n  }), \"1.1 new Koa() \\u5B9E\\u4F8B\\u5316\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#12-appusefn-%E6%B7%BB%E5%8A%A0%E4%B8%AD%E9%97%B4%E4%BB%B6\"\n  }), \"1.2 app.use(fn) \\u6DFB\\u52A0\\u4E2D\\u95F4\\u4EF6\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#13-applisten8080-%E7%9B%91%E5%90%AC%E7%AB%AF%E5%8F%A3\"\n  }), \"1.3 app.listen(8080) \\u76D1\\u542C\\u7AEF\\u53E3\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#131-thiscallback-%E8%BF%94%E5%9B%9E%E4%BB%80%E4%B9%88\"\n  }), \"1.3.1 this.callback() \\u8FD4\\u56DE\\u4EC0\\u4E48\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#1311-thiscreatecontextreq-res\"\n  }), \"1.3.1.1 this.createContext(req, res)\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#1312-thishandlerequestctx-fn\"\n  }), \"1.3.1.2 this.handleRequest(ctx, fn)\")))))))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#-%E4%B8%80%E6%9D%A1-http-%E8%AF%B7%E6%B1%82%EF%BC%9Akoa-%E6%A0%B8%E5%BF%83---%E5%BC%82%E6%AD%A5%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%9C%BA%E5%88%B6\"\n  }), \"\\uD83D\\uDC25 \\u4E00\\u6761 http \\u8BF7\\u6C42\\uFF1AKoa \\u6838\\u5FC3 - \\u5F02\\u6B65\\u4E2D\\u95F4\\u4EF6\\u673A\\u5236\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#%EF%B8%8F-request-response-%E4%BB%A3%E7%90%86%E5%8E%9F%E7%94%9F-req-res\"\n  }), \"\\u26C5\\uFE0F request response \\u4EE3\\u7406\\u539F\\u751F req res\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#31-%E5%BC%95%E5%87%BA%E7%9A%84%E4%B8%80%E4%BA%9B-http-%E5%8D%8F%E8%AE%AE%E7%9F%A5%E8%AF%86%E7%82%B9\"\n  }), \"3.1 \\u5F15\\u51FA\\u7684\\u4E00\\u4E9B http \\u534F\\u8BAE\\u77E5\\u8BC6\\u70B9\")))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86\"\n  }), \"\\uD83D\\uDC7E \\u9519\\u8BEF\\u5904\\u7406\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#-one-more-thing-----%E6%B5%81\"\n  }), \"\\uD83C\\uDF0A One more thing --- \\u6D41\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#%F0%9F%A5%B3-%E7%BB%93%E8%AF%AD\"\n  }), \"\\uD83E\\uDD73 \\u7ED3\\u8BED\")))), mdx(\"h2\", {\n    \"id\": \"序\"\n  }, \"\\u5E8F\"), mdx(\"p\", null, \"Koa \\u7531 express \\u540C\\u4E00\\u4E2A\\u56E2\\u961F\\u6253\\u9020\\uFF0C\\u76EE\\u7684\\u662F\\u4EE3\\u66FF express \\u6210\\u4E3A\\u4E0B\\u4E00\\u4EE3 Node.js \\u540E\\u7AEF\\u6846\\u67B6\\uFF0CKoa \\u7531\\u4E8E\\u5341\\u5206\\u7B80\\u6D01\\uFF0C\\u5176\\u5B9E\\u66F4\\u9002\\u5408\\u505A\\u4E00\\u4E9B\\u6846\\u67B6\\u7684\\u57FA\\u7840\\uFF08egg.js\\u3001think.js\\uFF09\\uFF0C\\u5982\\u4ECA\\u770B\\u6765\\u5E76\\u4E0D\\u80FD\\u4EE3\\u66FF express\\uFF0Cexpress \\u672C\\u8EAB\\u81EA\\u5E26\\u4E00\\u4E9B\\u4E2D\\u95F4\\u4EF6\\u652F\\u6301\\uFF0C\\u57FA\\u4E8E express \\u7F16\\u5199\\u7684 nest \\u66F4\\u662F\\u5927\\u800C\\u5168\\uFF0C\\u7ED3\\u5408 TypeScript \\u5199\\u8D77\\u6765\\u771F\\u7684\\u723D\\uFF0C\\u867D\\u7136 Koa \\u7528\\u7684\\u4EBA\\u4E0D\\u5982 express \\u591A\\uFF0C\\u4F46 Koa \\u786E\\u5B9E\\u6709\\u5176\\u8FDB\\u6B65\\u7684\\u5730\\u65B9\\uFF1A\\u652F\\u6301 \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"async/await\"), \" \\u7684\\u5F02\\u6B65\\u4E2D\\u95F4\\u4EF6\\u673A\\u5236\"), mdx(\"p\", null, \"\\u672C\\u6587\\u7531\\u521B\\u5EFA\\u670D\\u52A1\\u5F00\\u59CB\\uFF0C\\u8BB2\\u8FF0\\u4E86 \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"new Koa()\"), \" \\u5230 \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"app.listen\"), \" Koa \\u6240\\u505A\\u7684\\u4E8B\\uFF0C\\u518D\\u7531\\u4E00\\u6761 http \\u8BF7\\u6C42\\u8BE6\\u7EC6\\u4ECB\\u7ECD\\u4E86 Koa \\u5F02\\u6B65\\u4E2D\\u95F4\\u4EF6\\u673A\\u5236\\uFF0C\\u4E4B\\u540E\\u8BB2\\u8FF0\\u5BF9 ctx \\u7684\\u4FEE\\u6539\\u5982\\u4F55\\u6539\\u52A8\\u539F\\u751F req res\\uFF0C\\u5E76\\u5E26\\u51FA\\u4E00\\u4E9B http \\u76F8\\u5173\\u7684\\u77E5\\u8BC6\\uFF0C\\u6700\\u540E\\u8BB2\\u4E86 Koa \\u5982\\u4F55\\u8FDB\\u884C\\u9519\\u8BEF\\u5904\\u7406\"), mdx(\"h2\", {\n    \"id\": \"-创建服务\"\n  }, \"\\uD83D\\uDC23 \\u521B\\u5EFA\\u670D\\u52A1\"), mdx(\"h3\", {\n    \"id\": \"11-new-koa-实例化\"\n  }, \"1.1 new Koa() \\u5B9E\\u4F8B\\u5316\"), mdx(\"p\", null, \"\\u7EE7\\u627F EventEmitter\\uFF0Cconstructor \\u521D\\u59CB\\u5316\\u53C2\\u6570\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=lib/application.js\"\n  }), \"this.middleware = [];\\nthis.context = Object.create(context);\\nthis.request = Object.create(request);\\nthis.response = Object.create(response);\\n\")), mdx(\"h3\", {\n    \"id\": \"12-appusefn-添加中间件\"\n  }, \"1.2 app.use(fn) \\u6DFB\\u52A0\\u4E2D\\u95F4\\u4EF6\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"\\u5982\\u4F55\\u5224\\u65AD\\u4E00\\u4E2A\\u51FD\\u6570\\u662F generator \\u51FD\\u6570\\uFF1A\", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/ljharb/is-generator-function/\"\n  }), \"is-generator-function\"))), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=lib/application.js\"\n  }), \"use(fn) {\\n  // \\u517C\\u5BB9 v1 Generator\\uFF0C\\u5224\\u65AD fn \\u662F\\u4E0D\\u662F generator\\uFF0C\\u662F\\u5219\\u901A\\u8FC7 koa-convert \\u7528 co \\u8FDB\\u884C\\u5904\\u7406\\n  this.middleware.push(fn)\\n  return this\\n}\\n\")), mdx(\"h3\", {\n    \"id\": \"13-applisten8080-监听端口\"\n  }, \"1.3 app.listen(8080) \\u76D1\\u542C\\u7AEF\\u53E3\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=lib/application.js\"\n  }), \"listen(...args) {\\n  const server = http.createServer(this.callback());\\n  return server.listen(...args);\\n}\\n\")), mdx(\"p\", null, \"\\u5C31\\u662F\\u8C03\\u7528 http \\u521B\\u5EFA\\u670D\\u52A1\\u7684 listen\\uFF0C\\u5173\\u952E\\u5728\\u4E8E createServer \\u7684\\u53C2\\u6570\"), mdx(\"h4\", {\n    \"id\": \"131-thiscallback-返回什么\"\n  }, \"1.3.1 this.callback() \\u8FD4\\u56DE\\u4EC0\\u4E48\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u7EC4\\u5408\\u4E2D\\u95F4\\u4EF6\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u901A\\u8FC7 EventEmitter \\u76D1\\u542C error \\u4E8B\\u4EF6\\uFF0C\\u89E6\\u53D1 error \\u65F6\\u7528 this.onerror \\u5904\\u7406\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u8FD4\\u56DE handleRequest\\uFF0C\\u4F5C\\u4E3A createServer \\u7684\\u56DE\\u8C03\\u51FD\\u6570\\uFF0C\\u5176\\u4E2D\\u521B\\u5EFA ctx \\u7136\\u540E\\u8C03\\u7528\\u81EA\\u5DF1\\u7684 handleRequest \\u4F20\\u5165 ctx \\u548C\\u7EC4\\u5408\\u597D\\u7684\\u4E2D\\u95F4\\u4EF6\\u6765\\u5904\\u7406\\u8BF7\\u6C42\"))), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=lib/application.js\"\n  }), \"callback() {\\n  const fn = compose(this.middleware);\\n\\n  if (!this.listenerCount('error')) this.on('error', this.onerror);\\n\\n  const handleRequest = (req, res) => {\\n    const ctx = this.createContext(req, res);\\n    return this.handleRequest(ctx, fn);\\n  };\\n\\n  return handleRequest;\\n}\\n\")), mdx(\"h5\", {\n    \"id\": \"1311-thiscreatecontextreq-res\"\n  }, \"1.3.1.1 this.createContext(req, res)\"), mdx(\"p\", null, \"\\u521B\\u5EFA ctx\\uFF0C\\u6302\\u8F7D Koa \\u7684 request \\u548C response\\uFF0C\\u6302\\u8F7D\\u539F\\u751F\\u7684 req \\u548C res\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=lib/application.js\"\n  }), \"createContext(req, res) {\\n  const context = Object.create(this.context);\\n  const request = context.request = Object.create(this.request);\\n  const response = context.response = Object.create(this.response);\\n  context.app = request.app = response.app = this;\\n  context.req = request.req = response.req = req;\\n  context.res = request.res = response.res = res;\\n  request.ctx = response.ctx = context;\\n  request.response = response;\\n  response.request = request;\\n  context.originalUrl = request.originalUrl = req.url;\\n  context.state = {};\\n  return context;\\n}\\n\")), mdx(\"h5\", {\n    \"id\": \"1312-thishandlerequestctx-fn\"\n  }, \"1.3.1.2 this.handleRequest(ctx, fn)\"), mdx(\"p\", null, \"\\u8FD9\\u4E2A\\u53EF\\u4EE5\\u8BF4\\u662F\\u7B2C\\u4E00\\u4E2A\\u4E2D\\u95F4\\u4EF6\\uFF0C\\u5904\\u7406\\u9ED8\\u8BA4\\u7684 onerror \\u548C\\u6700\\u540E\\u7528\\u6237\\u54CD\\u5E94\\u7684 respond\"), mdx(\"p\", null, \"\\u6700\\u540E \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"fnMiddleware(ctx).then(handleResponse).catch(onerror)\"), \" \\u53EF\\u4EE5\\u770B\\u51FA\\u7EC4\\u5408\\u7684\\u4E2D\\u95F4\\u4EF6\\u8FD4\\u56DE\\u4E00\\u4E2A promise\\uFF0C\\u4E4B\\u540E\\u8C03\\u7528 respond(ctx) \\u53D1\\u9001\\u54CD\\u5E94\\uFF0C\\u8FD9\\u91CC catch \\u662F\\u9ED8\\u8BA4\\u7684\\u9519\\u8BEF\\u5904\\u7406\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=lib/application.js\"\n  }), \"handleRequest(ctx, fnMiddleware) {\\n  const res = ctx.res;\\n  res.statusCode = 404;\\n  const onerror = err => ctx.onerror(err);\\n  const handleResponse = () => respond(ctx);\\n  onFinished(res, onerror);\\n  return fnMiddleware(ctx).then(handleResponse).catch(onerror);\\n}\\n\")), mdx(\"p\", null, \"\\u4E2D\\u95F4\\u4EF6\\u4E2D\\u901A\\u8FC7\\u7ED9 ctx.body \\u8D4B\\u503C\\uFF0C\\u4F20\\u5230 respond \\u4E2D\\uFF0C\\u5BF9\\u4E8E\\u4E0D\\u5B58\\u5728\\u7684\\u72B6\\u6001\\u7801\\u7684\\u8BF7\\u6C42\\u54CD\\u5E94 res.end()\\uFF0Crespond \\u5BF9\\u4E8E HEAD \\u8BF7\\u6C42\\u8FD4\\u56DE res.end()\\uFF0C\\u5BF9\\u4E8E\\u5B57\\u7B26\\u4E32\\u548C Buffer \\u7684 body \\u54CD\\u5E94 res.end(body)\\uFF0C\\u5BF9\\u4E8E\\u6D41\\u7684 body \\u54CD\\u5E94 body.pipe(res)\\uFF0C\\u6700\\u540E\\u901A\\u8FC7 JSON.stringify(body) \\u5904\\u7406\\u5176\\u4ED6\\u7684\\u5F62\\u5F0F\\uFF0C\\u5982\\u679C\\u662F JSON \\u5219 res.end(body) \\u8FD4\\u56DE stringify \\u5F97 JSON\\uFF0C\\u5982\\u679C\\u62A5\\u9519\\u901A\\u8FC7\\u540E\\u9762 catch \\u5904\\u7406\\uFF0C\\u540C\\u65F6 fnMiddleware \\u4E2D\\u5176\\u4ED6\\u62A5\\u9519\\u4E5F\\u901A\\u8FC7 catch \\u5904\\u7406\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=lib/application.js\"\n  }), \"function respond(ctx) {\\n  // \\u5224\\u65AD\\u662F\\u5426\\u540C\\u610F ctx.respond\\n  // 204 205 304 \\u5FFD\\u7565 body \\u7684\\u72B6\\u6001\\u7801\\n  // \\u5904\\u7406 HEAD \\u8BF7\\u6C42\\n  // \\u5904\\u7406 ctx.body == null\\n\\n  // responses\\n  if (Buffer.isBuffer(body)) return res.end(body);\\n  if ('string' == typeof body) return res.end(body);\\n  if (body instanceof Stream) return body.pipe(res);\\n\\n  // body: json\\n  body = JSON.stringify(body);\\n  if (!res.headersSent) {\\n    ctx.length = Buffer.byteLength(body);\\n  }\\n  res.end(body)\\n}\\n\")), mdx(\"h2\", {\n    \"id\": \"-一条-http-请求：koa-核心---异步中间件机制\"\n  }, \"\\uD83D\\uDC25 \\u4E00\\u6761 http \\u8BF7\\u6C42\\uFF1AKoa \\u6838\\u5FC3 - \\u5F02\\u6B65\\u4E2D\\u95F4\\u4EF6\\u673A\\u5236\"), mdx(\"p\", null, \"\\u76F4\\u63A5\\u5148\\u770B\\u600E\\u6837\\u7EC4\\u5408\\u4E2D\\u95F4\\u4EF6\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=koa-compose\"\n  }), \"function compose (middleware) {\\n  // \\u68C0\\u67E5\\u53C2\\u6570\\n  if (!Array.isArray(middleware)) throw new TypeError('Middleware stack must be an array!')\\n  for (const fn of middleware) {\\n    if (typeof fn !== 'function') throw new TypeError('Middleware must be composed of functions!')\\n  }\\n\\n  return function (context, next) {\\n    // last called middleware #\\n    let index = -1\\n    return dispatch(0)\\n    function dispatch (i) {\\n      if (i <= index) return Promise.reject(new Error('next() called multiple times'))\\n      index = i\\n      let fn = middleware[i]\\n      if (i === middleware.length) fn = next\\n      if (!fn) return Promise.resolve()\\n      try {\\n        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));\\n      } catch (err) {\\n        return Promise.reject(err)\\n      }\\n    }\\n  }\\n}\\n\")), mdx(\"p\", null, \"\\u8FD4\\u56DE\\u4E00\\u4E2A\\u7EC4\\u5408\\u540E\\u7684\\u4E2D\\u95F4\\u4EF6\\uFF0C\\u53C2\\u6570\\u4E5F\\u548C\\u666E\\u901A\\u7684\\u4E2D\\u95F4\\u4EF6\\u4E00\\u6837\\uFF0Cdispatch \\u8FD4\\u56DE\\u4E00\\u4E2A Promise.resolve\\uFF0C\\u4ECE dispatch(0) \\u5F00\\u59CB\\u5C55\\u5F00\\u5199\\u5F97\\u5230\\u7684 fnMiddleware \\u5C31\\u662F\\u8FD9\\u6837\\u7684\\uFF1A\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"// fnMiddleware\\nfunction fnMiddleware(context, next) {\\n  return Promise.resolve(middleware[0](context, function next() {\\n    return Promise.resolve(middleware[1](context, function next() {\\n      return Promise.resolve(middleware[2](context, function next() {\\n        return Promise.resolve() // \\u8FD9\\u91CC i === middleware.length \\u540C\\u65F6 fn \\u5C31\\u662F fnMiddleware(ctx) \\u4E2D\\u4F20\\u5165\\u7684 undefined\\uFF0C\\u6240\\u4EE5\\u76F4\\u63A5 resolve\\n      }))\\n    }))\\n  }))\\n}\\n\")), mdx(\"p\", null, \"\\u901A\\u8FC7 fnMiddleware(ctx) \\u4F20\\u5165 context\\uFF0C\\u5404\\u4E2A middleware \\u5BF9 ctx \\u4E0A\\u7684\\u5C5E\\u6027\\u8FDB\\u884C\\u66F4\\u6539\\u6DFB\\u52A0\\uFF08ctx.body\\u3001ctx.type\\u2026\\u2026\\uFF09\\u7531\\u4E8E ctx \\u5BF9\\u8C61\\u4F20\\u5165 middlware context \\u53C2\\u6570\\u7684\\u503C\\u662F ctx \\u7684\\u5730\\u5740\\uFF0C\\u6240\\u4EE5\\u4E4B\\u540E\\u7684 middleware \\u4E2D\\u53EF\\u4EE5\\u5F97\\u5230\\u4E4B\\u524D middleware \\u4E2D\\u4FEE\\u6539\\u540E\\u7684 ctx\\uFF0C\\u5185\\u90E8\\u8C03\\u7528 \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"await next()\"), \" \\u5C31\\u662F resolve \\u4E0B\\u4E00\\u4E2A middleware\\uFF0C\\u8FD9\\u6837\\u5C31\\u5B9E\\u73B0\\u4E86 Koa \\u7684\\u6D0B\\u8471\\u6A21\\u578B\\u673A\\u5236\"), mdx(\"p\", null, \"\\u6211\\u4EEC\\u53D1\\u73B0\\u8FD9\\u5176\\u5B9E\\u548C JS \\u7684 FP \\u4E2D compose \\u5F88\\u50CF\\uFF0C\\u6211\\u4EEC\\u7528 reduce \\u5B9E\\u73B0\\u8BD5\\u8BD5\\uFF1A\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"// compose\\nconst compose = (fns) =>\\n  (context, next) => fns.reduceRight(\\n    (acc, cur) => Promise.resolve(cur(context, () => acc)),\\n    Promise.resolve('resolve'),\\n  )\\n\\nconst sleep = (time) => new Promise(resolve => setTimeout(() => resolve(time), time))\\n\\nconst ctx = { body: 0 }\\n\\nconst middlewares = [\\n  async (ctx, next) => {\\n    ctx.body = 1\\n    console.log(ctx.body) // 1\\n    await next().then(() => {\\n      ctx.body = 6\\n      console.log(ctx.body) // 6\\n    })\\n  },\\n  async (ctx, next) => {\\n    await sleep(1000)\\n    ctx.body = 2\\n    console.log(ctx.body) // 2\\n    await next().then(() => {\\n      ctx.body = 5\\n      console.log(ctx.body) // 5\\n    })\\n  },\\n  async (ctx, next) => {\\n    await sleep(1000)\\n    ctx.body = 3\\n    console.log(ctx.body) // 3\\n    await next().then((r) => {\\n      console.log(r)\\n      ctx.body = 4\\n      console.log(ctx.body) // 4\\n    })\\n  },\\n]\\n\\ncompose(middlewares)(ctx)\\n\")), mdx(\"p\", null, \"\\u8FD9\\u65F6\\u53D1\\u73B0\\u53EA\\u4F1A\\u505C\\u987F 1 \\u79D2\\uFF0C\\u7136\\u540E\\u987A\\u5E8F\\u4E5F\\u4E0D\\u5BF9\\uFF0C\\u800C\\u6362\\u6210\\u5B98\\u65B9\\u7684 compose \\u5C31\\u4E00\\u5207\\u6B63\\u5E38\\uFF0C\\u505C\\u987F\\u4E24\\u79D2\\u540C\\u65F6\\u987A\\u5E8F\\u6B63\\u786E\\uFF0C\\u8FD9\\u662F\\u56E0\\u4E3A reduce \\u548C reduceRight \\u662F\\u540C\\u6B65\\u7684\\uFF0C\\u53EA\\u505C\\u987F\\u4E00\\u79D2\\u662F\\u56E0\\u4E3A\\u4E24\\u4E2A sleep \\u5E76\\u884C\\u4E86\\uFF08\\u7C7B\\u4F3C \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Promise.all([asyncFn1, asyncFn2])\"), \"\\uFF09\\uFF0CKoa \\u4E2D\\u95F4\\u4EF6\\u7684\\u7279\\u6B8A\\u4E0E\\u5BF9\\u5904\\u7406\\u8BF7\\u6C42\\u7684\\u8FDB\\u6B65\\u70B9\\u5C31\\u5728\\u4E8E\\u6B64\\uFF0C\\u4E0D\\u540C\\u4E8E express \\u548C redux \\u7684\\u4E2D\\u95F4\\u4EF6\\u673A\\u5236\\uFF0CKoa \\u5B9E\\u73B0\\u7684\\u662F\", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"\\u5F02\\u6B65\\u4E2D\\u95F4\\u4EF6\")), mdx(\"p\", null, \"\\u540C\\u65F6\\u8FD9\\u6837\\u4E5F\\u53EF\\u4EE5\\u901A\\u8FC7 i \\u6765\\u68C0\\u67E5\\u4E00\\u4E2A middleware \\u4E2D\\u662F\\u5426\\u591A\\u6B21\\u8C03\\u7528 next \\u7684\\u4F5C\\u7528\\uFF0CKoa \\u6CA1\\u6709\\u4F7F\\u7528\\u8FD9\\u79CD\\u65B9\\u5F0F\\u4E5F\\u662F\\u4E3A\\u4E86\\u4FDD\\u8BC1 i \\u53EF\\u4EE5\\u68C0\\u67E5\\u591A\\u6B21\\u8C03\\u7528 next\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=koa-compose\"\n  }), \"function dispatch (i) {\\n  if (i <= index) return Promise.reject(new Error('next() called multiple times'))\\n  index = i // \\u8FD9\\u91CC\\u4FEE\\u6539 index\\n  let fn = middleware[0]\\n  if (i === middleware.length) fn = next\\n  if (!fn) return Promise.resolve()\\n  try {\\n    return Promise.resolve((async (ctx, next) => {\\n      // \\u5047\\u8BBE\\u73B0\\u5728\\u662F dispatch(0)\\uFF0C\\u6B64\\u65F6 index = 0\\uFF0Ci = 0\\n      await dispatch.bind(null, 0 + 1)() // \\u5185\\u90E8\\u4FEE\\u6539 index = 1\\n      await dispatch.bind(null, 0 + 1)() // \\u5185\\u90E8 i <= index\\uFF1A1 <= 1 \\u6210\\u7ACB reject \\u6389\\n    })(context, dispatch.bind(null, 0 + 1)));\\n  } catch (err) {\\n    return Promise.reject(err)\\n  }\\n}\\n\")), mdx(\"p\", null, \"\\u770B\\u5B8C\\u4E2D\\u95F4\\u4EF6\\u673A\\u5236\\u518D\\u6765\\u770B http \\u8BF7\\u6C42\\u4ECE\\u63A5\\u53D7\\u5230\\u54CD\\u5E94\\u5C31\\u7B80\\u5355\\u4E86\\uFF0Cthis.callback \\u8FD4\\u56DE\\u7684\\u5C31\\u662F http.createServer \\u7684\\u56DE\\u8C03\\u51FD\\u6570\\uFF0C\\u6240\\u4EE5 req res \\u4ECE\\u8FD9\\u91CC\\u63A5\\u6536\\uFF0C\\u4E4B\\u540E req res \\u8FDB\\u5165 createContext \\u6302\\u8F7D\\u5230 ctx \\u5BF9\\u8C61\\u4E0A\\uFF0C\\u4E4B\\u540E\\u628A\\u7EC4\\u5408\\u597D\\u7684 fnMiddleware \\u548C ctx \\u4F20\\u5165 this.handleRequest\\uFF0C\\u8FD9\\u91CC\\u5904\\u7406\\u597D onerror \\u548C respond \\u4E4B\\u540E\\u5F00\\u59CB\\u628A ctx \\u4F20\\u5165 fnMiddleware\\uFF0C\\u901A\\u8FC7\\u5F00\\u53D1\\u8005\\u7F16\\u5199\\u7684\\u4E2D\\u95F4\\u4EF6\\u5BF9 req res \\u8FDB\\u884C\\u771F\\u6B63\\u7684\\u5904\\u7406\\uFF0C\\u6700\\u540E\\u5904\\u7406\\u597D\\u540E\\u901A\\u8FC7 \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \".then(() => respond(ctx))\"), \" \\u4F5C\\u51FA\\u54CD\\u5E94\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"\\u7B80\\u5316\\u7684\\u8FED\\u4EE3\\u7248 compose\"), mdx(\"pre\", {\n    parentName: \"blockquote\"\n  }, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"function compose(mws) {\\n  return (context, next) => {\\n    let next = () => Promise.resolve()\\n    for (const mw of [...mws].reverse()) {\\n      const nextFn = next\\n      next = () => Promise.resolve(mw(context, nextFn))\\n    }\\n    return next()\\n  }\\n}\\n\"))), mdx(\"h2\", {\n    \"id\": \"️-request-response-代理原生-req-res\"\n  }, \"\\u26C5\\uFE0F request response \\u4EE3\\u7406\\u539F\\u751F req res\"), mdx(\"p\", null, \"\\u6211\\u4EEC\\u5BF9 ctx \\u4E0A\\u5904\\u7406\\u4E00\\u822C\\u662F\\u5BF9 ctx.request \\u548C ctx.response \\u5904\\u7406\\uFF0C\\u4F46 request response \\u53EA\\u662F\\u5BF9\\u539F\\u751F req res \\u901A\\u8FC7 \", \"_\", \"_\", \"defineGetter\", \"_\", \"_\", \" \\u548C \", \"_\", \"_\", \"defineSetter\", \"_\", \"_\", \" \\u505A\\u7684\\u4EE3\\u7406\\uFF0C\\u6700\\u7EC8\\u7684\\u4FEE\\u6539\\u8FD8\\u662F\\u5BF9 req res \\u7684\\u4FEE\\u6539\\uFF0C\\u6211\\u4EEC\\u901A\\u8FC7\\u51E0\\u5904\\u770B\\u770B\\u8FD9\\u5C42\\u4EE3\\u7406\\u6709\\u4EC0\\u4E48\\u4F5C\\u7528\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"_\", \"_\", \"defineGetter\", \"_\", \"_\", \"\\u3001\", \"_\", \"_\", \"defineSetter\", \"_\", \"_\", \" \\u5E76\\u4E0D\\u662F\\u6807\\u51C6\\uFF0C\\u4E0D\\u63A8\\u8350\\u4F7F\\u7528\")), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"request \\u7684 get \\u65B9\\u6CD5\\uFF0C\\u8FD9\\u91CC\\u4E3A\\u4E86\\u90A3\\u8BF7\\u6C42\\u5934\\u7684\\u5B57\\u6BB5\\uFF0C\\u5BF9 referer \\u548C referrer \\u505A\\u4E86\\u517C\\u5BB9\")), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"Referer \\u7684\\u6B63\\u786E\\u62FC\\u5199\\u662F Referrer\\uFF0C\\u4F46\\u662F\\u5199\\u5165\\u6807\\u51C6\\u7684\\u65F6\\u5019\\uFF0C\\u4E0D\\u77E5\\u4E3A\\u4F55\\uFF0C\\u6CA1\\u4EBA\\u53D1\\u73B0\\u5C11\\u4E86\\u4E00\\u4E2A\\u5B57\\u6BCD r\\u3002\\u6807\\u51C6\\u5B9A\\u6848\\u4EE5\\u540E\\uFF0C\\u53EA\\u80FD\\u5C06\\u9519\\u5C31\\u9519\\uFF0C\\u6240\\u6709\\u5934\\u4FE1\\u606F\\u7684\\u8BE5\\u5B57\\u6BB5\\u90FD\\u4E00\\u5F8B\\u9519\\u8BEF\\u62FC\\u5199\\u6210 Referer\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=lib/request.js\"\n  }), \"get(field) {\\n  const req = this.req;\\n  switch (field = field.toLowerCase()) {\\n    case 'referer':\\n    case 'referrer':\\n      return req.headers.referrer || req. headers.referer || '';\\n    default:\\n      return req.headers[field] || '';\\n  }\\n},\\n\")), mdx(\"ol\", {\n    \"start\": 2\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"get set \\u4E2D\\u5904\\u7406 req res\\uFF0C\\u662F\\u5F00\\u53D1\\u8005\\u66F4\\u65B9\\u4FBF\\u7684\\u62FF\\u5230\\u4E00\\u4E9B\\u6570\\u636E\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=lib/request.js\"\n  }), \"get query() {\\n  const str = this.querystring;\\n  const c = this._querycache = this.  _querycache || {};\\n  return c[str] || (c[str] = qs.parse(str)) ;\\n},\\n\\nset query(obj) {\\n  this.querystring = qs.stringify(obj);\\n},\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=lib/response.js\"\n  }), \"set etag(val) {\\n  if (!/^(W\\\\/)?\\\"/.test(val)) val = `\\\"${val} \\\"`;\\n  this.set('ETag', val);\\n},\\n\\nget etag() {\\n  return this.get('ETag');\\n},\\n\")), mdx(\"ol\", {\n    \"start\": 3\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"response \\u4E2D body \\u7684\\u5904\\u7406\\uFF0C\\u5BF9\\u4E8E\\u4E0D\\u540C\\u683C\\u5F0F body \\u7684\\u8D4B\\u503C\\uFF0C\\u5728 set \\u4E2D\\u5BF9 type\\u3001length \\u7B49\\u8FDE\\u540C\\u4E00\\u8D77\\u5904\\u7406\\uFF0C\\u65B9\\u4FBF\\u5F00\\u53D1\\u8005\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=lib/response.js\"\n  }), \"get body() {\\n  return this._body;\\n},\\n\\nset body(val) {\\n  const original = this._body;\\n  this._body = val;\\n\\n  // no content\\n  if (null == val) {\\n    if (!statuses.empty[this.status]) this. status = 204;\\n    this.remove('Content-Type');\\n    this.remove('Content-Length');\\n    this.remove('Transfer-Encoding');\\n    return;\\n  }\\n\\n  // set the status\\n  if (!this._explicijstatus) this.status =  200;\\n\\n  // set the content-type only if not yet   set\\n  const setType = !this.has('Content-Type') ;\\n\\n  // string\\n  if ('string' == typeof val) {\\n    if (setType) this.type = /^\\\\s*</.test (val) ? 'html' : 'text';\\n    this.length = Buffer.byteLength(val);\\n    return;\\n  }\\n\\n  // buffer\\n  if (Buffer.isBuffer(val)) {\\n    if (setType) this.type = 'bin';\\n    this.length = val.length;\\n    return;\\n  }\\n\\n  // stream\\n  if ('function' == typeof val.pipe) {\\n    onFinish(this.res, destroy.bind(null,   val));\\n    ensureErrorHandler(val, err => this.  ctx.onerror(err));\\n\\n    // overwriting\\n    if (null != original && original !=   val) this.remove('Content-Length');\\n\\n    if (setType) this.type = 'bin';\\n    return;\\n  }\\n\\n  // json\\n  this.remove('Content-Length');\\n  this.type = 'json';\\n},\\n\")), mdx(\"ol\", {\n    \"start\": 4\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"response \\u4E2D redirect \\u7684\\u5C01\\u88C5\\uFF0Ccontext \\u4E2D cookie \\u7684\\u5C01\\u88C5\\uFF0C\\u63D0\\u4F9B\\u4E00\\u4E9B\\u5C01\\u88C5\\u597D\\u7684\\u65B9\\u6CD5\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=lib/response.js\"\n  }), \"redirect(url, alt) {\\n  // location\\n  if ('back' == url) url = this.ctx.get ('Referrer') || alt || '/';\\n  this.set('Location', encodeUrl(url));\\n\\n  // status\\n  if (!statuses.redirect[this.status])  this.status = 302;\\n\\n  // html\\n  if (this.ctx.accepjs('html')) {\\n    url = escape(url);\\n    this.type = 'text/html; charset=utf-8';\\n    this.body = `Redirecting to <a href=\\\"$  {url}\\\">${url}</a>.`;\\n    return;\\n  }\\n\\n  // text\\n  this.type = 'text/plain; charset=utf-8';\\n  this.body = `Redirecting to ${url}.`;\\n},\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=lib/context.js\"\n  }), \"get cookies() {\\n  if (!this[COOKIES]) {\\n    this[COOKIES] = new Cookies(this.req,   this.res, {\\n      keys: this.app.keys,\\n      secure: this.request.secure\\n    });\\n  }\\n  return this[COOKIES];\\n},\\n\\nset cookies(_cookies) {\\n  this[COOKIES] = _cookies;\\n}\\n\")), mdx(\"ol\", {\n    \"start\": 5\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"\\u63D0\\u4F9B toJSON \\u65B9\\u4FBF\\u8C03\\u8BD5\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=lib/context.js\"\n  }), \"toJSON() {\\n  return {\\n    request: this.request.toJSON(),\\n    response: this.response.toJSON(),\\n    app: this.app.toJSON(),\\n    originalUrl: this.originalUrl,\\n    req: '<original node req>',\\n    res: '<original node res>',\\n    socket: '<original node socket>'\\n  };\\n},\\n\")), mdx(\"p\", null, \"\\u5176\\u4ED6\\u8FD8\\u6709\\u5728 ctx \\u7528 \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/tj/node-delegates\"\n  }), \"delegate \\u5E93\"), \"\\u5BF9\\u4E00\\u4E9B\\u5E38\\u7528\\u6570\\u636E\\u76F4\\u63A5\\u4EE3\\u7406\\u5230 ctx \\u5BF9\\u8C61\\u4E0A\\uFF08ctx.body === ctx.response.body\\uFF09\"), mdx(\"h3\", {\n    \"id\": \"31-引出的一些-http-协议知识点\"\n  }, \"3.1 \\u5F15\\u51FA\\u7684\\u4E00\\u4E9B http \\u534F\\u8BAE\\u77E5\\u8BC6\\u70B9\"), mdx(\"p\", null, \"// TODO: \\u5F15\\u51FA\\u7684\\u4E00\\u4E9B http \\u534F\\u8BAE\\u77E5\\u8BC6\\u70B9\"), mdx(\"h2\", {\n    \"id\": \"-错误处理\"\n  }, \"\\uD83D\\uDC7E \\u9519\\u8BEF\\u5904\\u7406\"), mdx(\"p\", null, \"\\u5B98\\u65B9\\u6709\\u4E09\\u79CD\\u65B9\\u5F0F\\uFF1A\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u4E2D\\u95F4\\u4EF6\\u4E2D \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"try/catch\"))), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u6DFB\\u52A0\\u9519\\u8BEF\\u5904\\u7406\\u4E2D\\u95F4\\u4EF6\\uFF08\\u6216\\u4F7F\\u7528\\u9ED8\\u8BA4\\u7684\\uFF09\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u5904\\u7406 error \\u4E8B\\u4EF6\\uFF08\\u9ED8\\u8BA4\\u662F\\u6253 log\\uFF09\"))), mdx(\"p\", null, \"\\u7B2C\\u4E00\\u79CD\\u6CA1\\u4EC0\\u4E48\\u597D\\u8BF4\\u7684\\uFF0C\\u7B2C\\u4E8C\\u79CD\\u4E2D\\u9ED8\\u8BA4\\u7684\\u5C31\\u662F \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"this.handleRequest\"), \" \\u4E2D\\u7684 onerror\\uFF0C\\u76F4\\u63A5\\u4F7F\\u7528 \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"const onerror = err => ctx.onerror(err)\"), \" \\u5904\\u7406\\uFF0Cctx.onerrer \\u4F1A\\u7528 \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/jshttp/statuses\"\n  }), \"statuses \\u5E93\"), \"\\u5BF9 error.code \\u4F5C\\u51FA\\u5BF9\\u5E94\\u7684\\u54CD\\u5E94\\u4FE1\\u606F\\uFF0C\\u540C\\u65F6 ctx.onerror \\u8FD8\\u4F1A\\u89E6\\u53D1\\uFF08emit\\uFF09error \\u4E8B\\u4EF6\\uFF08Application \\u7EE7\\u627F EventEmitter\\uFF09\\uFF0Capp \\u9ED8\\u8BA4\\u7684 \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"on('error', this.onerror)\"), \" \\u662F\\u5BF9\\u9519\\u8BEF\\u4FE1\\u606F\\u6253 log\"), mdx(\"p\", null, \"\\u4E00\\u822C\\u9ED8\\u8BA4\\u7684\\u5C31\\u591F\\u7528\\u4E86\\uFF0C\\u5982\\u679C\\u6709\\u5176\\u4ED6\\u9700\\u6C42\\u53EF\\u4EE5\\u4FEE\\u6539 app.onerror \\u6216\\u6DFB\\u52A0\\u9519\\u8BEF\\u4E2D\\u95F4\\u4EF6\\u5904\\u7406\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"app.use(async (ctx, next) => {\\n  try {\\n    await next();\\n  } catch (err) {\\n    // will only respond with JSON\\n    ctx.status = err.statusCode || err.status || 500;\\n    ctx.body = {\\n      message: err.message\\n    };\\n  }\\n})\\n\")), mdx(\"p\", null, \"\\u8FD9\\u91CC\\u76F8\\u5F53\\u4E8E\\u5728\\u7B2C\\u4E00\\u4E2A\\u4E2D\\u95F4\\u4EF6 catch \\u4E4B\\u540E\\u4E2D\\u95F4\\u4EF6\\u7684\\u9519\\u8BEF\\uFF0C\\u5728 respond \\u4E4B\\u524D\\u5904\\u7406\\u597D\\u9519\\u8BEF\\u7136\\u540E\\u901A\\u8FC7 respond \\u54CD\\u5E94\\uFF0C\\u9519\\u8BEF\\u5C31\\u4E0D\\u4F1A\\u88AB\\u4E4B\\u540E \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \".catch\"), \" \\u6293\\u4F4F\\uFF0C\\u4EE5\\u6B64\\u8986\\u76D6\\u9ED8\\u8BA4\\u7684 onerror\"), mdx(\"h2\", {\n    \"id\": \"-one-more-thing-----流\"\n  }, \"\\uD83C\\uDF0A One more thing --- \\u6D41\"), mdx(\"p\", null, \"http \\u8BF7\\u6C42\\u975E\\u5E38\\u9002\\u5408\\u770B\\u4F5C\\u4E00\\u4E2A\\u6D41\\uFF0CKoa \\u4E2D use \\u7684\\u4E2D\\u95F4\\u4EF6\\u76F8\\u5F53\\u4E8E\\u4E00\\u4E2A\\u7BA1\\u9053\\uFF0C\\u5BF9 ctx \\u6D41\\u7684\\u6570\\u636E\\u8FDB\\u884C\\u5904\\u7406\\uFF0C\\u5904\\u7406\\u5B8C\\u540E respond\"), mdx(\"p\", null, \"\\u7ED3\\u5408 RxJS \\u7684\\u4F2A\\u4EE3\\u7801\\uFF1A\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-ts\"\n  }), \"const server = http\\n  .createServer()\\n  .listen(8080, () => console.log('Server is running on port 8080...'))\\n\\nconst server$ = fromEvent<[IncomingMessage, ServerResponse]>(server, 'request')\\nconst ctx$ = server$.pipe(map(([req, res]) => ({ req, res })))\\n\\nctx$.pipe(\\n  map(routerMiddleware),\\n  map(controllerMiddleware),\\n  map(serverMiddleware),\\n  map(errorHandlerMiddleware),\\n).subscribe({\\n  next: respond,\\n  error: defaultErrorHandler,\\n  complete: defaultCompleteHandler,\\n})\\n\")), mdx(\"p\", null, \"\\u5F53\\u7136\\u975E\\u5E38\\u4E0D\\u5B8C\\u6574\\uFF0C\\u53EA\\u662F\\u4E00\\u4E2A\\u60F3\\u6CD5\\u7684\\u4F53\\u73B0\\uFF0C\\u5176\\u5B9E\\u5DF2\\u7ECF\\u6709\\u4EBA\\u5B9E\\u73B0\\u4E86\\u7528 RxJS \\u7684\\u540E\\u7AEF\\u6846\\u67B6\\uFF1A\", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/marblejs/marble\"\n  }), \"marblejs\"), \"\\uFF0C\\u5F53\\u7136\\u6211\\u4EEC\\u8FD8\\u662F\\u8981\\u7ED3\\u5408\\u5B9E\\u9645\\u8FDB\\u884C\\u9009\\u62E9\"), mdx(\"h2\", {\n    \"id\": \"🥳-结语\"\n  }, \"\\uD83E\\uDD73 \\u7ED3\\u8BED\"), mdx(\"p\", null, \"\\u4F7F\\u7528 TypeScript \\u5B9E\\u73B0\\u4E86\\u4E00\\u4E2A\\u7B80\\u6613\\u7248\\u7684 Koa\\uFF0C\\u5220\\u51CF\\u4E86\\u5F88\\u591A ctx \\u5BF9 request response \\u7684\\u5904\\u7406\\uFF0C\\u53EA\\u4F53\\u73B0\\u4E86\\u6838\\u5FC3\\u601D\\u8DEF\\uFF0C\\u611F\\u5174\\u8DA3\\u53EF\\u4EE5\\u770B\\u770B\\uFF1A\", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/ahabhgk/ts-koa-core\"\n  }), \"ts-koa-core\")), mdx(\"p\", null, \"\\u901A\\u8FC7\\u770B Koa \\u6E90\\u7801\\u540C\\u65F6\\u7B80\\u5355\\u770B\\u4E86\\u770B\\u76F8\\u5173\\u4F9D\\u8D56\\u7684\\u5E93\\u7684\\u6E90\\u7801\\uFF0C\\u4E5F\\u7B97\\u5BF9\\u4EE5\\u524D\\u4E0D\\u7406\\u89E3\\u7684\\u5730\\u65B9\\u6709\\u4E86\\u66F4\\u6E05\\u6670\\u7684\\u7406\\u89E3\"), mdx(\"p\", null, \"\\u4EE5\\u524D\\u5BF9 cookie\\u3001etag \\u4EC0\\u4E48\\u7684\\u4E0D\\u77E5\\u9053\\u5230\\u5E95\\u600E\\u4E48\\u5199\\u7684\\uFF0C\\u73B0\\u5728\\u53D1\\u73B0\\u5176\\u5B9E\\u5C31\\u662F\\u5BF9 node \\u7684 req res \\u7684\\u4FEE\\u6539\\uFF0C\\u5F53\\u7136 node \\u5E95\\u5C42\\u4E5F\\u505A\\u4E86\\u5F88\\u591A\\uFF0C\\u4F46\\u4E5F\\u7B97\\u5728\\u4E00\\u5B9A\\u62BD\\u8C61\\u5C42\\u6B21\\u4E0A\\u660E\\u767D\\u4E86\\u540E\\u7AEF\\u5176\\u5B9E\\u662F\\u5BF9 req res \\u7684\\u5904\\u7406\\uFF0C\\u540C\\u65F6\\u4F5C\\u51FA side effect\\uFF0C\\u590D\\u6742\\u65F6\\u5C31\\u9700\\u8981\\u5904\\u7406\\u590D\\u6742\\u60C5\\u51B5\"), mdx(\"p\", null, \"\\u8FD8\\u7528\\u4E2D\\u95F4\\u4EF6\\u673A\\u5236\\u4E3A\\u4EC0\\u4E48 compose \\u4E0E FP \\u5E38\\u5199\\u7684 compose \\u5F88\\u4E0D\\u4E00\\u6837\\uFF0C\\u8FD8\\u6709 i \\u5BF9\\u591A\\u6B21\\u8C03\\u7528 next \\u7684\\u68C0\\u67E5\\u771F\\u7684\\u975E\\u5E38\\u5DE7\\u5999\\uFF0C\\u771F\\u7684\\u975E\\u5E38\\u4F69\\u670D TJ \\u5927\\u795E\"));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"Table of Contents 序 Koa 由 express 同一个团队打造，目的是代替 express 成为下一代 Node.js 后端框架，Koa 由于十分简洁，其实更适合做一些框架的基础（egg.js、think.js），如今看来并不能代替 express…","timeToRead":2,"banner":null}},"pageContext":{"slug":"/blog/koa2-source-code","formatString":"DD.MM.YYYY"}},"staticQueryHashes":["318001574","3787687951","3787687951"]}