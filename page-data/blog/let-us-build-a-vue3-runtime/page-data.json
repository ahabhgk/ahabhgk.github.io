{"componentChunkName":"component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx","path":"/blog/let-us-build-a-vue3-runtime","result":{"data":{"post":{"__typename":"MdxPost","slug":"/blog/let-us-build-a-vue3-runtime","title":"Let's build a Vue3 runtime","date":"24.09.2020","tags":[{"name":"SourceCode","slug":"source-code"},{"name":"Front End Framework","slug":"front-end-framework"}],"description":"Let's build a Vue3 runtime","body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Let's build a Vue3 runtime\",\n  \"slug\": \"/blog/let-us-build-a-vue3-runtime\",\n  \"date\": \"2020-09-24T00:00:00.000Z\",\n  \"author\": \"ahabhgk\",\n  \"description\": \"Let's build a Vue3 runtime\",\n  \"tags\": [\"SourceCode\", \"Front End Framework\"]\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h2\", {\n    \"id\": \"table-of-contents\"\n  }, \"Table of Contents\"), mdx(\"div\", {\n    className: \"table-of-contents\"\n  }, mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#%E5%BA%8F\"\n  }), \"\\u5E8F\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#-vue3-entry\"\n  }), \"\\uD83D\\uDC40 Vue3 Entry\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#-vnode-design\"\n  }), \"\\uD83C\\uDF1F VNode Design\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#%EF%B8%8F-patchelement--patchtext\"\n  }), \"\\u2604\\uFE0F patchElement & patchText\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#-patchcomponent\"\n  }), \"\\uD83D\\uDCA5 patchComponent\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#-scheduler\"\n  }), \"\\uD83D\\uDCAB Scheduler\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#%EF%B8%8F-key-diff\"\n  }), \"\\u26A1\\uFE0F key diff\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#-renderer\"\n  }), \"\\uD83C\\uDFA8 Renderer\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", _extends({\n    parentName: \"li\"\n  }, {\n    \"href\": \"#-ramble\"\n  }), \"\\uD83D\\uDE03 ramble\")))), mdx(\"h2\", {\n    \"id\": \"序\"\n  }, \"\\u5E8F\"), mdx(\"p\", null, \"\\u6211\\u4EEC\\u4F1A\\u4E00\\u8D77\\u5199\\u4E00\\u4E2A\\u7B80\\u6613\\u7684 runtime\\uFF0C\\u5BF9\\u4E8E Vue \\u5982\\u4F55\\u8FD0\\u884C\\u7684\\u6709\\u4E00\\u4E2A\\u5927\\u81F4\\u7684\\u4E86\\u89E3\\uFF0C\\u5F53\\u7136\\u6211\\u4EEC\\u5B9E\\u73B0\\u7684\\u4F1A\\u548C\\u6E90\\u7801\\u672C\\u8EAB\\u6709\\u4E00\\u4E9B\\u4E0D\\u540C\\uFF0C\\u4F1A\\u7B80\\u5316\\u5F88\\u591A\\uFF0C\\u4E3B\\u8981\\u5B66\\u4E60\\u601D\\u60F3\"), mdx(\"p\", null, \"\\u672C\\u7BC7\\u6587\\u7AE0\\u5E76\\u4E0D\\u662F\\u4E3A\\u4E86\\u6DF1\\u5165 Vue3 \\u6E90\\u7801\\uFF0C\\u800C\\u662F\\u5BF9 Vue3 \\u6838\\u5FC3 VDOM \\u548C\\u65B0\\u7279\\u6027\\u7684\\u7B80\\u5355\\u4E86\\u89E3\\uFF0C\\u9002\\u5408\\u4F5C\\u4E3A\\u6DF1\\u5165 Vue3 \\u6E90\\u7801\\u7684\", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"\\u5165\\u95E8\"), \"\\u6587\\u7AE0\"), mdx(\"h2\", {\n    \"id\": \"-vue3-entry\"\n  }, \"\\uD83D\\uDC40 Vue3 Entry\"), mdx(\"p\", null, \"\\u6211\\u4EEC\\u5148\\u770B\\u4E00\\u4E0B Vue3 \\u7684 JSX \\u7EC4\\u4EF6\\u600E\\u4E48\\u5199\\uFF0C\\u56E0\\u4E3A\\u6211\\u4EEC\\u53EA\\u662F\\u9020\\u4E00\\u4E2A runtime\\uFF0C\\u6240\\u4EE5\\u4E0D\\u4F1A\\u6D89\\u53CA\\u5230 Vue \\u7684\\u6A21\\u7248\\u7F16\\u8BD1\\uFF0C\\u76F4\\u63A5\\u7528 JSX \\u5C31\\u5F88\\u65B9\\u4FBF\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-jsx\"\n  }), \"import { createApp, ref } from 'vue';\\n\\nconst Displayer = {\\n  props: { count: Number },\\n  setup(props) {\\n    return () => <div>{props.count}</div>;\\n  },\\n};\\n\\nconst App = {\\n  setup(props) {\\n    const count = ref(0);\\n    const inc = () => count.value++;\\n\\n    return () => (\\n      <div>\\n        <Displayer count={count.value} />\\n        <button onClick={inc}> + </button>\\n      </div>\\n    );\\n  },\\n};\\n\\ncreateApp(App).mount('#app');\\n\")), mdx(\"p\", null, \"\\u6211\\u4EEC\\u8FD9\\u91CC\\u76F4\\u63A5\\u7528\\u7684\\u5BF9\\u8C61\\u5F62\\u5F0F\\u7684\\u7EC4\\u4EF6\\uFF0C\\u4E00\\u822C\\u4F1A\\u4F7F\\u7528 defineComponent\\uFF0C\\u5B83\\u505A\\u7684\\u53EA\\u662F\\u591A\\u4E86\\u5904\\u7406\\u4F20\\u5165\\u4E00\\u4E2A\\u51FD\\u6570\\u7684\\u60C5\\u51B5\\uFF0C\\u8FD4\\u56DE\\u4E00\\u4E2A\\u6709 setup \\u65B9\\u6CD5\\u7684\\u5BF9\\u8C61\\uFF0C\\u5E76\\u6CA1\\u6709\\u66F4\\u591A\\u5176\\u4ED6\\u7684\\u5904\\u7406\\u4E86\\uFF0C\\u81F3\\u4E8E\\u4E3A\\u4EC0\\u4E48\\u8BBE\\u8BA1\\u51FA\\u4E00\\u4E2A \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"defineComponent\"), \" \\u65B9\\u6CD5\\u800C\\u4E0D\\u76F4\\u63A5\\u5199\\u5BF9\\u8C61\\uFF0C\\u5927\\u6982\\u662F\\u4E3A\\u4E86\\u5728 API \\u8BBE\\u8BA1\\u5C42\\u9762\\u548C \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"defineAsyncComponent\"), \" \\u4E00\\u81F4\\u5427\"), mdx(\"p\", null, \"\\u5148\\u770B\\u5165\\u53E3 createApp\\uFF0C\\u7FFB\\u7FFB\\u6E90\\u7801\\u53EF\\u4EE5\\u770B\\u51FA\\u505A\\u7684\\u4E8B\\u662F\\u6839\\u636E rendererOptions \\u521B\\u5EFA renderer\\uFF0C\\u7136\\u540E\\u521B\\u5EFA app \\u5BF9\\u8C61\\uFF0C\\u6700\\u540E\\u8C03\\u7528 app.mount \\u8FDB\\u884C\\u6E32\\u67D3\\uFF0Cmount \\u91CC\\u4E5F\\u662F\\u8C03\\u7528\\u7684 render\"), mdx(\"p\", null, \"\\u6211\\u4EEC\\u5199\\u7B80\\u5355\\u4E00\\u70B9\\uFF0C\\u53BB\\u6389 app \\u7684\\u521B\\u5EFA\\uFF0C\\u56E0\\u4E3A\\u521B\\u5EFA app \\u5176\\u5B9E\\u7C7B\\u4F3C\\u4E8E\\u4E00\\u4E2A\\u4F5C\\u7528\\u57DF\\uFF0Capp \\u7684\\u63D2\\u4EF6\\u548C\\u6307\\u4EE4\\u7B49\\u53EA\\u5BF9\\u8BE5 app \\u4E0B\\u7684\\u7EC4\\u4EF6\\u8D77\\u4F5C\\u7528\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/renderer.js\"\n  }), \"export function createRenderer(renderOptions) {\\n\\n  return {\\n    render(rootVNode, container) {\\n\\n    },\\n  }\\n}\\n\")), mdx(\"p\", null, \"\\u901A\\u8FC7 \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"createRenderer(nodeOps).render(<App />, document.querySelector('root'))\"), \" \\u8C03\\u7528\\uFF0C\\u6CA1\\u9519\\u6211\\u5C31\\u662F\\u6284 React \\u7684\\uFF0C\\u4F46\\u662F\\u4E0E React \\u4E0D\\u540C\\u7684\\u5728\\u4E8E React \\u4E2D\\u8C03\\u7528 \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"<App />\"), \" \\u8FD4\\u56DE\\u7684\\u662F\\u4E00\\u4E2A ReactElement\\uFF0C\\u8FD9\\u91CC\\u6211\\u4EEC\\u76F4\\u63A5\\u8FD4\\u56DE VNode\\uFF0CReactElement \\u5176\\u5B9E\\u5C31\\u662F \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Partial<Fiber>\"), \"\\uFF0CReact \\u4E2D\\u662F\\u901A\\u8FC7 ReactElement \\u5BF9 Fiber\\uFF08VNode\\uFF09\\u8FDB\\u884C diff\\uFF0C\\u6211\\u4EEC\\u76F4\\u63A5 VNode \\u5BF9\\u6BD4 VNode \\u4E5F\\u662F\\u53EF\\u4EE5\\u7684\\uFF08\\u5B9E\\u9645\\u4E0A Vue \\u548C Preact \\u90FD\\u662F\\u8FD9\\u4E48\\u505A\\u7684\\uFF09\"), mdx(\"h2\", {\n    \"id\": \"-vnode-design\"\n  }, \"\\uD83C\\uDF1F VNode Design\"), mdx(\"p\", null, \"\\u63A5\\u4E0B\\u6765\\u6211\\u4EEC\\u6765\\u8BBE\\u8BA1 VNode\\uFF0C\\u56E0\\u4E3A VNode \\u5F88\\u5927\\u7A0B\\u5EA6\\u4E0A\\u51B3\\u5B9A\\u4E86\\u5185\\u90E8 runtime \\u5982\\u4F55\\u53BB diff\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/vnode.js\"\n  }), \"export function h(type, props, ...children) {\\n  props = props ?? {}\\n\\n  const key = props.key ?? null\\n  delete props.key\\n\\n  // \\u6CE8\\u610F props.children \\u548C children \\u7684\\u4E0D\\u540C\\n  // props.children \\u56E0\\u4E3A\\u5B50\\u7EC4\\u4EF6\\u4F1A\\u4F7F\\u7528\\u6240\\u4EE5\\u662F\\u6CA1\\u6709\\u5904\\u7406\\u8FC7\\u7684\\n  // children \\u662F\\u4E3A\\u4E86\\u7EF4\\u6301\\u5185\\u90E8\\u7684 VNode \\u6811\\u7ED3\\u6784\\u800C\\u521B\\u5EFA\\u7684\\uFF0C\\u7C7B\\u578B\\u662F\\u4E00\\u4E2A VNode \\u6570\\u7EC4\\n  if (children.length === 1) {\\n    props.children = children[0]\\n  } else if (children.length > 1) {\\n    props.children = children\\n  }\\n\\n  return {\\n    type,\\n    props,\\n    key, // key diff \\u7528\\u7684\\n    node: null, // \\u5BBF\\u4E3B\\u73AF\\u5883\\u7684\\u5143\\u7D20\\uFF08dom node\\u2026\\u2026\\uFF09\\uFF0C\\u7EC4\\u4EF6 VNode \\u4E3A null\\n    instance: null, // \\u7EC4\\u4EF6\\u5B9E\\u4F8B\\uFF0C\\u53EA\\u6709\\u7EC4\\u4EF6 VNode \\u4F1A\\u6709\\uFF0C\\u5176\\u4ED6 VNode \\u4E3A null\\n    parent: null, // parent VNode\\n    children: null, // VNode[]\\uFF0C\\u5EFA\\u7ACB\\u5185\\u90E8 VNode \\u6811\\u7ED3\\u6784\\n  }\\n}\\n\")), mdx(\"p\", null, \"Vue3 \\u7684 JSX \\u8BED\\u6CD5\\u5DF2\\u7ECF\\u8DDF React \\u5F88\\u50CF\\u4E86\\uFF0C\\u9664\\u4E86 props.children \\u662F\\u901A\\u8FC7 Slots \\u5B9E\\u73B0\\u4EE5\\u5916\\uFF0C\\u57FA\\u672C\\u90FD\\u4E00\\u6837\\uFF0C\\u8FD9\\u91CC\\u6211\\u4EEC\\u5E76\\u4E0D\\u6253\\u7B97\\u5B9E\\u73B0 Slots\\uFF0C\\u56E0\\u4E3A Slots \\u5B9E\\u73B0\\u7684 children \\u4E5F\\u662F\\u4E00\\u79CD props\\uFF0C\\u662F\\u4E00\\u6BB5 JSX \\u800C\\u5DF2\\uFF0C\\u5E76\\u4E0D\\u7B97\\u7279\\u6B8A\\uFF0C\\u6BD5\\u7ADF\\u4F60\\u968F\\u4FBF\\u5199\\u4E2A props \\u4E0D\\u53EB children \\u7136\\u540E\\u4F20 JSX \\u4E5F\\u662F\\u53EF\\u4EE5\\u7684\\u3002Vue \\u4E13\\u95E8\\u5F04\\u4E00\\u4E2A Slots \\u662F\\u4E3A\\u4E86\\u517C\\u5BB9\\u5B83\\u7684 template \\u8BED\\u6CD5\"), mdx(\"h2\", {\n    \"id\": \"️-patchelement--patchtext\"\n  }, \"\\u2604\\uFE0F patchElement & patchText\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/renderer.js\"\n  }), \"export function createRenderer(renderOptions) {\\n  return {\\n    render(vnode, container) {\\n      if (vnode == null) {\\n        if (container.vnode) {\\n          unmount(container.vnode)\\n        }\\n      } else {\\n        patch(container.vnode ?? null, vnode, container)\\n      }\\n      container.vnode = vnode\\n    },\\n  }\\n}\\n\")), mdx(\"p\", null, \"\\u6211\\u4EEC\\u8865\\u5168 render \\u65B9\\u6CD5\\u7684\\u5B9E\\u73B0\\uFF0C\\u8FD9\\u91CC\\u4E0D\\u76F4\\u63A5\\u5199 \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"patch(null, vnode, container)\"), \" \\u7684\\u539F\\u56E0\\u662F render \\u6709\\u53EF\\u80FD\\u591A\\u6B21\\u8C03\\u7528\\uFF0C\\u5E76\\u4E0D\\u4E00\\u5B9A\\u6BCF\\u6B21\\u8C03\\u7528\\u90FD\\u662F mount\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=shared/index.js\"\n  }), \"export const isObject = (value) => typeof value === 'object' && value !== null\\nexport const isString = (value) => typeof value === 'string'\\nexport const isNumber = (value) => typeof value === 'number'\\nexport const isText = (v) => isString(v) || isNumber(v)\\nexport const isArray = Array.isArray\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/component.js\"\n  }), \"import { isObject } from '../shared'\\n\\nexport const TextType = Symbol('TextType')\\nexport const isTextType = (v) => v === TextType\\n\\nexport const isSetupComponent = (c) => isObject(c) && 'setup' in c\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/vnode.js\"\n  }), \"// ...\\nexport const isSameVNodeType = (n1, n2) => n1.type === n2.type && n1.key === n2.key\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/renderer.js\"\n  }), \"import { isString, isArray, isText } from '../shared'\\nimport { TextType, isTextType, isSetupComponent } from './component'\\nimport { isSameVNodeType, h } from './vnode'\\n\\nexport function createRenderer(renderOptions) {\\n  const patch = (n1, n2, container) => {\\n    if (n1 && !isSameVNodeType(n1, n2)) {\\n      unmount(n1)\\n      n1 = null\\n    }\\n\\n    const { type } = n2\\n    if (isSetupComponent(type)) {\\n      processComponent(n1, n2, container)\\n    } else if (isString(type)) {\\n      processElement(n1, n2, container)\\n    } else if (isTextType(type)) {\\n      processText(n1, n2, container)\\n    } else {\\n      type.patch(/* ... */)\\n    }\\n  }\\n\\n  // ...\\n}\\n\")), mdx(\"p\", null, \"patch\\uFF08\\u4E5F\\u5C31\\u662F diff\\uFF09\\u5728 type \\u5224\\u65AD\\u6700\\u540E\\u52A0\\u4E00\\u4E2A\\u201C\\u540E\\u95E8\\u201D\\uFF0C\\u6211\\u4EEC\\u53EF\\u4EE5\\u7528\\u5B83\\u6765\\u5B9E\\u73B0\\u4E00\\u4E9B\\u6DF1\\u5EA6\\u5B9A\\u5236\\u7684\\u7EC4\\u4EF6\\uFF0C\\u6BD4\\u5982 setupComponent \\u5C31\\u53EF\\u4EE5\\u653E\\u5230\\u8FD9\\u91CC\\u5B9E\\u73B0\\uFF0C\\u6216\\u8005\\u8FD8\\u53EF\\u4EE5\\u5B9E\\u73B0 Hooks\\uFF08\\u6284 Preact \\u7684\\uFF0CPreact Compat \\u5F88\\u591A\\u5B9E\\u73B0\\u90FD\\u662F\\u62FF\\u5230\\u7EC4\\u4EF6\\u5B9E\\u4F8B this \\u53BB hack this \\u4E0A\\u7684\\u4E00\\u4E9B\\u65B9\\u6CD5\\uFF0C\\u6216\\u8005\\u518D\\u62FF\\u5185\\u90E8\\u7684\\u4E00\\u4E9B\\u65B9\\u6CD5\\u53BB\\u5904\\u7406\\uFF0C\\u6BD4\\u5982 diff\\u3001diffChildren\\u2026\\u2026\\uFF09\\uFF0C\\u8FD9\\u91CC\\u6211\\u4EEC\\u751A\\u81F3\\u53EF\\u4EE5\\u5B9E\\u73B0\\u4E00\\u5957 Preact Component\\u2026\\u2026\"), mdx(\"p\", null, \"diff \\u6700\\u4E3B\\u8981\\u7684\\u5C31\\u662F\\u5BF9\\u4E8E Element \\u548C Text \\u7684 diff\\uFF0C\\u5BF9\\u5E94\\u5143\\u7D20\\u8282\\u70B9\\u548C\\u6587\\u672C\\u8282\\u70B9\\uFF0C\\u6240\\u4EE5\\u6211\\u4EEC\\u5148\\u5B9E\\u73B0\\u8FD9\\u4E24\\u4E2A\\u65B9\\u6CD5\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/renderer.js\"\n  }), \"const processText = (n1, n2, container) => {\\n  if (n1 == null) {\\n    const node = n2.node = document.createTextNode(n2.props.nodeValue)\\n    container.appendChild(node)\\n  } else {\\n    const node = n2.node = n1.node\\n    if (node.nodeValue !== n2.props.nodeValue) {\\n      node.nodeValue = n2.props.nodeValue\\n    }\\n  }\\n}\\n\\nconst processElement = (n1, n2, container) => {\\n  if (n1 == null) {\\n    const node = n2.node = document.createElement(n2.type)\\n    mountChildren(n2, node)\\n    patchProps(null, n2.props, node)\\n    container.appendChild(node)\\n  } else {\\n    const node = n2.node = n1.node\\n    patchChildren(n1, n2, node)\\n    patchProps(n1.props, n2.props, node)\\n  }\\n}\\n\\nconst mountChildren = (vnode, container) => {\\n  let children = vnode.props.children\\n  children = isArray(children) ? children : [children]\\n  vnode.children = []\\n  for (let i = 0; i < children.length; i++) {\\n    let child = children[i]\\n    if (child == null) continue\\n    child = isText(child) ? h(TextType, { nodeValue: child }) : child\\n    vnode.children[i] = child\\n    patch(null, child, container)\\n  }\\n}\\n\")), mdx(\"p\", null, \"\\u53EF\\u4EE5\\u770B\\u5230\\u5BF9\\u4E8E DOM \\u5E73\\u53F0\\u7684\\u64CD\\u4F5C\\u662F\\u76F4\\u63A5\\u5199\\u4E0A\\u53BB\\u7684\\uFF0C\\u5E76\\u6CA1\\u6709\\u901A\\u8FC7 renderOptions \\u4F20\\u5165\\uFF0C\\u6211\\u4EEC\\u5148\\u8FD9\\u6837\\u8026\\u5408\\u8D77\\u6765\\uFF0C\\u540E\\u9762\\u518D\\u5206\\u79BB\\u5230 renderOptions \\u4E2D\"), mdx(\"p\", null, \"processText \\u7684\\u903B\\u8F91\\u5F88\\u7B80\\u5355\\uFF0CprocessElement \\u4E0E processText \\u7C7B\\u4F3C\\uFF0C\\u53EA\\u4E0D\\u8FC7\\u591A\\u4E86 patchChildren / mountChildren \\u548C patchProps\"), mdx(\"p\", null, \"patchProps \\u4E00\\u770B\\u5C31\\u77E5\\u9053\\u662F\\u7528\\u6765\\u66F4\\u65B0 props \\u7684\"), mdx(\"p\", null, \"mountChildren \\u5C31\\u662F\\u5BF9\\u5B50\\u8282\\u70B9\\u5904\\u7406\\u4E0B Text \\u7136\\u540E\\u4E00\\u4E00 patch\"), mdx(\"p\", null, \"patchChildren \\u5C31\\u662F\\u5BF9\\u4E8E\\u4E24\\u4E2A VNode \\u7684\\u5B50\\u8282\\u70B9\\u7684 diff\\uFF0C\\u5B83\\u4E0E patch \\u7684\\u4E0D\\u540C\\u5728\\u4E8E patchChildren \\u53EF\\u4EE5\\u5904\\u7406\\u5B50\\u8282\\u70B9\\u662F VNode \\u6570\\u7EC4\\u7684\\u60C5\\u51B5\\uFF0C\\u5BF9\\u4E8E\\u5B50\\u8282\\u70B9\", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"\\u5982\\u4F55 patch\"), \" \\u505A\\u4E86\\u5904\\u7406\\uFF08\\u6307 key diff\\uFF09\\uFF0C\\u800C patch \\u5C31\\u662F\\u7B80\\u7B80\\u5355\\u5355\\u5BF9\\u4E8E\\u4E24\\u4E2A VNode \\u8282\\u70B9\\u7684 diff\"), mdx(\"p\", null, \"\\u6240\\u4EE5\\u5BF9\\u4E8E Element \\u7684\\u5B50\\u8282\\u70B9\\u4F1A\\u8C03\\u7528 patchChildren / mountChildren \\u5904\\u7406\\uFF0C\\u56E0\\u4E3A Element \\u5B50\\u8282\\u70B9\\u53EF\\u4EE5\\u662F\\u591A\\u4E2A\\u7684\\uFF0C\\u800C\\u5BF9\\u4E8E Component \\u7684\\u5B50\\u8282\\u70B9\\u4F1A\\u8C03\\u7528 patch \\u5904\\u7406\\uFF0C\\u56E0\\u4E3A Component \\u5B50\\u8282\\u70B9\\u90FD\\u4EC5\\u6709\\u4E00\\u4E2A\\uFF08Fragment \\u662F\\u6709\\u591A\\u4E2A\\u5B50\\u8282\\u70B9\\u7684\\uFF0C\\u5BF9\\u4E8E\\u5B83\\u6211\\u4EEC\\u53EF\\u4EE5\\u901A\\u8FC7 compat \\u5904\\u7406\\uFF09\\uFF0C\\u5F53\\u7136 Component \\u7684\\u5B50\\u8282\\u70B9\\u4E5F\\u53EF\\u4EE5\\u8C03\\u7528 patchChildren \\u5904\\u7406\\uFF0CPreact \\u5C31\\u662F\\u8FD9\\u6837\\u505A\\u7684\\uFF0C\\u8FD9\\u6837 Preact \\u5C31\\u4E0D\\u7528\\u5BF9 Fragment \\u5355\\u72EC\\u5904\\u7406\\u4E86\\uFF08\\u8FD9\\u91CC\\u5173\\u952E\\u4E0D\\u5728\\u4E8E\\u600E\\u6837\\u5904\\u7406\\uFF0C\\u800C\\u5728\\u4E8E\\u8BBE\\u8BA1\\u7684 Component \\u5B50\\u8282\\u70B9\\u53EF\\u4E0D\\u53EF\\u4EE5\\u662F\\u591A\\u7684\\uFF0C\\u505A\\u5BF9\\u5E94\\u5904\\u7406\\u5373\\u53EF\\uFF09\"), mdx(\"p\", null, \"\\u63A5\\u4E0B\\u6765\\u6211\\u4EEC\\u770B\\u4E00\\u4E0B patchProps\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/renderer.js\",\n    \"metastring\": \"{27,30,35}\",\n    \"{27,30,35}\": true\n  }), \"const patchProps = (oldProps, newProps, node) => {\\n  oldProps = oldProps ?? {}\\n  newProps = newProps ?? {}\\n  // remove old props\\n  Object.keys(oldProps).forEach((propName) => {\\n    if (propName !== 'children' && propName !== 'key' && !(propName in newProps)) {\\n      setProperty(node, propName, null, oldProps[propName]);\\n    }\\n  });\\n  // update old props\\n  Object.keys(newProps).forEach((propName) => {\\n    if (propName !== 'children' && propName !== 'key' && oldProps[propName] !== newProps[propName]) {\\n      setProperty(node, propName, newProps[propName], oldProps[propName]);\\n    }\\n  });\\n}\\n\\nconst setProperty = (node, propName, newValue, oldValue) => {\\n  if (propName[0] === 'o' && propName[1] === 'n') {\\n    const eventType = propName.toLowerCase().slice(2);\\n\\n    if (!node.listeners) node.listeners = {};\\n    node.listeners[eventType] = newValue;\\n\\n    if (newValue) {\\n      if (!oldValue) {\\n        node.addEventListener(eventType, eventProxy);\\n      }\\n    } else {\\n      node.removeEventListener(eventType, eventProxy);\\n    }\\n  } else if (newValue !== oldValue) {\\n    if (propName in node) {\\n      node[propName] = newValue == null ? '' : newValue\\n    } else if (newValue == null || newValue === false) {\\n      node.removeAttribute(propName)\\n    } else {\\n      node.setAttribute(propName, newValue)\\n    }\\n  }\\n}\\n\\nfunction eventProxy(e) {\\n  // this: dom node\\n  this.listeners[e.type](e)\\n}\\n\")), mdx(\"p\", null, \"\\u503C\\u5F97\\u6CE8\\u610F\\u7684\\u662F\\u7B2C 35 \\u884C\\u5BF9\\u4E8E \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"newValue === false\"), \" \\u7684\\u5904\\u7406\\uFF0C\\u662F\\u76F4\\u63A5 removeAttribute \\u7684\\uFF0C\\u8FD9\\u662F\\u4E3A\\u4E86\\u8868\\u5355\\u7684\\u4E00\\u4E9B\\u5C5E\\u6027\\u3002\\u8FD8\\u6709\\u5BF9\\u4E8E\\u4E8B\\u4EF6\\u7684\\u76D1\\u542C\\uFF0C\\u6211\\u4EEC\\u901A\\u8FC7\\u4E00\\u4E2A eventProxy \\u4EE3\\u7406\\uFF0C\\u8FD9\\u6837\\u4E0D\\u4EC5\\u65B9\\u4FBF\\u79FB\\u9664\\u4E8B\\u4EF6\\u76D1\\u542C\\uFF0C\\u8FD8\\u51CF\\u5C11\\u4E86\\u4E0E DOM \\u7684\\u901A\\u4FE1\\uFF0C\\u4FEE\\u6539\\u4E86\\u4E8B\\u4EF6\\u76D1\\u542C\\u65B9\\u6CD5\\u76F4\\u63A5\\u4FEE\\u6539\\u4EE3\\u7406\\u5373\\u53EF\\uFF0C\\u4E0D\\u81F3\\u4E8E\\u4E0E DOM \\u901A\\u4FE1\\u79FB\\u9664\\u65E7\\u7684\\u4E8B\\u4EF6\\u518D\\u6DFB\\u52A0\\u65B0\\u7684\\u4E8B\\u4EF6\"), mdx(\"p\", null, \"\\u63A5\\u4E0B\\u6765\\u770B diff \\u7B97\\u6CD5\\u7684\\u6838\\u5FC3\\uFF1ApatchChildren\\uFF0C\\u6211\\u4EEC\\u5148\\u5B9E\\u73B0\\u4E00\\u4E2A\\u7B80\\u6613\\u7248\\u7684 key diff\\uFF0C\\u4E0D\\u8003\\u8651\\u8282\\u70B9\\u7684\\u79FB\\u52A8\\uFF0C\\u540E\\u9762\\u4F1A\\u6709\\u5B8C\\u6574\\u7684 key diff\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/renderer.js\",\n    \"metastring\": \"{18,24}\",\n    \"{18,24}\": true\n  }), \"const patchChildren = (n1, n2, container) => {\\n  const oldChildren = n1.children // \\u62FF\\u5230\\u65E7\\u7684 VNode[]\\n  let newChildren = n2.props.children // \\u65B0\\u7684 children\\n  newChildren = isArray(newChildren) ? newChildren : [newChildren]\\n  n2.children = [] // \\u65B0\\u7684 VNode[]\\n\\n  for (let i = 0; i < newChildren.length; i++) {\\n    if (newChildren[i] == null) continue\\n    let newChild = newChildren[i]\\n    // \\u5904\\u7406 Text\\uFF0CText \\u4E5F\\u4F1A\\u5EFA\\u7ACB VNode\\uFF0CText \\u4E0D\\u76F4\\u63A5\\u66B4\\u9732\\u7ED9\\u5F00\\u53D1\\u8005\\uFF0C\\u800C\\u662F\\u5728\\u5185\\u90E8\\u5904\\u7406\\n    newChild = isText(newChild) ? h(TextType, { nodeValue: newChild }) : newChild\\n    n2.children[i] = newChild\\n    newChild.parent = n2 // \\u4E0E n2.children \\u5EFA\\u7ACB\\u5185\\u90E8 VNode Tree\\n\\n    let oldChild = null\\n    for (let j = 0; j < oldChildren.length; j++) { // key diff\\n      if (oldChildren[j] == null) continue\\n      if (isSameVNodeType(oldChildren[j], newChild)) { // \\u627E\\u5230 key \\u548C type \\u4E00\\u6837\\u7684 VNode\\n        oldChild = oldChildren[j]\\n        oldChildren[j] = null // \\u627E\\u5230\\u7684\\u5C31\\u53D8\\u4E3A null\\uFF0C\\u6700\\u540E\\u4E0D\\u662F null \\u7684\\u5C31\\u662F\\u9700\\u8981\\u79FB\\u9664\\u7684\\uFF0C\\u5168\\u90E8 unmount \\u5373\\u53EF\\n        break\\n      }\\n    }\\n    patch(oldChild, newChild, container)\\n    if (newChild.node) container.appendChild(newChild.node) // \\u6709 node \\u5C31\\u6DFB\\u52A0\\u5230 DOM \\u4E2D\\uFF0C\\u56E0\\u4E3A component \\u6CA1\\u6709 node\\n  }\\n\\n  for (let oldChild of oldChildren) {\\n    if (oldChild != null) unmount(oldChild)\\n  }\\n}\\n\")), mdx(\"p\", null, \"\\u6211\\u4EEC\\u5E76\\u6CA1\\u6709\\u8003\\u8651\\u79FB\\u52A8\\u8282\\u70B9\\u7684\\u60C5\\u51B5\\uFF0C\\u800C\\u4E14\\u662F\\u6839\\u636E\\u987A\\u5E8F diff \\u7684 newVNode\\uFF0C\\u5982\\u679C\\u4E4B\\u524D node \\u5728 container \\u4E2D\\uFF0CappendChild \\u4F1A\\u5148\\u79FB\\u9664\\u4E4B\\u524D\\u7684 node\\uFF0C\\u7136\\u540E\\u6DFB\\u52A0\\u5230\\u672B\\u5C3E\\uFF0C\\u6240\\u4EE5\\u662F\\u6CA1\\u95EE\\u9898\\u7684\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/renderer.js\"\n  }), \"const unmount = (vnode) => {\\n  const child = vnode.node\\n  const parent = child.parentNode\\n  parent && parent.removeChild(child)\\n}\\n\")), mdx(\"p\", null, \"\\u7136\\u540E\\u5B9E\\u73B0 unmount\\uFF0C\\u56E0\\u4E3A\\u76EE\\u524D\\u53EA\\u8003\\u8651 Element \\u548C Text \\u7684 diff\\uFF0Cunmount \\u5C31\\u6CA1\\u6709\\u5BF9 Component \\u7684 unmount \\u8FDB\\u884C\\u5904\\u7406\\uFF0C\\u540E\\u9762\\u6211\\u4EEC\\u4F1A\\u52A0\\u4E0A\\uFF0C\\u73B0\\u5728\\u53EF\\u4EE5\\u5199\\u4E2A demo \\u770B\\u770B\\u6548\\u679C\\u4E86\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-jsx\"\n  }), \"/** @jsx h */\\nimport { createRenderer, h } from '../../packages/runtime-core'\\n\\nconst renderer = createRenderer() // \\u8FD9\\u91CC\\u6211\\u4EEC\\u8FD8\\u6CA1\\u6709\\u5206\\u79BB\\u5E73\\u53F0\\u64CD\\u4F5C\\uFF0C\\u53EF\\u4EE5\\u5148\\u8FD9\\u6837\\u5199\\nconst $root = document.querySelector('#root')\\nconst arr = [1, 2, 3]\\n\\nsetInterval(() => {\\n  arr.unshift(arr.pop())\\n  renderer.render(\\n    <div>\\n      {arr.map(e => <li key={e}>{e}</li>)}\\n    </div>,\\n    $root,\\n  )  \\n}, 300)\\n\")), mdx(\"h2\", {\n    \"id\": \"-patchcomponent\"\n  }, \"\\uD83D\\uDCA5 patchComponent\"), mdx(\"p\", null, \"\\u4E0B\\u9762\\u5B9E\\u73B0 Component \\u7684 patch\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/renderer.js\"\n  }), \"const processComponent = (n1, n2, container) => {\\n  if (n1 == null) {\\n    const instance = n2.instance = {\\n      props: reactive(n2.props), // initProps\\n      render: null,\\n      update: null,\\n      subTree: null,\\n      vnode: n2,\\n    }\\n    const render = instance.render = n2.type.setup(instance.props)\\n    instance.update = effect(() => { // component update \\u7684\\u5165\\u53E3\\uFF0Cn2 \\u662F\\u66F4\\u65B0\\u7684\\u6839\\u7EC4\\u4EF6\\u7684 newVNode\\n      const renderResult = render()\\n      n2.children = [renderResult]\\n      renderResult.parent = n2\\n      patch(instance.subTree, renderResult, container)\\n      instance.subTree = renderResult\\n    })\\n  } else {\\n    // update...\\n  }\\n}\\n\")), mdx(\"p\", null, \"\\u9996\\u5148\\u662F mount Component\\uFF0C\\u9700\\u8981\\u5728 VNode \\u4E0A\\u5EFA\\u7ACB\\u4E00\\u4E2A\\u7EC4\\u4EF6\\u5B9E\\u4F8B\\uFF0C\\u7528\\u6765\\u5B58\\u4E00\\u4E9B\\u7EC4\\u4EF6\\u7684\\u4E1C\\u897F\\uFF0Cprops \\u9700\\u8981 reactive \\u4E00\\u4E0B\\uFF0C\\u540E\\u9762\\u5199 update Component \\u7684\\u65F6\\u5019\\u5C31\\u77E5\\u9053\\u4E3A\\u4EC0\\u4E48\\u4E86\\uFF0C\\u7136\\u540E\\u83B7\\u53D6 setup \\u8FD4\\u56DE\\u7684 render \\u51FD\\u6570\\uFF0C\\u8FD9\\u91CC\\u975E\\u5E38\\u5DE7\\u5999\\u7684\\u5C31\\u662F\\u7EC4\\u4EF6\\u7684 update \\u65B9\\u6CD5\\u662F\\u4E00\\u4E2A effect \\u51FD\\u6570\\uFF0C\\u8FD9\\u6837\\u5BF9\\u5E94\\u4ED6\\u7684\\u72B6\\u6001\\u548C props \\u6539\\u53D8\\u65F6\\u5C31\\u53EF\\u4EE5\\u81EA\\u52A8\\u53BB\\u66F4\\u65B0\"), mdx(\"p\", null, \"\\u6211\\u4EEC\\u6765\\u770B\\u7EC4\\u4EF6\\u7684 update\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/renderer.js\",\n    \"metastring\": \"{10}\",\n    \"{10}\": true\n  }), \"const processComponent = (n1, n2, container) => {\\n  if (n1 == null) {\\n    // mount...\\n  } else {\\n    const instance = n2.instance = n1.instance\\n    instance.vnode = n2\\n    // updateProps, \\u6839\\u636E vnode.props \\u4FEE\\u6539 instance.props\\n    Object.keys(n2.props).forEach(key => {\\n      const newValue = n2.props[key]\\n      const oldValue = instance.props[key]\\n      if (newValue !== oldValue) {\\n        instance.props[key] = newValue\\n      }\\n    })\\n  }\\n}\\n\")), mdx(\"p\", null, \"\\u8FD9\\u91CC\\u7C7B\\u4F3C \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"const node = n2.node = n1.node\"), \" \\u83B7\\u53D6 instance\\uFF0C\\u7136\\u540E\\u53BB updateProps\\uFF0C\\u8FD9\\u91CC\\u5C31\\u4F53\\u73B0\\u4E86\\u4E4B\\u524D \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"reactive(props)\"), \" \\u7684\\u4F5C\\u7528\\u4E86\\uFF0Crender \\u51FD\\u6570\\u8C03\\u7528 JSX \\u5F97\\u5230\\u7684 props \\u6BCF\\u6B21\\u90FD\\u662F\\u65B0\\u7684\\uFF0C\\u8DDF\\u4E4B\\u524D\\u7684 instance.props \\u5E76\\u65E0\\u5173\\u8054\\uFF0C\\u8981\\u662F\\u60F3 props \\u6539\\u53D8\\u65F6\\u4E5F\\u80FD\\u4F7F\\u7EC4\\u4EF6\\u66F4\\u65B0\\uFF0C\\u5C31\\u9700\\u8981 JSX \\u7684 props \\u548C instance.props \\u54CD\\u5E94\\u5F0F\\u7684 props \\u8FDB\\u884C\\u5173\\u8054\\uFF0C\\u6240\\u4EE5\\u8FD9\\u91CC\\u901A\\u8FC7 updateProps \\u628A props \\u66F4\\u65B0\\u5230 instance.props \\u4E0A\"), mdx(\"p\", null, \"\\u6211\\u4EEC\\u518D\\u6765\\u770B updateProps\\uFF0C\\u53EA\\u6D89\\u53CA\\u5230\\u4E86 instance.props \\u7B2C\\u4E00\\u5C42\\u7684\\u66F4\\u65B0\\uFF0C\\u76F8\\u5F53\\u4E8E\\u662F\\u505A\\u4E86\\u5C42\\u6D45\\u6BD4\\u8F83\\uFF0C\\u5185\\u90E8\\u5B9E\\u73B0\\u4E86 React \\u7684 PureComponent\\uFF0C\\u963B\\u65AD\\u4E0E\\u66F4\\u65B0\\u65E0\\u5173\\u5B50\\u8282\\u70B9\\u7684\\u66F4\\u65B0\\uFF0C\\u540C\\u65F6\\u8FD9\\u91CC\\u4F7F\\u7528 shallowReactive \\u5373\\u53EF\\uFF0C\\u5F97\\u5230\\u66F4\\u597D\\u4E00\\u70B9\\u7684\\u6027\\u80FD\\uFF0C\\u4F46\\u662F\\u4E4B\\u524D\\u6211\\u4EEC\\u6CA1\\u6709\\u5B9E\\u73B0 shallowReactive\\uFF0C\\u8FD9\\u91CC\\u5C31\\u5148\\u7528 reactive \\u66FF\\u4EE3\"), mdx(\"p\", null, \"\\u4E0D\\u8981\\u5FD8\\u4E86\\u6211\\u4EEC\\u7684 unmount \\u8FD8\\u53EA\\u80FD unmount Element\\uFF0C\\u6211\\u4EEC\\u6765\\u5B8C\\u5584 Component \\u7684 unmount\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/renderer.js\"\n  }), \"const remove = (child) => {\\n  const parent = child.parentNode\\n  if (parent) parent.removeChild(child)\\n}\\n\\nconst unmount = (vnode, doRemove = true) => {\\n  const { type } = vnode\\n  if (isSetupComponent(type)) {\\n    vnode.children.forEach(c => unmount(c, doRemove))\\n  } else if (isString(type)) {\\n    vnode.children.forEach(c => unmount(c, false))\\n    if (doRemove) remove(vnode.node)\\n  } else if (isTextType(type)) {\\n    if (doRemove) remove(vnode.node)\\n  } else {\\n    type.unmount(/* ... */)\\n  }\\n}\\n\")), mdx(\"p\", null, \"\\u7C7B\\u4F3C\\u4E8E patch\\uFF0C\\u9488\\u5BF9\\u4E0D\\u540C type \\u8FDB\\u884C unmount\\uFF0C\\u7531\\u4E8E\\u7EC4\\u4EF6\\u7684 node \\u662F null\\uFF0C\\u5C31\\u76F4\\u63A5\\u5C06\\u5B50\\u8282\\u70B9\\u8FDB\\u884C unmount\"), mdx(\"p\", null, \"\\u6CE8\\u610F\\u8FD9\\u91CC\\u7684 doRemove \\u53C2\\u6570\\u7684\\u4F5C\\u7528\\uFF0CElement \\u7684\\u5B50\\u8282\\u70B9\\u53EF\\u4EE5\\u4E0D\\u76F4\\u63A5\\u4ECE DOM \\u4E0A\\u79FB\\u9664\\uFF0C\\u76F4\\u63A5\\u5C06\\u8BE5 Element \\u79FB\\u9664\\u5373\\u53EF\\uFF0C\\u4F46\\u662F Element \\u5B50\\u8282\\u70B9\\u4E2D\\u53EF\\u80FD\\u6709 Component\\uFF0C\\u6240\\u4EE5\\u8FD8\\u662F\\u9700\\u8981\\u9012\\u5F52\\u8C03\\u7528 unmount\\uFF0C\\u89E6\\u53D1 Component \\u7684\\u6E05\\u7406\\u526F\\u4F5C\\u7528\\uFF08\\u540E\\u9762\\u8BB2\\uFF09\\u548C\\u751F\\u547D\\u5468\\u671F\\uFF0C\\u89E3\\u51B3\\u65B9\\u6848\\u5C31\\u662F\\u52A0\\u4E00\\u4E2A doRemove \\u53C2\\u6570\\uFF0CElement unmount \\u65F6 doRemove \\u4E3A true\\uFF0C\\u4E4B\\u540E\\u5B50\\u8282\\u70B9\\u7684 doRemove \\u4E3A false\"), mdx(\"p\", null, \"\\u6700\\u540E\\u8FD8\\u6709\\u6E05\\u7406\\u526F\\u4F5C\\u7528\\uFF0C\\u751F\\u547D\\u5468\\u671F\\u5C31\\u4E0D\\u63D0\\u4E86\\uFF0CReact \\u5DF2\\u7ECF\\u8BC1\\u660E\\u751F\\u547D\\u5468\\u671F\\u662F\\u53EF\\u4EE5\\u4E0D\\u9700\\u8981\\u7684\\uFF0C\\u7EC4\\u4EF6\\u6DFB\\u52A0\\u7684 effect \\u5728\\u7EC4\\u4EF6 unmount \\u540E\\u4ECD\\u7136\\u5B58\\u5728\\uFF0C\\u8FD8\\u6CA1\\u6709\\u6E05\\u9664\\uFF0C\\u6240\\u4EE5\\u6211\\u4EEC\\u8FD8\\u9700\\u8981\\u5728 unmount \\u4E2D\\u62FF\\u5230\\u7EC4\\u4EF6\\u6240\\u6709\\u7684 effect\\uFF0C\\u7136\\u540E\\u4E00\\u4E00 stop\\uFF0C\\u8FD9\\u65F6 stop \\u5F88\\u7B80\\u5355\\uFF0C\\u4F46\\u5982\\u4F55\\u62FF\\u5230\\u7EC4\\u4EF6\\u7684 effect \\u5C31\\u6BD4\\u8F83\\u96BE\"), mdx(\"h2\", {\n    \"id\": \"-scheduler\"\n  }, \"\\uD83D\\uDCAB Scheduler\"), mdx(\"p\", null, \"\\u5176\\u5B9E Vue \\u4E2D\\u5E76\\u4E0D\\u4F1A\\u76F4\\u63A5\\u4F7F\\u7528 Vue Reactivity \\u4E2D\\u7684 API\\uFF0C\\u4ECE Vue \\u4E2D\\u5BFC\\u51FA\\u7684 computed\\u3001watch\\u3001watchEffect \\u4F1A\\u628A effect \\u6302\\u8F7D\\u5230\\u5F53\\u524D\\u7684\\u7EC4\\u4EF6\\u5B9E\\u4F8B\\u4E0A\\uFF0C\\u7528\\u4EE5\\u4E4B\\u540E\\u6E05\\u9664 effect\\uFF0C\\u6211\\u4EEC\\u53EA\\u5B9E\\u73B0 computed \\u548C\\u7B80\\u6613\\u7684 watchEffect\\uFF08\\u4E0D\\u8003\\u8651 flush \\u4E3A post \\u548C pre \\u7684\\u60C5\\u51B5\\uFF09\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"update \\u7684 effect \\u5728 Vue \\u4E2D\\u901A\\u8FC7 scheduler \\u5B9E\\u73B0\\u4E86\\u5F02\\u6B65\\u66F4\\u65B0\\uFF0CwatchEffect \\u7684\\u56DE\\u8C03\\u51FD\\u6570\\u6267\\u884C\\u65F6\\u673A flush \\u4E5F\\u662F\\u901A\\u8FC7 scheduler \\u5B9E\\u73B0\\uFF0C\\u7B80\\u5355\\u6765\\u8BF4\\u5C31\\u662F scheduler \\u521B\\u5EFA\\u4E86\\u4E09\\u4E2A\\u961F\\u5217\\uFF0C\\u5206\\u522B\\u5B58 pre Callbacks\\u3001sync Callbacks \\u548C post Callbacks\\uFF0C\\u8FD9\\u4E09\\u4E2A\\u961F\\u5217\\u4E2D\\u4EFB\\u52A1\\u7684\\u6267\\u884C\\u90FD\\u662F\\u901A\\u8FC7 promise.then \\u653E\\u5230\\u5FAE\\u4EFB\\u52A1\\u961F\\u5217\\u4E2D\\uFF0C\\u90FD\\u662F\\u5F02\\u6B65\\u6267\\u884C\\u7684\\uFF0C\\u7EC4\\u4EF6\\u7684 update \\u653E\\u5728 sync \\u961F\\u5217\\u4E2D\\uFF0Csync \\u6307\\u7684\\u662F\\u540C\\u6B65 DOM \\u66F4\\u65B0\\uFF08Vue \\u4E2D VNode \\u66F4\\u65B0\\u548C DOM \\u66F4\\u65B0\\u662F\\u540C\\u6B65\\u7684\\uFF09\\uFF0Cpre \\u6307\\u7684\\u662F\\u5728 DOM \\u66F4\\u65B0\\u4E4B\\u524D\\uFF0Cpost \\u6307\\u7684\\u662F\\u5728 DOM \\u66F4\\u65B0\\u4E4B\\u540E\\uFF0C\\u6240\\u4EE5 pre \\u5F97\\u4E0D\\u5230\\u66F4\\u65B0\\u540E\\u7684 DOM \\u4FE1\\u606F\\uFF0C\\u800C post \\u53EF\\u4EE5\\u5F97\\u5230\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/renderer.js\",\n    \"metastring\": \"{5,6}\",\n    \"{5,6}\": true\n  }), \"const unmount = (vnode, doRemove = true) => {\\n  const { type } = vnode\\n  if (isSetupComponent(type)) {\\n    const instance = { vnode }\\n    instance.effects.forEach(stop)\\n    stop(instance.update)\\n    vnode.children.forEach(c => unmount(c, doRemove))\\n  } // ...\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/component.js\"\n  }), \"let currentInstance\\nexport const getCurrentInstance = () => currentInstance\\nexport const setCurrentInstance = (instance) => currentInstance = instance\\n\\nexport const recordInstanceBoundEffect = (effect) => {\\n  if (currentInstance) currentInstance.effects.push(effect)\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=reactivity/renderer.js\",\n    \"metastring\": \"{7,9-11}\",\n    \"{7,9-11}\": true\n  }), \"const processComponent = (n1, n2, container) => {\\n  if (n1 == null) {\\n    const instance = n2.instance = {\\n      props: reactive(n2.props), // initProps\\n      render: null,\\n      update: null,\\n      subTree: null,\\n      vnode: n2,\\n      effects: [], // \\u7528\\u6765\\u5B58 setup \\u4E2D\\u8C03\\u7528 watchEffect \\u548C computed \\u7684 effect\\n    }\\n    setCurrentInstance(instance)\\n    const render = instance.render = n2.type.setup(instance.props)\\n    setCurrentInstance(null)\\n    // update effect...\\n  } else {\\n    // update...\\n  }\\n}\\n\")), mdx(\"p\", null, \"\\u7EC4\\u4EF6\\u7684 setup \\u53EA\\u4F1A\\u8C03\\u7528\\u4E00\\u6B21\\uFF0C\\u6240\\u4EE5\\u5728\\u8FD9\\u91CC\\u8C03\\u7528 setCurrentInstance \\u5373\\u53EF\\uFF0C\\u8FD9\\u662F\\u4E0E React.FC \\u7684\\u4E3B\\u8981\\u533A\\u522B\\u4E4B\\u4E00\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=reactivity/api-watch.js\",\n    \"metastring\": \"{6,11}\",\n    \"{6,11}\": true\n  }), \"import { effect, stop } from '../reactivity'\\nimport { recordInstanceBoundEffect, getCurrentInstance } from './component'\\n\\nexport const watchEffect = (cb, { onTrack, onTrigger } = {}) => {\\n  let cleanup\\n  const onInvalidate = (fn) => cleanup = e.options.onStop = fn\\n  const getter = () => {\\n    if (cleanup) {\\n      cleanup()\\n    }\\n    return cb(onInvalidate)\\n  }\\n\\n  const e = effect(getter, {\\n    onTrack,\\n    onTrigger,\\n    // \\u8FD9\\u91CC\\u6211\\u4EEC\\u5199\\u6210 lazy \\u4E3B\\u8981\\u662F\\u4E3A\\u4E86 onInvalidate \\u6B63\\u5E38\\u8FD0\\u884C\\n    // \\u4E0D lazy \\u7684\\u8BDD onInvalidate \\u4F1A\\u5728 e \\u5B9A\\u4E49\\u597D\\u4E4B\\u524D\\u8FD0\\u884C\\uFF0ConInvalidate \\u4E2D\\u6709\\u4F7F\\u7528\\u4E86 e\\uFF0C\\u5C31\\u4F1A\\u62A5\\u9519\\n    lazy: true,\\n  })\\n  e()\\n\\n  recordInstanceBoundEffect(e)\\n  const instance = getCurrentInstance()\\n\\n  return () => {\\n    stop(e)\\n    if (instance) {\\n      const { effects } = instance\\n      const i = effects.indexOf(e)\\n      if (i > -1) effects.splice(i, 1) // \\u6E05\\u9664 effect \\u65F6\\u4E5F\\u8981\\u628A instance \\u4E0A\\u7684\\u53BB\\u6389\\n    }\\n  }\\n}\\n\")), mdx(\"p\", null, \"watchEffect \\u7684\\u56DE\\u8C03\\u51FD\\u6570\\u8FD8\\u53EF\\u4EE5\\u4F20\\u5165\\u4E00\\u4E2A onInvalidate \\u65B9\\u6CD5\\u7528\\u4E8E\", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"\\u6CE8\\u518C\"), \"\\u5931\\u6548\\u65F6\\u7684\\u56DE\\u8C03\\uFF0C\\u6267\\u884C\\u65F6\\u673A\\u662F\\u526F\\u4F5C\\u7528\\u5373\\u5C06\\u91CD\\u65B0\\u6267\\u884C\\u65F6\\u548C\\u4FA6\\u542C\\u5668\\u88AB\\u505C\\u6B62\\uFF08\\u5982\\u679C\\u5728 setup() \\u4E2D\\u4F7F\\u7528\\u4E86 watchEffect, \\u5219\\u5728\\u5378\\u8F7D\\u7EC4\\u4EF6\\u65F6\\uFF09\\uFF0C\\u76F8\\u5F53\\u4E8E React.useEffect \\u8FD4\\u56DE\\u7684 cleanup \\u51FD\\u6570\\uFF0C\\u81F3\\u4E8E\\u4E3A\\u4EC0\\u4E48\\u4E0D\\u8BBE\\u8BA1\\u6210\\u4E0E React.useEffect \\u4E00\\u6837\\u8FD4\\u56DE cleanup\\uFF0C\\u662F\\u56E0\\u4E3A watchEffect \\u88AB\\u8BBE\\u8BA1\\u6210\\u652F\\u6301\\u53C2\\u6570\\u4F20\\u5165\\u5F02\\u6B65\\u51FD\\u6570\\u7684\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-jsx\",\n    \"metastring\": \"{22-25}\",\n    \"{22-25}\": true\n  }), \"const useLogger = () => {\\n  let id\\n  return {\\n    logger: (v, time = 2000) => new Promise(resolve => {\\n      id = setTimeout(() => {\\n        console.log(v)\\n        resolve()\\n      }, time)\\n    }),\\n    cancel: () => {\\n      clearTimeout(id)\\n      id = null\\n    },\\n  }\\n}\\n\\nconst App = {\\n  setup(props) {\\n    const count = ref(0)\\n    const { logger, cancel } = useLogger()\\n\\n    watchEffect(async (onInvalidate) => {\\n      onInvalidate(cancel) // \\u5F02\\u6B65\\u8C03\\u7528\\u4E4B\\u524D\\u5C31\\u6CE8\\u518C\\u5931\\u6548\\u65F6\\u7684\\u56DE\\u8C03\\n      await logger(count.value)\\n    })\\n\\n    return () => <button onClick={() => count.value++}>log</button>\\n  }\\n}\\n\")), mdx(\"p\", null, \"\\u7EE7\\u7EED\\u770B computed \\u600E\\u4E48\\u7ED1\\u5B9A effect\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=reactivity/api-computed.js\"\n  }), \"import { stop, computed as _computed } from '../reactivity'\\nimport { recordInstanceBoundEffect } from './component'\\n\\nexport const computed = (options) => {\\n  const computedRef = _computed(options)\\n  recordInstanceBoundEffect(computedRef.effect) // computed \\u5185\\u90E8\\u5B9E\\u73B0\\u4E5F\\u7528\\u5230\\u4E86 effect \\u54E6\\n  return computedRef\\n}\\n\")), mdx(\"p\", null, \"\\u5C31\\u662F\\u901A\\u8FC7\\u5728 setup \\u8C03\\u7528\\u65F6\\u8BBE\\u7F6E currentInstance\\uFF0C\\u7136\\u540E\\u628A setup \\u4E2D\\u7684 effect \\u653E\\u5230 currentInstance.effects \\u4E0A\\uFF0C\\u6700\\u540E unmount \\u65F6\\u4E00\\u4E00 stop\"), mdx(\"p\", null, \"\\u6700\\u540E\\u6211\\u4EEC\\u518D\\u5B9E\\u73B0\\u7EC4\\u4EF6\\u548C watchEffect \\u7684\\u5F02\\u6B65\\u8C03\\u7528\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=reactivity/scheduler.js\"\n  }), \"const resolvedPromise = Promise.resolve()\\nconst queue = [] // \\u76F8\\u5BF9\\u4E8E DOM \\u66F4\\u65B0\\u662F\\u540C\\u6B65\\u7684\\n\\nexport const queueJob = (job) => {\\n  queue.push(job)\\n  resolvedPromise.then(() => { // syncQueue \\u4E2D\\u7684 callbacks \\u8FD8\\u662F\\u4F1A\\u52A0\\u5165\\u5230\\u5FAE\\u4EFB\\u52A1\\u4E2D\\u6267\\u884C\\n    const deduped = [...new Set(queue)]\\n    queue.length = 0\\n    deduped.forEach(job => job())\\n  })\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=reactivity/renderer.js\",\n    \"metastring\": \"{6}\",\n    \"{6}\": true\n  }), \"const processComponent = (n1, n2, container) => {\\n  // createInstance, setup...\\n    instance.update = effect(() => {\\n      // patch...\\n    }, { scheduler: queueJob }) // \\u6CA1\\u6709 lazy\\uFF0Cmount \\u65F6\\u6CA1\\u5FC5\\u8981\\u901A\\u8FC7\\u5F02\\u6B65\\u8C03\\u7528\\n  // ...\\n}\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=reactivity/api-watch.js\",\n    \"metastring\": \"{3,6}\",\n    \"{3,6}\": true\n  }), \"import { queueJob } from './scheduler'\\n\\nconst afterPaint = requestAnimationFrame\\nexport const watchEffect = (cb, { onTrack, onTrigger } = {}) => {\\n  // onInvalidate...\\n  const scheduler = (job) => queueJob(() => afterPaint(job))\\n  const e = effect(getter, {\\n    lazy: true,\\n    onTrack,\\n    onTrigger,\\n    scheduler,\\n  })\\n  scheduler(e) // init run, run by scheduler (effect \\u7684 lazy \\u4E3A false \\u65F6\\uFF0C\\u5373\\u4F7F\\u6709 scheduler \\u5B83\\u7684 init run \\u4E5F\\u4E0D\\u4F1A\\u901A\\u8FC7 schduler \\u8FD0\\u884C)\\n  // bind effect on instance, return cleanup...\\n}\\n\")), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"\\u8FD9\\u91CC watchEffect \\u8FDB\\u5165\\u5FAE\\u4EFB\\u52A1\\u4E2D\\u53C8\\u52A0\\u5230 afterPaint \\u662F\\u6A21\\u4EFF\\u4E86 React.useEffect \\u7684\\u8C03\\u7528\\u65F6\\u673A\\uFF0C\\u6E90\\u7801\\u4E2D\\u5E76\\u4E0D\\u662F\\u8FD9\\u6837\\u7684\\uFF0C\\u6E90\\u7801\\u4E2D\\u5B9E\\u73B0\\u4E86 \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"flush: 'pre' | 'sync' | 'post'\"), \" \\u8FD9\\u4E09\\u79CD\\u6A21\\u5F0F\\uFF0C\\u6211\\u4EEC\\u8FD9\\u91CC\\u4E3A\\u4E86\\u7B80\\u5355\\u505A\\u4E86\\u4E00\\u4E9B\\u4FEE\\u6539\")), mdx(\"p\", null, \"\\u5176\\u5B9E\\u5C31\\u662F\\u521B\\u5EFA\\u4E00\\u4E2A\\u961F\\u5217\\uFF0C\\u7136\\u540E\\u628A\\u66F4\\u65B0\\u548C watchEffect \\u7684\\u56DE\\u8C03\\u51FD\\u6570\\u653E\\u5230\\u961F\\u5217\\u4E2D\\uFF0C\\u4E4B\\u540E\\u961F\\u5217\\u4E2D\\u7684\\u51FD\\u6570\\u4F1A\\u901A\\u8FC7 promise.then \\u653E\\u5230\\u5FAE\\u4EFB\\u52A1\\u961F\\u5217\\u4E2D\\u53BB\\u6267\\u884C\\uFF0C\\u5B9E\\u73B0\\u5F02\\u6B65\\u66F4\\u65B0\"), mdx(\"p\", null, \"\\u73B0\\u5728\\u7EC8\\u4E8E\\u5B8C\\u6210\\u4E86\\uFF01\\u5199\\u4E00\\u4E2A demo \\u770B\\u770B\\u6548\\u679C\\uFF5E\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-jsx\"\n  }), \"/** @jsx h */\\nimport { ref } from '../../packages/reactivity'\\nimport { h, createRenderer, watchEffect } from '../../packages/runtime-core'\\n\\nconst Displayer = {\\n  setup(props) {\\n    return () => (\\n      <div>{props.children}</div>\\n    )\\n  }\\n}\\n\\nconst App = {\\n  setup(props) {\\n    const count = ref(0)\\n    const inc = () => count.value++\\n\\n    watchEffect(() => console.log(count.value))\\n\\n    return () => (\\n      <div>\\n        <button onClick={inc}> + </button>\\n        {count.value % 2 ? <Displayer>{count.value}</Displayer> : null}\\n      </div>\\n    )\\n  }\\n}\\n\\ncreateRenderer().render(<App />, document.querySelector('#root'))\\n\")), mdx(\"h2\", {\n    \"id\": \"️-key-diff\"\n  }, \"\\u26A1\\uFE0F key diff\"), mdx(\"p\", null, \"\\u8FD9\\u91CC\\u6211\\u4EEC\\u53EA\\u7ED9\\u51FA\\u7B80\\u5355\\u7248\\u7684\\u5B9E\\u73B0\\uFF08React \\u4F7F\\u7528\\u7684 key diff\\uFF0C\\u76F8\\u6BD4 Vue \\u4F7F\\u7528\\u7684\\u5C11\\u4E86\\u4E9B\\u4F18\\u5316\\uFF0C\\u4F46\\u662F\\u7B80\\u5355\\u6613\\u61C2\\uFF09\\uFF0C\\u5177\\u4F53\\u8BB2\\u89E3\\u53EF\\u4EE5\\u770B\\u8FD9\\u7BC7\", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"http://hcysun.me/vue-design/zh/renderer-diff.html\"\n  }), \"\\u6E32\\u67D3\\u5668\\u7684\\u6838\\u5FC3 Diff \\u7B97\\u6CD5\"), \"\\uFF0C\\u662F\\u4E00\\u4F4D Vue Team Member \\u5199\\u7684\\uFF0C\\u5E94\\u8BE5\\u6CA1\\u6709\\u6587\\u7AE0\\u8BB2\\u7684\\u6BD4\\u8FD9\\u7BC7\\u66F4\\u6E05\\u6670\\u6613\\u61C2\\u4E86\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/renderer.js\",\n    \"metastring\": \"{7,15,21,25-32,36-42}\",\n    \"{7,15,21,25-32,36-42}\": true\n  }), \"const patchChildren = (n1, n2, container) => {\\n  const oldChildren = n1.children\\n  let newChildren = n2.props.children\\n  newChildren = isArray(newChildren) ? newChildren : [newChildren]\\n  n2.children = []\\n\\n  let lastIndex = 0 // \\u5B58\\u4E0A\\u4E00\\u6B21 j \\u7684\\u503C\\n  for (let i = 0; i < newChildren.length; i++) {\\n    if (newChildren[i] == null) continue\\n    let newChild = newChildren[i]\\n    newChild = isText(newChild) ? h(TextType, { nodeValue: newChild }) : newChild\\n    n2.children[i] = newChild\\n    newChild.parent = n2\\n\\n    let find = false\\n    for (let j = 0; j < oldChildren.length; j++) {\\n      if (oldChildren[j] == null) continue\\n      if (isSameVNodeType(oldChildren[j], newChild)) { // update\\n        const oldChild = oldChildren[j]\\n        oldChildren[j] = null\\n        find = true\\n\\n        patch(oldChild, newChild, container)\\n\\n        if (j < lastIndex) { // j \\u5728\\u4E0A\\u4E00\\u6B21 j \\u4E4B\\u524D\\uFF0C\\u9700\\u8981\\u79FB\\u52A8\\n          // 1. \\u76EE\\u524D\\u7EC4\\u4EF6\\u7684 VNode.node \\u4E3A null\\uFF0C\\u540E\\u9762\\u6211\\u4EEC\\u4F1A fix\\n          // 2. newChildren[i - 1] \\u56E0\\u4E3A\\u5728\\u4E0A\\u4E00\\u8F6E\\u5DF2\\u7ECF patch \\u8FC7\\u4E86\\uFF0C\\u6240\\u4EE5 node \\u4E0D\\u4E3A null\\n          const refNode = getNextSibling(newChildren[i - 1])\\n          move(oldChild, container, refNode)\\n        } else { // no need to move\\n          lastIndex = j\\n        }\\n        break\\n      }\\n    }\\n    // mount\\n    if (!find) {\\n      const refNode = i - 1 < 0\\n        ? getNode(oldChildren[0])\\n        : getNextSibling(newChildren[i - 1])\\n      patch(null, newChild, container, refNode)\\n    }\\n  }\\n\\n  for (let oldChild of oldChildren) {\\n    if (oldChild != null) unmount(oldChild)\\n  }\\n}\\n\")), mdx(\"p\", null, \"\\u4E4B\\u524D\\u662F\\u4E0D\\u6D89\\u53CA\\u8282\\u70B9\\u79FB\\u52A8\\u7684\\uFF0C\\u4E0D\\u7BA1\\u6709\\u6CA1\\u6709\\u8282\\u70B9\\u4E00\\u5F8B appendChild\\uFF0C\\u73B0\\u5728\\u9700\\u8981\\u52A0\\u4E0A\\u8282\\u70B9\\u79FB\\u52A8\\u7684\\u60C5\\u51B5\\uFF0C\\u5C31\\u9700\\u8981\\u5904\\u7406\\u6CA1\\u6709\\u8282\\u70B9\\u65F6\\u65B0\\u6DFB\\u52A0\\u8282\\u70B9\\u7684 mount\\uFF0C\\u5BF9\\u4E8E\\u79FB\\u52A8\\u7684\\u8282\\u70B9\\u9700\\u8981\\u627E\\u5230\\u8981\\u79FB\\u52A8\\u5230\\u7684\\u4F4D\\u7F6E\\uFF08refNode \\u524D\\u9762\\uFF09\"), mdx(\"p\", null, \"\\u73B0\\u5728 mount \\u65B0\\u8282\\u70B9\\u65F6\\u8FDB\\u884C\\u63D2\\u5165\\u9700\\u8981\\u5411 patch \\u4F20\\u5165 refNode\\uFF0C\\u9700\\u8981\\u76F8\\u5E94\\u7684\\u66F4\\u6539\\u4E4B\\u524D\\u7684 patch\\uFF0C\\u540C\\u65F6\\u53D6 refNode \\u548C move \\u65F6\\u4F1A\\u6839\\u636E type \\u4E0D\\u540C\\u64CD\\u4F5C\\u4E5F\\u4E0D\\u540C\\uFF0C\\u6211\\u4EEC\\u8FD9\\u91CC\\u5C06\\u8FD9\\u51E0\\u4E2A\\u64CD\\u4F5C\\u8FDB\\u884C\\u5C01\\u88C5\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"\\u73B0\\u5728\\u6839\\u636E type \\u4E0D\\u540C\\u5C01\\u88C5\\u51FA\\u7684\\u64CD\\u4F5C\\u6709\\u8FD9\\u4E9B\\uFF0Cpatch \\u7528\\u6765\\u8FDB\\u5165 VNode \\u66F4\\u65B0\\uFF0CgetNode \\u7528\\u4E8E\\u63D2\\u5165\\u65B0 VNode \\u65F6\\u53D6 oldChildren\", \"[0]\", \" \\u7684 node\\uFF0CgetNextSibling \\u7528\\u4E8E\\u53D6\\u79FB\\u52A8 VNode \\u65F6\\u53D6 nextSibling\\uFF0Cmove \\u7528\\u6765\\u79FB\\u52A8\\u8282\\u70B9\\uFF0Cunmount \\u7528\\u6765\\u79FB\\u9664 VNode\\uFF0C\\u8FD9\\u4E9B\\u64CD\\u4F5C\\u90FD\\u662F\\u5728\\u8BE5 diff \\u7B97\\u6CD5\\u4E0B\\u4F1A\\u6839\\u636E type \\u4E0D\\u540C\\u6709\\u4E0D\\u540C\\u64CD\\u4F5C\\u7684\\u4E00\\u4E2A\\u5C01\\u88C5\\uFF0C\\u6B64\\u5916\\u518D\\u7B97\\u4E0A mountChildren\\u3001patchChildren \\u548C renderOptions\\uFF0C\\u4F5C\\u4E3A internals \\u4F20\\u5165 type \\u7684\\u8FD9\\u4E94\\u4E2A\\u65B9\\u6CD5\\u4E2D\\uFF08\\u5269\\u4F59\\u7684\\u65B9\\u6CD5\\u53EF\\u4EE5\\u901A\\u8FC7\\u4EE5\\u4E0A\\u65B9\\u6CD5\\u8C03\\u7528\\u5230\\uFF0C\\u6240\\u4EE5\\u4E0D\\u7528\\u66B4\\u9732\\u51FA\\u53BB\\uFF09\\uFF0C\\u7528\\u4E8E\\u6DF1\\u5EA6\\u5B9A\\u5236\\u7EC4\\u4EF6\\uFF0C\\u4E0B\\u4E00\\u7BC7\\u4F1A\\u8BE6\\u7EC6\\u8BB2 Vue3 Compat\\uFF0C\\u8868\\u793A Vue3 \\u4E2D\\u5468\\u8FB9\\u7EC4\\u4EF6\\u548C\\u4E00\\u4E9B\\u5176\\u4ED6\\u65B0\\u7279\\u6027\\u7684\\u5B9E\\u73B0\\u539F\\u7406\\uFF0C\\u4F5C\\u4E3A\\u672C\\u7BC7\\u7684\\u8865\\u5145\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/renderer.js\",\n    \"metastring\": \"{1,22-23,28,36,45}\",\n    \"{1,22-23,28,36,45}\": true\n  }), \"const patch = (n1, n2, container, anchor = null) => { // insertBefore(node, null) \\u5C31\\u76F8\\u5F53\\u4E8E appendChild(node)\\n  // unmount...\\n\\n  const { type } = n2\\n  if (isSetupComponent(type)) {\\n    processComponent(n1, n2, container, anchor)\\n  } else if (isString(type)) {\\n    processElement(n1, n2, container, anchor)\\n  } else if (isTextType(type)) {\\n    processText(n1, n2, container, anchor)\\n  } else {\\n    type.patch(/* ... */)\\n  }\\n}\\n\\nconst getNode = (vnode) => { // patchChildren \\u5728\\u63D2\\u5165\\u65B0 VNode \\u65F6\\u8C03\\u7528 getNode(oldChildren[0])\\n  if (!vnode) return null // oldChildren[0] \\u4E3A null \\u662F\\u8FD4\\u56DE null \\u76F8\\u5F53\\u4E8E appendChild\\n  const { type } = vnode\\n  if (isSetupComponent(type)) return getNode(vnode.instance.subTree)\\n  if (isString(type) || isTextType(type)) return vnode.node\\n  return type.getNode(internals, { vnode })\\n}\\n\\nconst getNextSibling = (vnode) => { // patchChildren \\u5728\\u8FDB\\u884C\\u79FB\\u52A8 VNode \\u524D\\u83B7\\u5F97 refNode \\u8C03\\u7528\\n  const { type } = vnode\\n  if (isSetupComponent(type)) return getNextSibling(vnode.instance.subTree)\\n  if (isString(type) || isTextType(type)) return hostNextSibling(vnode.node)\\n  return type.getNextSibling(internals, { vnode })\\n}\\n\\nconst move = (vnode, container, anchor) => { // patchChildren \\u4E2D\\u7528\\u4E8E\\u79FB\\u52A8 VNode\\n  const { type } = vnode\\n  if (isSetupComponent(type)) {\\n    move(vnode.instance.subTree, container, anchor)\\n  } else if (isString(type) || isTextType(type)) {\\n    hostInsert(vnode.node, container, anchor)\\n  } else {\\n    type.move(internals, { vnode, container, anchor })\\n  }\\n}\\n\\nconst processComponent = (n1, n2, container, anchor) => {\\n  if (n1 == null) {\\n    // ...\\n      patch(instance.subTree, renderResult, container, anchor)\\n    // ...\\n  } else {\\n    // ...\\n  }\\n}\\n\\nconst processElement = (n1, n2, container, anchor) => {\\n  if (n1 == null) {\\n    // ...\\n    container.insertBefore(node, anchor)\\n  } else {\\n    // ...\\n  }\\n}\\n\\nconst processText = (n1, n2, container, anchor) => {\\n  if (n1 == null) {\\n    // ...\\n    container.insertBefore(node, anchor)\\n  } else {\\n    // ...\\n  }\\n}\\n\\nconst mountChildren = (vnode, container, isSVG, anchor) => {\\n  // ...\\n  for (/* ... */) {\\n    // ...\\n    patch(null, child, container, isSVG, anchor)\\n  }\\n}\\n\")), mdx(\"h2\", {\n    \"id\": \"-renderer\"\n  }, \"\\uD83C\\uDFA8 Renderer\"), mdx(\"p\", null, \"\\u73B0\\u5728\\u6211\\u4EEC\\u7684 runtime \\u57FA\\u672C\\u5B8C\\u6210\\u4E86\\uFF0C\\u4E4B\\u524D\\u4E3A\\u4E86\\u5199\\u8D77\\u6765\\u65B9\\u4FBF\\u5E76\\u6CA1\\u6709\\u62BD\\u79BB\\u51FA\\u6765\\u5E73\\u53F0\\u64CD\\u4F5C\\uFF0C\\u73B0\\u5728\\u6211\\u4EEC\\u62BD\\u79BB\\u51FA\\u6765\\uFF0C\\u7136\\u540E\\u628A\\u539F\\u6765\\u7684\\u4ECE\\u4F20\\u5165\\u7684 renderOptions \\u5F15\\u5165\\u5373\\u53EF\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-dom/index.js\"\n  }), \"import { createRenderer, h } from '../runtime-core'\\n\\nconst nodeOps = {\\n  querySelector: (sel) => document.querySelector(sel),\\n\\n  insert: (child, parent, anchor) => {\\n    parent.insertBefore(child, anchor ?? null)\\n  },\\n\\n  remove: child => {\\n    const parent = child.parentNode\\n    if (parent) {\\n      parent.removeChild(child)\\n    }\\n  },\\n\\n  createElement: (tag) => document.createElement(tag),\\n\\n  createText: text => document.createTextNode(text),\\n\\n  nextSibling: node => node.nextSibling,\\n\\n  setProperty: (node, propName, newValue, oldValue) => {\\n    if (propName[0] === 'o' && propName[1] === 'n') {\\n      const eventType = propName.toLowerCase().slice(2);\\n  \\n      if (!node.listeners) node.listeners = {};\\n      node.listeners[eventType] = newValue;\\n  \\n      if (newValue) {\\n        if (!oldValue) {\\n          node.addEventListener(eventType, eventProxy);\\n        }\\n      } else {\\n        node.removeEventListener(eventType, eventProxy);\\n      }\\n    } else if (newValue !== oldValue) {\\n      if (propName in node) {\\n        node[propName] = newValue == null ? '' : newValue\\n      } else if (newValue == null || newValue === false) {\\n        node.removeAttribute(propName)\\n      } else {\\n        node.setAttribute(propName, newValue)\\n      }\\n    }\\n  },\\n}\\n\\nfunction eventProxy(e) {\\n  // this: node\\n  this.listeners[e.type](e)\\n}\\n\\nexport const createApp = (rootComponent) => ({\\n  mount: (rootSel) =>\\n    createRenderer(nodeOps).render(h(rootComponent), nodeOps.querySelector(rootSel))\\n})\\n\")), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js:title=runtime-core/renderer.js\"\n  }), \"export function createRenderer(renderOptions) {\\n  const {\\n    createText: hostCreateText,\\n    createElement: hostCreateElement,\\n    insert: hostInsert,\\n    nextSibling: hostNextSibling,\\n    setProperty: hostSetProperty,\\n    remove: hostRemove,\\n  } = renderOptions\\n  // ...\\n}\\n\")), mdx(\"h2\", {\n    \"id\": \"-ramble\"\n  }, \"\\uD83D\\uDE03 ramble\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u4E4B\\u524D Vue2 \\u7684\\u65F6\\u5019\\u4E00\\u76F4\\u5BF9 Vue \\u4E0D\\u592A\\u611F\\u5174\\u8DA3\\uFF0C\\u89C9\\u5F97\\u6CA1 React \\u7CBE\\u7B80\\u597D\\u7528\\uFF0C\\u800C\\u4E14\\u90A3\\u65F6\\u5019 React \\u5DF2\\u7ECF\\u6709 Hooks \\u4E86\\uFF0C\\u540E\\u6765 Vue Reactivity \\u548C Composition API \\u51FA\\u73B0\\u540E\\uFF0C\\u540C\\u65F6\\u8D8A\\u53D1\\u89C9\\u5F97 Hooks \\u6709\\u5F88\\u91CD\\u7684\\u5FC3\\u667A\\u8D1F\\u62C5\\uFF0C\\u624D\\u9010\\u6E10\\u60F3\\u53BB\\u6DF1\\u5165\\u4E86\\u89E3 Vue\\uFF0C\\u4ECE\\u4E4B\\u524D\\u5199 Reactivity \\u89E3\\u6790\\u5230\\u73B0\\u5728\\u5199 runtime\\uFF0C\\u53D1\\u73B0 Vue3 \\u7684\\u5FC3\\u667A\\u8D1F\\u62C5\\u5E76\\u6CA1\\u6709\\u60F3\\u8C61\\u4E2D\\u7684\\u90A3\\u4E48\\u5C11\\uFF0C\\u4F46\\u8FD8\\u662F\\u62B5\\u6321\\u4E0D\\u4F4F\\u5B83\\u7684\\u7B80\\u5355\\u597D\\u7528\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u5BF9 Vue \\u7684\\u8D8A\\u6765\\u8D8A\\u6DF1\\u5165\\u4E5F\\u8BA9\\u6211\\u8D8A\\u53D1\\u89C9\\u5F97 Vue \\u548C React \\u5F88\\u591A\\u5730\\u65B9\\u662F\\u4E00\\u6837\\u7684\\uFF0C\\u4E5F\\u53D1\\u73B0\\u4E86\\u5B83\\u4EEC\\u6838\\u5FC3\\u90E8\\u5206\\u7684\\u4E0D\\u540C\\uFF0CVue \\u5C31\\u662F Proxy \\u5B9E\\u73B0\\u7684\\u54CD\\u5E94\\u5F0F + VDOM runtime + \\u6A21\\u7248 complier\\uFF0CReact \\u56E0\\u4E3A\\u662F\\u4E00\\u904D\\u4E00\\u904D\\u7684\\u5237\\u65B0\\uFF0C\\u6240\\u4EE5\\u662F\\u504F\\u5411\\u51FD\\u6570\\u5F0F\\u7684 Hooks + VDOM runtime (Fiber) + Scheduler\\uFF0C\\u6240\\u4EE5\\u603B\\u7ED3\\u6765\\u8BF4\\u4E00\\u4E2A\\u524D\\u7AEF\\u6846\\u67B6\\u7684\\u6838\\u5FC3\\u5C31\\u662F\\u6570\\u636E\\u5C42\\uFF08reactivity\\u3001hooks\\u3001ng service\\uFF09\\u548C\\u89C6\\u56FE\\u8FDE\\u63A5\\u5C42\\uFF08VDOM\\u3001complier\\uFF09\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"\\u6CA1\\u6709\\u5904\\u7406 svg\\uFF0C\\u4F46\\u662F\\u4E5F\\u5F88\\u7B80\\u5355\\uFF0C\\u8FD9\\u7BC7\\u5199\\u7684\\u65F6\\u5019\\u6539\\u4E86\\u5F88\\u591A\\u6B21\\uFF0C\\u611F\\u89C9\\u5DF2\\u7ECF\\u5199\\u7684\\u5F88\\u590D\\u6742\\u4E86\\uFF0C\\u6240\\u4EE5\\u5728\\u6709\\u7684\\u5730\\u65B9\\u505A\\u4E86\\u7B80\\u5316\\uFF0C\\u66F4\\u5B8C\\u6574\\u7684\\u53EF\\u4EE5\\u770B\\u8FD9\\u4E2A\\u4ED3\\u5E93\"))), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/ahabhgk/simple-vue3/tree/master/packages/runtime-core\"\n  }), \"simple-vue/runtime-core \\u5B9E\\u73B0\\u5B8C\\u6574\\u4EE3\\u7801\"))));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"Table of Contents 序 我们会一起写一个简易的 runtime，对于 Vue 如何运行的有一个大致的了解，当然我们实现的会和源码本身有一些不同，会简化很多，主要学习思想 本篇文章并不是为了深入 Vue3 源码，而是对 Vue3 核心 VDOM…","timeToRead":3,"banner":null}},"pageContext":{"slug":"/blog/let-us-build-a-vue3-runtime","formatString":"DD.MM.YYYY"}},"staticQueryHashes":["318001574","3787687951","3787687951"]}